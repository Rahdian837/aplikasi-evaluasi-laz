<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Evaluasi Kinerja - LAZ Albahjah Peduli</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Font Roboto (sesuai permintaan) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Memuat Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Memuat Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat html2pdf.js untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Menggunakan font Roboto sebagai default */
        body {
            font-family: 'Roboto', sans-serif;
        }
        /* Custom scrollbar (opsional) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Utama Aplikasi -->
    <div class="flex h-screen bg-gray-100">

        <!-- Sidebar (Navigasi Departemen) -->
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col fixed h-full z-10">
            <h1 class="text-2xl font-bold text-blue-700 mb-8">
                LAZ Albahjah Peduli
            </h1>
            
            <nav class="flex flex-col space-y-2">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Kuantitatif</span>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="crm" class="sidebar-link group">
                    <!-- Icon SVG Sederhana -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>CRM</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="iklan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.144-6.126A1.76 1.76 0 015.56 12.021l6.126-2.144a1.76 1.76 0 01.592-3.417z"></path></svg>
                    <span>Iklan</span>
                </a>
                 <a href="#kuantitatif" data-page="kuantitatif" data-subpage="echannel" class="sidebar-link group">
                    <!-- Ikon 'cash' -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-channel</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="kemitraan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>Kemitraan</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="platform" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Platform</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="emoney" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    <span>E-money</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="ecommerce" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-commerce</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="abstore" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    <span>AB Store</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="offline" class="sidebar-link group">
                    <!-- Icon untuk Offline Fundrising (briefcase) -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Offline Fundrising</span>
                </a>
                
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-2">Kualitatif</span>
                <a href="#kualitatif" data-page="kualitatif" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1m6 0l-1 1m-6-5l-1-1M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Media & Grafis</span>
                </a>
            </nav>

        </aside>

        <!-- Area Konten Utama -->
        <main class="flex-1 flex flex-col ml-64">
            
            <!-- Navigasi Atas -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <nav class="flex items-center space-x-4">
                    <a href="#beranda" data-page="beranda" class="top-nav-link active-nav">Beranda</a>
                    <a href="#kuantitatif" data-page="kuantitatif" class="top-nav-link">Evaluasi Kuantitatif</a>
                    <a href="#kualitatif" data-page="kualitatif" class="top-nav-link">Evaluasi Kualitatif</a>
                    <a href="#laporan" data-page="laporan" class="top-nav-link">Laporan & Analitik</a>
                    <a href="#pengaturan" data-page="pengaturan" class="top-nav-link">Pengaturan</a>
                </nav>
                <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium">
                    Keluar
                </button>
            </header>

            <!-- Konten Halaman Dinamis -->
            <div id="page-content" class="p-6 lg:p-8 flex-1 overflow-y-auto">
                <!-- Konten akan dimuat oleh JavaScript -->
            </div>

        </main>
    </div>

    <!-- Template Halaman (disembunyikan, digunakan oleh JS) -->
    <template id="template-beranda">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Beranda Dashboard</h2>
            <p class="text-gray-600 mb-8">Selamat datang. Berikut adalah ringkasan kinerja terbaru Anda.</p>

            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Ringkasan Kinerja</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Kartu Ringkasan 1 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kuantitatif (Total)</h4>
                    <p class="text-4xl font-bold text-blue-600 mb-4">85<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 2 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kualitatif (Media)</h4>
                    <p class="text-4xl font-bold text-green-600 mb-4">92<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 92%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 3 di Beranda - Diperbarui untuk Platform -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Platform Eksternal (SOG)</h4>
                    <p class="text-4xl font-bold text-yellow-500 mb-4">Rp 150.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 75%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Target: Rp 200.000</p>
                </div>

                <!-- Kartu Ringkasan 4 di Beranda - Diperbarui untuk Offline -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Offline (Rata-rata/Event)</h4>
                    <p class="text-4xl font-bold text-purple-600 mb-4">Rp 12.500.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-purple-600 h-2.5 rounded-full" style="width: 78%"></div>
                    </div>
                     <p class="text-sm text-gray-500 mt-2">Target: Rp 15.000.000</p>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kuantitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6" id="kuantitatif-title">Evaluasi Kuantitatif: CRM</h2>
            
            <!-- Memberi ID pada grid dan kolom -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="kuantitatif-grid">
                <!-- Kolom Kiri: KPI & Grafik -->
                <div class="lg:col-span-2 space-y-6" id="kuantitatif-main-col">
                    <!-- Kartu KPI -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Key Performance Indicators (KPI)</h4>
                        <div id="kpi-content" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- KPI data dimuat oleh JS -->
                        </div>
                    </div>
                    
                    <!-- Kartu Grafik Tren -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h4 class="text-xl font-semibold text-gray-700 mb-4">Grafik Tren (30 Hari Terakhir)</h4>
                         <div class="h-80">
                            <canvas id="trenChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Kolom Kanan: Rekomendasi AI -->
                <!-- Memberi ID pada kolom sidebar -->
                <div class="lg:col-span-1" id="kuantitatif-sidebar-col">
                    <div class="bg-white p-6 rounded-lg shadow-md sticky top-24">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Rekomendasi AI</h4>
                        <p class="text-gray-600 text-sm mb-4">
                            Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja terbaru.
                        </p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <!-- SVG Loading Spinner (disembunyikan) -->
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                            <!-- Hasil AI dimuat di sini -->
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kualitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Evaluasi Kualitatif: Media & Grafis</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Penilaian -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Metrik Evaluasi (Penilaian Tim)</h4>
                    <p class="text-gray-600 text-sm mb-6">Berikan penilaian Anda untuk konten visual terbaru.</p>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Desain Poster Donasi</label>
                        <!-- Sistem Bintang -->
                        <div class="flex items-center space-x-1 text-gray-400">
                            <svg data-rating="1" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="2" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="3" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="4" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="5" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Video Testimoni</label>
                        <!-- Sistem Jempol -->
                        <div class="flex items-center space-x-4">
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-green-100 text-gray-600 hover:text-green-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 19v-5a2 2 0 012-2h2V6a2 2 0 012-2c.621 0 1.17.253 1.564.672l2.066 2.066A2 2 0 0114 8v2z"></path></svg>
                            </button>
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-red-100 text-gray-600 hover:text-red-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.017c.163 0 .326.02.485.06L17 5v5a2 2 0 01-2 2h-2v6a2 2 0 01-2 2c-.621 0-1.17-.253-1.564-.672l-2.066-2.066A2 2 0 0110 16v-2z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4 mt-6">
                        <label for="qual-comment" class="block text-gray-700 font-medium">Komentar & Umpan Balik</label>
                        <textarea id="qual-comment" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Tuliskan umpan balik kualitatif Anda di sini..."></textarea>
                        <button id="submit-qual-feedback" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium">
                            Kirim Umpan Balik
                        </button>
                    </div>
                </div>

                <!-- Kartu Analisis AI -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Analisis Sentimen AI</h4>
                    <p class="text-gray-600 text-sm mb-4">
                        AI menganalisis semua umpan balik kualitatif untuk mengidentifikasi sentimen dan tema utama.
                    </p>
                    <div class="h-64 mb-6">
                        <canvas id="sentimenChart"></canvas>
                    </div>
                    <button id="get-ai-sentiment" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                        <svg id="ai-sentiment-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="ai-sentiment-button-text">Jalankan Analisis Sentimen</span>
                    </button>
                    <div id="ai-sentiment-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                        <p class="text-gray-500 text-center">Hasil analisis AI akan muncul di sini.</p>
                    </div>
                </div>
            </div>

            <!-- Bagian Evaluasi Desain Ahli -->
            <div id="template-evaluasi-desain" class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Evaluasi Desain Ahli (AI)</h3>
                <p class="text-gray-600 text-sm mb-6">
                    Dapatkan evaluasi mendalam dari AI yang berperan sebagai Direktur Kreatif ahli crowdfunding.
                    Masukkan deskripsi konten (atau link) dan metrik kinerjanya.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Input -->
                    <div class="space-y-4">
                        <div>
                            <label for="design-desc" class="block text-sm font-medium text-gray-700">Deskripsi Desain / Video / Link</label>
                            <textarea id="design-desc" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'Video testimoni penerima manfaat, fokus pada close-up emosional, backsound sedih, CTA di akhir oleh Buya Yahya...' atau Link ke Konten"></textarea>
                        </div>
                        
                        <!-- Fitur Upload Gambar -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Upload Gambar (Opsional)</label>
                            <input id="image-upload-input" type="file" accept="image/png, image/jpeg, image/webp" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                            "/>
                            <div id="image-preview-container" class="mt-2 hidden">
                                <span class="block text-sm font-medium text-gray-700 mb-1">Pratinjau:</span>
                                <img id="image-preview" src="" alt="Pratinjau Gambar" class="max-h-40 rounded-lg border shadow-sm"/>
                                <button id="remove-image-btn" class="mt-1 text-sm text-red-600 hover:underline">Hapus Gambar</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="design-views" class="block text-sm font-medium text-gray-700">Views / Jangkauan</label>
                                <input type="number" id="design-views" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000">
                            </div>
                            <div>
                                <label for="design-engagement" class="block text-sm font-medium text-gray-700">Engagement (Klik/Balas)</label>
                                <input type="number" id="design-engagement" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                            </div>
                            <div>
                                <label for="design-donations" class="block text-sm font-medium text-gray-700">Hasil Donasi (Rp)</label>
                                <input type="number" id="design-donations" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                            </div>
                        </div>
                         <button id="get-ai-design-eval" class="w-full bg-purple-600 text-white px-5 py-3 rounded-lg hover:bg-purple-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-design-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-design-button-text">Dapatkan Evaluasi Desain Ahli</span>
                        </button>
                    </div>
                    
                    <!-- Kolom Hasil -->
                    <div class="border-t md:border-t-0 md:border-l pl-0 md:pl-6 pt-6 md:pt-0">
                         <h4 class="text-lg font-semibold text-gray-700 mb-2">Hasil Evaluasi Ahli</h4>
                        <div id="ai-design-result" class="text-gray-700 space-y-3 text-sm min-h-[150px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI expert akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </template>
    
    <template id="template-laporan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Laporan & Analitik</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Perbandingan Kinerja -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Alat Perbandingan Kinerja</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 1</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 2</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Periode</option>
                            <option>30 Hari Terakhir</option>
                            <option>Kuartal Ini</option>
                            <option>Tahun Ini</option>
                        </select>
                    </div>
                    <button class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium">
                        Bandingkan
                    </button>
                    <!-- Area Grafik Perbandingan -->
                    <div class="mt-6 h-64 bg-gray-50 flex items-center justify-center rounded-lg">
                        <p class="text-gray-500">Grafik perbandingan akan muncul di sini</p>
                    </div>
                </div>
                
                <!-- Kartu Unduh Laporan -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Laporan yang Dapat Diunduh</h4>
                    <p class="text-gray-600 text-sm mb-6">Hasilkan laporan ringkasan untuk semua evaluasi.</p>
                    <div class="flex space-x-4">
                        <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh PDF
                        </button>
                        <button class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-pengaturan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan</h2>
            <!-- Konten diisi dengan form API Key -->
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Pengaturan API Gemini</h4>
                <p class="text-gray-600 mb-4 text-sm">
                    Masukkan Kunci API Gemini (AI Studio) Anda untuk mengaktifkan semua fitur evaluasi AI.
                    Kunci Anda disimpan dengan aman di penyimpanan lokal browser Anda (`localStorage`) dan tidak dikirim ke server lain.
                </p>
                
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Masukkan API Key Anda (dimulai dengan AIzaSy...)">
                </div>
                
                <div class="flex items-center space-x-4 mt-4">
                    <button id="save-api-key" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow font-medium">
                        Simpan Kunci
                    </button>
                    <button id="delete-api-key" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition-all font-medium">
                        Hapus Kunci
                    </button>
                    <span id="api-key-status" class="text-sm font-medium text-red-500">Kunci API Belum Diatur.</span>
                </div>
            </div>
        </div>
    </template>


    <script type="module">
        // --- KONFIGURASI APLIKASI ---
        const SUPABASE_URL = 'https://xoootcpffgaimzrcwenr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvb290Y3BmZmdhaW16cmN3ZW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Njk5MDUsImV4cCI6MjA3ODE0NTkwNX0.Vk2vz7sACTWAMizzvByEYIifCNqd8305wGTAA0AvPkY';
        
        // --- INISIALISASI SUPABASE ---
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized.');
            } else {
                console.error('Supabase client library not loaded.');
            }
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        // --- STATE APLIKASI ---
        let currentPage = 'beranda';
        let currentSubPage = 'crm';
        let trenChartInstance = null;
        let sentimenChartInstance = null;
        let uploadedImageBase64 = null; // Untuk menyimpan data gambar

        // --- ELEMEN DOM ---
        const pageContent = document.getElementById('page-content');
        const topNavLinks = document.querySelectorAll('.top-nav-link');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');

        // --- DATA MOCK (CONTOH) ---
        // Ganti ini dengan panggilan fetchSupabaseData()
        const mockData = {
            crm: {
                title: "CRM",
                kpis: [
                    { label: "Permintaan Baru", value: "152" },
                    { label: "Waktu Respons Rata-rata", value: "2.1 jam" },
                    { label: "Tingkat Penyelesaian", value: "89%" },
                    { label: "Kepuasan Pelanggan", value: "4.5/5" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [120, 135, 110, 152]
                }
            },
            iklan: {
                title: "Iklan",
                kpis: [
                    { label: "Tayangan", value: "1,200,000" },
                    { label: "CTR (Click-Through Rate)", value: "5.2%" },
                    { label: "CPA (Cost Per Acquisition)", value: "Rp 15.000" },
                    { label: "ROAS (Return on Ad Spend)", value: "3.5x" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [4.1, 4.8, 5.0, 5.2]
                }
            },
            echannel: {
                title: "E-channel (Perbankan)",
                kpis: [
                    { label: "Volume Donasi", value: "Rp 180.000.000" },
                    { label: "Jumlah Transaksi", value: "1.200" },
                    { label: "Rata-rata Donasi", value: "Rp 150.000" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [35, 45, 40, 60] // Juta Rp
                }
            },
            // Tambahkan departemen lain di sini (kemitraan, platform, dll.)
            kemitraan: { 
                title: "Kemitraan", 
                kpis: [
                    { label: "Proposal Masuk", value: "40" },
                    { label: "Deal Tercapai", value: "10" },
                    { label: "Nilai Kemitraan", value: "Rp 300Jt" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [5, 8, 12, 10] } 
            },
            platform: { 
                title: "Platform (Eksternal)", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 150Jt" },
                    { label: "Jumlah Donatur", value: "1000" },
                    { label: "SOG", value: "Rp 150.000" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [120, 135, 110, 150] } // Juta Rp
            },
            emoney: { 
                title: "E-money", 
                kpis: [
                    { label: "Volume Transaksi", value: "Rp 500Jt" },
                    { label: "Jumlah Transaksi", value: "5.000" },
                    { label: "Biaya (MDR)", value: "0.7%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [100, 120, 150, 130] } // Juta Rp
            },
            ecommerce: { 
                title: "E-commerce", 
                kpis: [
                    { label: "Penjualan", value: "Rp 80Jt" },
                    { label: "Jumlah Order", value: "800" },
                    { label: "Profit Margin", value: "15%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [15, 20, 25, 20] } // Juta Rp
            },
            abstore: { 
                title: "AB Store", 
                kpis: [
                    { label: "Penjualan Total", value: "Rp 120Jt" },
                    { label: "Produk Terlaris", value: "Madu" },
                    { label: "Stok Opname", value: "98% Akurat" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [25, 30, 35, 30] } // Juta Rp
            },
            offline: { 
                title: "Offline Fundrising", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 250Jt" },
                    { label: "Jumlah Mitra/Event", value: "20" },
                    { label: "Rata-rata Per Mitra", value: "Rp 12.5Jt" },
                ], 
                chart: { 
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], 
                    data: [50, 75, 60, 65] // (dalam jutaan Rp)
                } 
            },
        };
        
        const mockFeedback = [
            "Desain posternya sangat menyentuh dan jelas!",
            "Videonya bagus, tapi audionya sedikit pecah di awal.",
            "Saya suka palet warnanya, sangat menenangkan.",
            "Font di infografis terlalu kecil, sulit dibaca di HP.",
            "Luar biasa, sangat profesional!"
        ];

        // --- LOGIKA DATABASE (SUPABASE) ---
        
        /**
         * Mengambil data kuantitatif dari Supabase.
         * (Saat ini menggunakan mock data, hapus komentar untuk data live)
         * @param {string} department - Nama tabel/departemen
         */
        async function fetchQuantitativeData(department) {
            console.log(`Fetching data for: ${department}`);
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockData[department] || { title: department, kpis: [], chart: { labels: [], data: [] } };
            }
            
            // Mengembalikan mock data untuk demo
            return new Promise(resolve => 
                setTimeout(() => resolve(mockData[department]), 500)
            );
        }

        /**
         * Mengambil umpan balik kualitatif dari Supabase.
         */
        async function fetchQualitativeFeedback() {
            console.log('Fetching qualitative feedback...');
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockFeedback;
            }
            
            return new Promise(resolve =>
                setTimeout(() => resolve(mockFeedback), 500)
            );
        }
        
        /**
         * Menyimpan umpan balik kualitatif ke Supabase
         */
         async function submitQualitativeFeedback(comment, rating, type) {
            if (!supabase) {
                // Ganti alert dengan UI yang lebih baik
                showToast('Mode Demo: Umpan balik Anda telah dicatat di konsol.');
                console.warn('Supabase not active. Data not saved.', { comment, rating, type });
                return;
            }
            
            console.log('Submitting feedback:', { comment, rating, type });
            
            // ... (Kode Supabase insert)
            // const { data, error } = await supabase
            //   .from('evaluasi_kualitatif_media')
            //   .insert([
            //     { nama_konten: 'Poster A', komentar: comment, rating_bintang: rating, user_id: 'user-123' }
            //   ]);
            // if (error) console.error('Error submitting feedback:', error);
            // else showToast('Umpan balik berhasil dikirim!');
         }

        // --- FUNGSI KALKULASI BARU ---

        /**
         * Menghitung SOG (Spend of Giving)
         */
        function calculateSOG() {
            const perolehan = parseFloat(document.getElementById('crm-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('crm-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('crm-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung ROAS (Return on Ad Spend)
         */
        function calculateROAS() {
            const perolehan = parseFloat(document.getElementById('iklan-perolehan')?.value) || 0;
            const biaya = parseFloat(document.getElementById('iklan-biaya')?.value) || 0;
            const roasResultEl = document.getElementById('iklan-roas-result');
            
            if (roasResultEl) {
                if (biaya > 0) {
                    const roas = perolehan / biaya;
                    roasResultEl.textContent = `${roas.toFixed(2)}x`;
                } else {
                    roasResultEl.textContent = '0.00x';
                }
            }
        }

        /**
         * Menghitung Rata-rata Donasi (E-channel)
         */
        function calculateAvgDonation() {
            const volume = parseFloat(document.getElementById('echannel-volume')?.value) || 0;
            const transaksi = parseFloat(document.getElementById('echannel-transaksi')?.value) || 0;
            const resultEl = document.getElementById('echannel-avg-result');
            
            if (resultEl) {
                if (transaksi > 0) {
                    const rate = volume / transaksi;
                    resultEl.textContent = `Rp ${rate.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung SOG (Spend of Giving) untuk Platform Eksternal
         */
        function calculateSOG_Platform() {
            const perolehan = parseFloat(document.getElementById('platform-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('platform-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('platform-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Rata-rata Per Mitra (Offline Fundrising)
         */
        function calculateAvgPerMitra_Offline() {
            const perolehan = parseFloat(document.getElementById('offline-perolehan')?.value) || 0;
            const mitra = parseFloat(document.getElementById('offline-donatur')?.value) || 0;
            const resultEl = document.getElementById('offline-avg-result');
            
            if (resultEl) {
                if (mitra > 0) {
                    const avg = perolehan / mitra;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Closing Rate (Kemitraan)
         */
        function calculateClosingRate() {
            const deal = parseFloat(document.getElementById('kemitraan-deal')?.value) || 0;
            const proposal = parseFloat(document.getElementById('kemitraan-proposal')?.value) || 0;
            const resultEl = document.getElementById('kemitraan-rate-result');
            
            if (resultEl) {
                if (proposal > 0) {
                    const rate = (deal / proposal) * 100;
                    resultEl.textContent = `${rate.toFixed(2)}%`;
                } else {
                    resultEl.textContent = '0.00%';
                }
            }
        }

        /**
         * Menghitung Rata-rata Transaksi (E-money)
         */
        function calculateAvgTransaction() {
            const volume = parseFloat(document.getElementById('emoney-volume')?.value) || 0;
            const jumlah = parseFloat(document.getElementById('emoney-jumlah')?.value) || 0;
            const resultEl = document.getElementById('emoney-avg-result');
            
            if (resultEl) {
                if (jumlah > 0) {
                    const avg = volume / jumlah;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung Profit (E-commerce / AB Store)
         */
        function calculateProfit(prefix) { // prefix = 'ecommerce' or 'abstore'
            const penjualan = parseFloat(document.getElementById(`${prefix}-penjualan`)?.value) || 0;
            const biaya = parseFloat(document.getElementById(`${prefix}-biaya`)?.value) || 0;
            const resultEl = document.getElementById(`${prefix}-profit-result`);
            
            if (resultEl) {
                const profit = penjualan - biaya;
                resultEl.textContent = `Rp ${profit.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            }
        }

        // --- FUNGSI API KEY ---

        /**
         * Menyimpan API Key ke localStorage
         */
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key && key.length > 10) { // Validasi sederhana
                localStorage.setItem('geminiApiKey', key);
                document.getElementById('api-key-status').textContent = 'Kunci API Tersimpan!';
                document.getElementById('api-key-status').className = 'text-sm font-medium text-green-600';
                document.getElementById('api-key-input').value = ''; // Kosongkan demi keamanan
                showToast('Kunci API berhasil disimpan.');
            } else {
                showToast('Kunci API sepertinya tidak valid.', true);
            }
        }

        /**
         * Menghapus API Key dari localStorage
         */
        function deleteApiKey() {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('api-key-status').textContent = 'Kunci API Dihapus.';
            document.getElementById('api-key-status').className = 'text-sm font-medium text-red-600';
            document.getElementById('api-key-input').value = '';
            showToast('Kunci API telah dihapus.');
        }

        /**
         * Memuat status API Key saat halaman Pengaturan dibuka
         */
        function loadApiKeyStatus() {
            const key = localStorage.getItem('geminiApiKey');
            const statusEl = document.getElementById('api-key-status');
            if (key) {
                statusEl.textContent = 'Kunci API Tersimpan.';
                statusEl.className = 'text-sm font-medium text-green-600';
            } else {
                statusEl.textContent = 'Kunci API Belum Diatur.';
                statusEl.className = 'text-sm font-medium text-red-600';
            }
        }

        // --- (BARU) LOGIKA API WILAYAH INDONESIA ---
        const API_WILAYAH_BASE_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api';

        /**
         * (BARU) Fungsi helper untuk mengisi dropdown dari API
         */
        function populateDropdown(selectEl, data, defaultOptionText) {
            // Gunakan 'name' (dari emsifa API) atau 'nama' (fallback)
            const nameKey = (data.length > 0 && data[0].name) ? 'name' : 'nama';
            
            selectEl.innerHTML = `<option value="">${defaultOptionText}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[nameKey];
                selectEl.appendChild(option);
            });
            selectEl.disabled = false;
        }

        /**
         * (BARU) Memuat Provinsi
         */
        async function loadProvinsi() {
            const el = document.getElementById('offline-provinsi');
            if (!el) return;
            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/provinces.json`);
                if (!response.ok) throw new Error('Network response was not ok');
                const provinces = await response.json();
                populateDropdown(el, provinces, 'Pilih Provinsi');
            } catch (e) {
                console.error("Gagal memuat provinsi:", e);
                el.innerHTML = '<option value="">Gagal Memuat Provinsi</option>';
            }
        }

        /**
         * (BARU) Memuat Kabupaten
         */
        async function loadKabupaten(provinceId) {
            const el = document.getElementById('offline-kabupaten');
            const elKec = document.getElementById('offline-kecamatan');
            if (!el || !elKec) return;
            
            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;
            elKec.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
            elKec.disabled = true;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/regencies/${provinceId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const regencies = await response.json();
                populateDropdown(el, regencies, 'Pilih Kabupaten / Kota');
            } catch (e) {
                console.error("Gagal memuat kabupaten:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kabupaten</option>';
            }
        }

        /**
         * (BARU) Memuat Kecamatan
         */
        async function loadKecamatan(regencyId) {
            const el = document.getElementById('offline-kecamatan');
            if (!el) return;

            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/districts/${regencyId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const districts = await response.json();
                populateDropdown(el, districts, 'Pilih Kecamatan');
            } catch (e) {
                console.error("Gagal memuat kecamatan:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kecamatan</option>';
            }
        }


        // --- LOGIKA NAVIGASI ---
        
        /**
         * Navigasi ke halaman yang dipilih.
         * @param {string} page - Nama halaman (beranda, kuantitatif, dll.)
         * @param {string} [subpage] - Sub-halaman (crm, iklan, dll.)
         */
        async function navigateTo(page, subpage = null) {
            currentPage = page;
            if (subpage) {
                currentSubPage = subpage;
            }

            console.log(`Navigating to: ${page} ${subpage ? `(${subpage})` : ''}`);

            // Hapus template sebelumnya
            pageContent.innerHTML = '';
            
            // Hapus instance chart sebelumnya
            if (trenChartInstance) trenChartInstance.destroy();
            if (sentimenChartInstance) sentimenChartInstance.destroy();
            
            // Reset state upload gambar
            uploadedImageBase64 = null;

            // Memuat template
            let templateId = `template-${page}`;
            let template = document.getElementById(templateId);
            
            if (template) {
                pageContent.appendChild(template.content.cloneNode(true));
            } else {
                pageContent.innerHTML = `<h2 class="text-2xl">Halaman tidak ditemukan: ${page}</h2>`;
                return;
            }

            // Logika spesifik per halaman
            switch (page) {
                case 'beranda':
                    // (Tidak ada data-fetching khusus di beranda demo ini)
                    break;
                case 'kuantitatif':
                    await loadQuantitativePage(currentSubPage);
                    break;
                case 'kualitatif':
                    loadQualitativePage();
                    break;
                case 'laporan':
                    // (Logika untuk laporan)
                    break;
                case 'pengaturan':
                    // Logika untuk halaman pengaturan
                    loadApiKeyStatus(); // Muat status saat halaman dibuka
                    // Tambahkan listener ke tombol
                    document.getElementById('save-api-key').addEventListener('click', saveApiKey);
                    document.getElementById('delete-api-key').addEventListener('click', deleteApiKey);
                    break;
            }

            updateActiveNav();
        }

        /**
         * Memuat konten untuk halaman kuantitatif.
         * @param {string} department
         */
        async function loadQuantitativePage(department) {
            const data = await fetchQuantitativeData(department);
            
            document.getElementById('kuantitatif-title').textContent = `Evaluasi Kuantitatif: ${data.title}`;
            
            const kpiContainer = document.getElementById('kpi-content');
            const grid = document.getElementById('kuantitatif-grid');
            const mainCol = document.getElementById('kuantitatif-main-col');
            const sidebarCol = document.getElementById('kuantitatif-sidebar-col');
            
            kpiContainer.innerHTML = ''; // Selalu bersihkan
            
            // --- INTI LOGIKA ---
            // Sembunyikan sidebar kanan & lebarkan kolom utama untuk SEMUA form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                if(sidebarCol) sidebarCol.classList.add('hidden');
                if(mainCol) {
                    mainCol.classList.remove('lg:col-span-2');
                    mainCol.classList.add('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-1 gap-4'; // Layout form
            } else {
                // Kembalikan jika ada yg lain
                if(sidebarCol) sidebarCol.classList.remove('hidden');
                if(mainCol) {
                    mainCol.classList.add('lg:col-span-2');
                    mainCol.classList.remove('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-2 md:grid-cols-3 gap-4'; // Layout grid
            }


            // --- SWITCH UNTUK MEMUAT FORM YANG TEPAT ---
            
            let formHTML = ''; // Variabel untuk menyimpan HTML form
            
            switch(department) {
                case 'crm':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus CRM -->
                        <div id="crm-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-cs-name" class="block text-sm font-medium text-gray-700">Nama CS CRM</label>
                                            <select id="crm-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih CS</option>
                                                <option>Regina</option><option>Siti Qomariah</option><option>Lita</option><option>Neng Nurjamil</option><option>Hilma</option><option>Rika</option><option>Ami</option><option>Silvi</option><option>Dela</option><option>Siti</option><option>Nurya</option><option>Neng Salsa</option><option>Halimah</option><option>Rani</option><option>Reza</option><option>Nandi</option><option>Salsabila</option><option>Rini</option><option>Ita Rohaeti</option><option>Ita Purnamasari</option><option>Anisa</option><option>Naya</option><option>Asti</option><option>Eni</option><option>Ardian</option><option>Tio</option><option>naufal</option><option>rama</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="crm-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="crm-perolehan" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5000000">
                                        </div>
                                        <div>
                                            <label for="crm-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="crm-donatur" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="crm-blast" class="block text-sm font-medium text-gray-700">Jumlah Database di-Blast</label>
                                            <input type="number" id="crm-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                        </div>
                                        <div>
                                            <label for="crm-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="crm-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 7000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="crm-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Follow up donatur lama, blast WA ke database baru..."></textarea>
                                        </div>
                                        <div>
                                            <label for="crm-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi yang Digunakan</label>
                                            <textarea id="crm-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'URGENT: Bantu Mereka Sekarang...'"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="crm-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="crm-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="crm-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #crm-export-area -->

                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya CRM) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'iklan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (IKLAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Kolom 1: Input Data -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-perolehan" class="block text-sm font-medium text-gray-700">Perolehan Iklan (Rp)</label>
                                    <input type="number" id="iklan-perolehan" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                                </div>
                                <div>
                                    <label for="iklan-biaya" class="block text-sm font-medium text-gray-700">Biaya Iklan (Rp)</label>
                                    <input type="number" id="iklan-biaya" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000000">
                                </div>
                                <div>
                                    <label for="iklan-target" class="block text-sm font-medium text-gray-700">Target ROAS (x)</label>
                                    <input type="number" id="iklan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 4">
                                </div>
                            </div>
                            <!-- Kolom 2: Input Kualitatif -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-strategi" class="block text-sm font-medium text-gray-700">Platform & Strategi Targeting</label>
                                    <textarea id="iklan-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Facebook Ads, Lookalike Audience Donatur 30 hari, Interest Zakat..."></textarea>
                                </div>
                                <div>
                                    <label for="iklan-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi Iklan (Terbaik)</label>
                                    <textarea id="iklan-narasi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Headline/Narasi dengan performa tertinggi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL ROAS -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi ROAS (Return on Ad Spend)</span>
                            <p id="iklan-roas-result" class="text-3xl font-bold text-blue-600">0.00x</p>
                        </div>
                    `;
                    break;
                
                case 'echannel':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-CHANNEL) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-volume" class="block text-sm font-medium text-gray-700">Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-volume" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                                <div>
                                    <label for="echannel-transaksi" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="echannel-transaksi" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                </div>
                                <div>
                                    <label for="echannel-target" class="block text-sm font-medium text-gray-700">Target Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 200000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-strategi" class="block text-sm font-medium text-gray-700">Mitra Perbankan & Strategi Promosi</label>
                                    <textarea id="echannel-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Fokus promosi di BSI Mobile, M-Syariah Muamalat. Memperpanjang banner promosi di halaman Donasi BSI..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA DONASI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Donasi per Transaksi</span>
                            <p id="echannel-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'kemitraan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (KEMITRAAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-proposal" class="block text-sm font-medium text-gray-700">Proposal Masuk/Dibuat</label>
                                    <input type="number" id="kemitraan-proposal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 20">
                                </div>
                                <div>
                                    <label for="kemitraan-deal" class="block text-sm font-medium text-gray-700">Deal Tercapai (Disetujui)</label>
                                    <input type="number" id="kemitraan-deal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5">
                                </div>
                                <div>
                                    <label for="kemitraan-nilai" class="block text-sm font-medium text-gray-700">Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-nilai" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 100000000">
                                </div>
                                <div>
                                    <label for="kemitraan-target" class="block text-sm font-medium text-gray-700">Target Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-strategi" class="block text-sm font-medium text-gray-700">Sektor & Strategi Pendekatan</label>
                                    <textarea id="kemitraan-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Sektor yang ditarget (Korporat, Komunitas, Pemerintah), program yang ditawarkan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL CLOSING RATE -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Closing Rate</span>
                            <p id="kemitraan-rate-result" class="text-3xl font-bold text-blue-600">0.00%</p>
                        </div>
                    `;
                    break;

                case 'platform':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Platform -->
                        <div id="platform-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-cs-name" class="block text-sm font-medium text-gray-700">Nama Platform</label>
                                            <select id="platform-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Platform</option>
                                                <option>kitabisa.com</option>
                                                <option>Amalsholeh.com</option>
                                                <option>Sharing Hapiness</option>
                                                <option>Bantu Bersama</option>
                                                <option>Sedekahonline</option>
                                                <option>Sumbangan.com (Malaysia)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="platform-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="platform-perolehan" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="platform-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="platform-donatur" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                                        </div>
                                        <div>
                                            <label for="platform-blast" class="block text-sm font-medium text-gray-700">Jumlah 'Shake' / Up Kategori</label>
                                            <input type="number" id="platform-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 10">
                                        </div>
                                        <div>
                                            <label for="platform-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="platform-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="platform-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Update campaign, blast ke donatur internal, 'shake' campaign..."></textarea>
                                        </div>
                                        <div>
                                            <label for="platform-narasi" class="block text-sm font-medium text-gray-700">Judul & Narasi Campaign</label>
                                            <textarea id="platform-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Judul campaign dan ringkasan narasi yang digunakan di platform..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="platform-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="platform-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="platform-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #platform-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Platform) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-platform" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'emoney':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-MONEY) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-volume" class="block text-sm font-medium text-gray-700">Volume Transaksi (Rp)</label>
                                    <input type="number" id="emoney-volume" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 300000000">
                                </div>
                                <div>
                                    <label for="emoney-jumlah" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="emoney-jumlah" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000">
                                </div>
                                <div>
                                    <label for="emoney-target" class="block text-sm font-medium text-gray-700">Target Volume (Rp)</label>
                                    <input type="number" id="emoney-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 350000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-strategi" class="block text-sm font-medium text-gray-700">Platform & Promosi</label>
                                    <textarea id="emoney-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Platform (QRIS, VA, OVO, dll) yang dominan, program promosi yang dijalankan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA TRANSAKSI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Transaksi</span>
                            <p id="emoney-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;

                case 'ecommerce':
                case 'abstore':
                    const title = department === 'ecommerce' ? 'E-Commerce' : 'AB Store';
                    const prefix = department; // 'ecommerce' or 'abstore'
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (${title}) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-penjualan" class="block text-sm font-medium text-gray-700">Total Penjualan (Rp)</label>
                                    <input type="number" id="${prefix}-penjualan" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                </div>
                                <div>
                                    <label for="${prefix}-biaya" class="block text-sm font-medium text-gray-700">Biaya Operasional/HPP (Rp)</label>
                                    <input type="number" id="${prefix}-biaya" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 30000000">
                                </div>
                                <div>
                                    <label for="${prefix}-target" class="block text-sm font-medium text-gray-700">Target Profit (Rp)</label>
                                    <input type="number" id="${prefix}-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 25000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-strategi" class="block text-sm font-medium text-gray-700">Produk Terlaris & Strategi Promosi</label>
                                    <textarea id="${prefix}-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Produk yang paling laku, strategi promosi (diskon, bundling, free ongkir)..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL PROFIT -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Profit</span>
                            <p id="${prefix}-profit-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'offline':
                    // Formulir Kustom untuk Offline Fundrising
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Offline -->
                        <div id="offline-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Pilihan -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-aktivitas" class="block text-sm font-medium text-gray-700">Jenis Aktivitas</label>
                                            <select id="offline-aktivitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Aktivitas</option>
                                                <option>Event</option>
                                                <option>Tebar Kencleng</option>
                                                <option>Training Volunteer</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-fundriser" class="block text-sm font-medium text-gray-700">Nama Fundriser</label>
                                            <select id="offline-fundriser" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Semua</option>
                                                <option>Reza</option>
                                                <option>Nandi</option>
                                                <option>Ardian</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-lokasi" class="block text-sm font-medium text-gray-700">Pilihan Lokasi</label>
                                            <select id="offline-lokasi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Lokasi</option>
                                                <option>Gerai Retail Besar</option>
                                                <option>Warung/Toko</option>
                                                <option>Perkantoran Modern</option>
                                                <option>Kampus</option>
                                                <option>Sekolah</option>
                                                <option>Masjid/Majelis</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Area Dropdown Lokasi Dinamis -->
                                        <div class="col-span-1 md:col-span-2 mt-4 pt-4 border-t border-gray-200">
                                            <label class="block text-sm font-medium text-gray-700">Area Spesifik (Membutuhkan Internet)</label>
                                            <p class="text-xs text-gray-500 mb-3">Pilih area untuk mendapatkan rekomendasi AI yang lebih spesifik.</p>
                                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                <div>
                                                    <select id="offline-provinsi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                        <option value="">Memuat Provinsi...</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kabupaten" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Provinsi Dahulu</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kecamatan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Kabupaten Dahulu</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kinerja -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="offline-perolehan" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="offline-donatur" class="block text-sm font-medium text-gray-700">Jumlah Donatur/Toko/Mitra</label>
                                            <input type="number" id="offline-donatur" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="offline-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="offline-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                        <div>
                                            <label for="offline-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="offline-strategi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Pitching ke HRD Perusahaan A, kerjasama BEM Kampus B, titip kencleng di 50 warung..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL RATA-RATA -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Rata-rata Per Mitra/Donatur</h5>
                                <p id="offline-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dari Pakar Strategi Offline Fundraising berdasarkan data yang Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI Pakar</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="offline-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="offline-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #offline-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Offline) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-offline" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;

                default:
                    // --- Logika untuk Departemen Lain (YANG BELUM DIKUSTOM) ---
                    // (Saat ini tidak ada, tapi ini sebagai fallback)
                    if (data.kpis.length > 0) {
                        data.kpis.forEach(kpi => {
                            kpiContainer.innerHTML += `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <span class="text-sm text-gray-500">${kpi.label}</span>
                                    <p class="text-2xl font-bold text-gray-800">${kpi.value}</p>
                                </div>
                            `;
                        });
                    } else {
                        kpiContainer.innerHTML = '<p class="text-gray-500 col-span-full">Data KPI tidak tersedia.</p>';
                    }
                    
                    // Tambahkan listener untuk tombol AI (di sidebar)
                    const aiButton = document.getElementById('get-ai-eval');
                    if (aiButton) {
                        const newAiButton = aiButton.cloneNode(true); // Cara mudah hapus listener
                        aiButton.parentNode.replaceChild(newAiButton, aiButton);
                        newAiButton.addEventListener('click', () => handleAIEvaluation(department, data));
                    }
                    break;
            }
            
            // --- Sisipkan Form HTML (jika ada) ---
            // Pengecekan 'crm', 'platform' dan 'offline' dikecualikan dari sisipan form generik
            if (formHTML && !['crm', 'platform', 'offline'].includes(department)) {
                // Ini adalah 'iklan', 'echannel', 'kemitraan', 'emoney', 'ecommerce', 'abstore'
                kpiContainer.innerHTML = `
                    <!-- BAGIAN 1 & 2: INPUT DAN KALKULASI -->
                    <div class="p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1 & 2: Kinerja Minggu Ini & Kalkulasi</h5>
                        ${formHTML}
                    </div>
                    
                    <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                    <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                        <p class="text-gray-600 text-sm mb-4">Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                    
                    <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                    <div class="mt-8 pt-6 border-t border-green-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                        <div>
                            <label for="${department}-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp atau Angka KPI)</label>
                            <input type="number" id="${department}-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                        </div>
                        <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                        </button>
                        <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                        </div>
                    </div>
                `;
            } else if (formHTML) {
                // Ini adalah 'crm' atau 'platform' atau 'offline'
                kpiContainer.innerHTML = formHTML;
            }
                
            // --- Tambahkan Event Listener (AI) ---
            const aiEvalBtn = document.getElementById('get-ai-eval');
            if (aiEvalBtn) aiEvalBtn.addEventListener('click', () => handleAIEvaluation(department, data));
            
            const aiPlanBtn = document.getElementById('get-ai-plan');
            if (aiPlanBtn) aiPlanBtn.addEventListener('click', () => handleAIActionPlan(department));
            
            // --- Tambahkan Event Listener (Kalkulasi & PDF) ---
            switch(department) {
                case 'crm':
                    document.querySelectorAll('.crm-calc-input').forEach(input => input.addEventListener('input', calculateSOG));
                    document.getElementById('export-pdf-button').addEventListener('click', () => handleExportPDF('crm'));
                    break;
                case 'iklan':
                    document.querySelectorAll('.iklan-calc-input').forEach(input => input.addEventListener('input', calculateROAS));
                    break;
                case 'echannel':
                    document.querySelectorAll('.echannel-calc-input').forEach(input => input.addEventListener('input', calculateAvgDonation));
                    break;
                case 'kemitraan':
                    document.querySelectorAll('.kemitraan-calc-input').forEach(input => input.addEventListener('input', calculateClosingRate));
                    break;
                case 'platform':
                    document.querySelectorAll('.platform-calc-input').forEach(input => input.addEventListener('input', calculateSOG_Platform));
                    document.getElementById('export-pdf-button-platform').addEventListener('click', () => handleExportPDF('platform'));
                    break;
                case 'emoney':
                    document.querySelectorAll('.emoney-calc-input').forEach(input => input.addEventListener('input', calculateAvgTransaction));
                    break;
                case 'ecommerce':
                    document.querySelectorAll('.ecommerce-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('ecommerce')));
                    break;
                case 'abstore':
                    document.querySelectorAll('.abstore-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('abstore')));
                    break;
                case 'offline':
                    // Listener untuk form offline baru
                    document.querySelectorAll('.offline-calc-input').forEach(input => input.addEventListener('input', calculateAvgPerMitra_Offline));
                    document.getElementById('export-pdf-button-offline').addEventListener('click', () => handleExportPDF('offline'));

                    // Inisialisasi dan event listener untuk dropdown wilayah
                    loadProvinsi(); // Panggil saat form dimuat
                    
                    document.getElementById('offline-provinsi').addEventListener('change', (e) => {
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        
                        if (e.target.value) {
                            loadKabupaten(e.target.value);
                        } else {
                            // Reset
                            if (kabEl) {
                                kabEl.innerHTML = '<option value="">Pilih Provinsi Dahulu</option>';
                                kabEl.disabled = true;
                            }
                            if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    document.getElementById('offline-kabupaten').addEventListener('change', (e) => {
                         const kecEl = document.getElementById('offline-kecamatan');
                        if (e.target.value) {
                            loadKecamatan(e.target.value);
                        } else {
                            // Reset
                             if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    break;
            }


            // Render Grafik (Selalu ada di luar switch)
            try {
                const ctx = document.getElementById('trenChart')?.getContext('2d');
                if (ctx) {
                    trenChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.chart.labels,
                            datasets: [{
                                label: `Tren ${data.title}`,
                                data: data.chart.data,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        }
                    });
                }
            } catch(e) {
                console.error("Failed to create chart:", e.message);
            }
        }
        
        // Fungsi untuk menangani upload gambar
        function setupImageUploadListeners() {
            const input = document.getElementById('image-upload-input');
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const removeBtn = document.getElementById('remove-image-btn');

            if (!input || !previewContainer || !preview || !removeBtn) return;

            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit
                        showToast('Ukuran file terlalu besar. Maksimal 2MB.', true);
                        input.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Simpan data base64 (tanpa prefix)
                        uploadedImageBase64 = e.target.result.split(',')[1];
                        
                        // Tampilkan preview
                        preview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeBtn.addEventListener('click', () => {
                input.value = ''; // Hapus file dari input
                preview.src = '';
                previewContainer.classList.add('hidden');
                uploadedImageBase64 = null; // Hapus data
            });
        }

        /**
         * Memuat konten untuk halaman kualitatif.
         */
        function loadQualitativePage() {
            // Render Grafik Sentimen
            try {
                const ctx = document.getElementById('sentimenChart').getContext('2d');
                sentimenChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Positif', 'Negatif', 'Netral'],
                        datasets: [{
                            label: 'Sentimen Umpan Balik',
                            data: [70, 10, 20], // Data mock
                            backgroundColor: [
                                'rgb(34, 197, 94)',
                                'rgb(239, 68, 68)',
                                'rgb(209, 213, 219)'
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });
            } catch(e) {
                console.error("Failed to create sentiment chart:", e.message);
            }
            
            // Event listener untuk bintang
            document.querySelectorAll('.star-rating').forEach(star => {
                star.addEventListener('click', (e) => {
                    const rating = e.currentTarget.dataset.rating;
                    const stars = e.currentTarget.parentElement.querySelectorAll('.star-rating');
                    stars.forEach(s => {
                        if(s.dataset.rating <= rating) {
                            s.classList.add('text-yellow-400');
                            s.classList.remove('text-gray-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-400');
                        }
                    });
                    console.log(`Rating diberikan: ${rating}`);
                });
            });
            
            // Event listener tombol jempol
             document.querySelectorAll('.thumb-rating').forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    // Logika untuk highlight jempol
                    e.currentTarget.classList.toggle('bg-blue-200');
                });
            });

            // Event listener tombol kirim
            document.getElementById('submit-qual-feedback').addEventListener('click', () => {
                const comment = document.getElementById('qual-comment').value;
                // Logika untuk mengambil rating (bintang/jempol)
                const rating = 5; // Placeholder
                submitQualitativeFeedback(comment, rating, 'comment');
                document.getElementById('qual-comment').value = '';
            });
            
            // Event listener tombol AI Sentimen
            document.getElementById('get-ai-sentiment').addEventListener('click', handleAISentiment);

            // Event listener untuk Tombol Evaluasi Desain AI
            const designEvalButton = document.getElementById('get-ai-design-eval');
            if (designEvalButton) {
                designEvalButton.addEventListener('click', handleAIDesignEvaluation);
            }
            
            // Event listener untuk upload gambar
            setupImageUploadListeners();
        }

        /**
         * Memperbarui status aktif pada link navigasi.
         */
        function updateActiveNav() {
            // Navigasi Atas
            topNavLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active-nav', 'font-bold', 'text-blue-600');
                } else {
                    link.classList.remove('active-nav', 'font-bold', 'text-blue-600');
                }
            });

            // Sidebar
            sidebarLinks.forEach(link => {
                const isPageMatch = link.dataset.page === currentPage;
                const isSubPageMatch = link.dataset.subpage === currentSubPage;

                if (isPageMatch && (link.dataset.subpage ? isSubPageMatch : true)) {
                    link.classList.add('active-sidebar', 'bg-blue-600', 'text-white');
                } else {
                    link.classList.remove('active-sidebar', 'bg-blue-600', 'text-white');
                }
            });
        }
        
        // --- LOGIKA EVALUASI AI (GEMINI) ---
        
        /**
         * Fungsi wrapper untuk menangani retry dengan exponential backoff.
         */
        async function exponentialBackoff(fetchCall, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetchCall();
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429) { // Too Many Requests
                        console.warn(`Retry ${i+1}/${maxRetries} after ${delay}ms`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        console.error(`Fetch error: ${response.status}`, await response.json());
                        return null; // Gagal
                    }
                } catch (error) {
                    console.error('Fetch exception:', error);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            console.error('Max retries reached. AI call failed.');
            return null;
        }

        /**
         * Memanggil Gemini API dengan payload kustom (bisa text+gambar).
         * @param {object} payload
         */
        async function callGeminiPayload(payload) {
            // Kunci API diambil dari localStorage
            const userApiKey = localStorage.getItem('geminiApiKey');

            if (!userApiKey) { // Cek apakah kunci ada
                console.error("GEMINI_API_KEY is not set in localStorage.");
                showToast("Kunci API Gemini belum diatur. Silakan ke menu Pengaturan.", true);
                return "Gagal: Kunci API Gemini belum diatur di menu Pengaturan.";
            }
            
            // URL API dibuat secara dinamis dengan kunci
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

            const result = await exponentialBackoff(() => 
                fetch(GEMINI_API_URL, { // Menggunakan URL dinamis
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
            );

            if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error('Invalid AI response structure:', result);
                return "Gagal mendapatkan respons dari AI. Coba lagi nanti.";
            }
        }
        
        /**
         * Memanggil Gemini API hanya dengan text prompt.
         * @param {string} prompt
         */
        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            return callGeminiPayload(payload); // Menggunakan handler payload
        }

        /**
         * Mengambil data formulir dari departemen yang aktif
         * @param {string} department
         * @returns {object} Objek berisi data formulir
         */
        function getFormData(department) {
            const data = { department: department };
            try {
                switch(department) {
                    case 'crm':
                        data.csName = document.getElementById('crm-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('crm-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('crm-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('crm-donatur')?.value || '0';
                        data.sog = document.getElementById('crm-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('crm-blast')?.value || '0';
                        data.strategi = document.getElementById('crm-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('crm-narasi')?.value || 'N/A';
                        break;
                    case 'iklan':
                        data.perolehan = `Rp ${parseFloat(document.getElementById('iklan-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById('iklan-biaya')?.value || '0').toLocaleString('id-ID')}`;
                        data.roas = document.getElementById('iklan-roas-result')?.textContent || '0.00x';
                        data.targetROAS = document.getElementById('iklan-target')?.value || 'N/A';
                        data.strategi = document.getElementById('iklan-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('iklan-narasi')?.value || 'N/A';
                        break;
                    case 'echannel':
                        data.volume = `Rp ${parseFloat(document.getElementById('echannel-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.transaksi = document.getElementById('echannel-transaksi')?.value || '0';
                        data.avgDonasi = document.getElementById('echannel-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('echannel-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('echannel-strategi')?.value || 'N/A';
                        break;
                    case 'kemitraan':
                        data.proposalMasuk = document.getElementById('kemitraan-proposal')?.value || '0';
                        data.deal = document.getElementById('kemitraan-deal')?.value || '0';
                        data.closingRate = document.getElementById('kemitraan-rate-result')?.textContent || '0.00%';
                        data.nilai = `Rp ${parseFloat(document.getElementById('kemitraan-nilai')?.value || '0').toLocaleString('id-ID')}`;
                        data.targetNilai = `Rp ${parseFloat(document.getElementById('kemitraan-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('kemitraan-strategi')?.value || 'N/A';
                        break;
                    case 'platform':
                        data.platformName = document.getElementById('platform-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('platform-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('platform-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('platform-donatur')?.value || '0';
                        data.sog = document.getElementById('platform-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('platform-blast')?.value || 'N/A';
                        data.strategi = document.getElementById('platform-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('platform-narasi')?.value || 'N/A';
                        break;
                    case 'emoney':
                        data.volume = `Rp ${parseFloat(document.getElementById('emoney-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahTransaksi = document.getElementById('emoney-jumlah')?.value || '0';
                        data.avgTransaksi = document.getElementById('emoney-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('emoney-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('emoney-strategi')?.value || 'N/A';
                        break;
                    case 'ecommerce':
                    case 'abstore':
                        const prefix = department;
                        data.penjualan = `Rp ${parseFloat(document.getElementById(`${prefix}-penjualan`)?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById(`${prefix}-biaya`)?.value || '0').toLocaleString('id-ID')}`;
                        data.profit = document.getElementById(`${prefix}-profit-result`)?.textContent || 'Rp 0';
                        data.targetProfit = `Rp ${parseFloat(document.getElementById(`${prefix}-target`)?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById(`${prefix}-strategi`)?.value || 'N/A';
                        break;
                    case 'offline':
                        // Get data dari form offline baru
                        data.aktivitas = document.getElementById('offline-aktivitas')?.value || 'N/A';
                        data.fundriser = document.getElementById('offline-fundriser')?.value || 'N/A';
                        data.lokasi = document.getElementById('offline-lokasi')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('offline-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('offline-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahMitra = document.getElementById('offline-donatur')?.value || '0';
                        data.rataRata = document.getElementById('offline-avg-result')?.textContent || 'Rp 0';
                        data.strategi = document.getElementById('offline-strategi')?.value || 'N/A';
                        
                        // Tambahan data lokasi
                        const provEl = document.getElementById('offline-provinsi');
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        data.provinsi = provEl?.value ? provEl.options[provEl.selectedIndex].text : 'N/A';
                        data.kabupaten = kabEl?.value ? kabEl.options[kabEl.selectedIndex].text : 'N/A';
                        data.kecamatan = kecEl?.value ? kecEl.options[kecEl.selectedIndex].text : 'N/A';
                        break;
                }
            } catch (e) {
                console.error("Gagal mengambil data form:", e);
            }
            return data;
        }

        /**
         * Membuat prompt AI untuk Evaluasi Minggu Ini
         * @param {object} formData
         * @returns {string} Prompt untuk AI
         */
        function createEvaluationPrompt(formData) {
            let prompt = `Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ). Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "${formData.department}".\n\nData Kinerja Mingguan (JSON):\n${JSON.stringify(formData)}\n\n`;
            prompt += "Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):\n";
            prompt += "1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data yang ada (perolehan vs target, KPI utama, dan rasio kalkulasi).\n";
            prompt += "2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan dapat ditindaklanjuti untuk membantu meningkatkan kinerja. Fokus pada strategi, narasi, dan data.\n";
            
            // Tambahan prompt spesifik
            switch(formData.department) {
                case 'crm':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan CS.\n";
                    break;
                case 'iklan':
                    prompt += "3.  **Evaluasi ROAS & Narasi:** Analisis apakah ROAS sudah baik dan beri masukan tentang narasi/strategi targeting.\n";
                    break;
                case 'echannel':
                    prompt += "3.  **Evaluasi Mitra Bank:** Beri masukan tentang performa di mitra perbankan (BSI, Muamalat, dll) dan efektivitas promosi/visibilitas di channel tersebut.\n";
                    break;
                case 'platform':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan di platform eksternal.\n";
                    break;
                case 'offline':
                    // Prompt evaluasi untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "Offline Fundrising".

                        Data Kinerja Mingguan (JSON):
                        ${JSON.stringify(formData)}

                        Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                        1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data (Perolehan vs Target, Rata-rata per Mitra/Toko, efektivitas Aktivitas & Lokasi).
                        2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan profesional untuk meningkatkan kinerja offline (cara pitching, pemilihan lokasi, manajemen volunteer/kencleng).
                        3.  **Rekomendasi Prospek (Poin Wajib):** Berdasarkan 'Jenis Aktivitas' (${formData.aktivitas}), 'Pilihan Lokasi' (${formData.lokasi}), dan Area Spesifik (${formData.kecamatan}, ${formData.kabupaten}), berikan 3-5 contoh NAMA SPESIFIK (nama toko, nama perusahaan, nama kampus, atau area majelis) di wilayah **Kecamatan ${formData.kecamatan}** yang harus diprospek. **Gunakan data publik atau Google Maps untuk menemukan nama-nama ini.**
                        
                        Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }
            
            prompt += "\nFormat output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).";
            return prompt;
        }

        /**
         * Menangani klik tombol evaluasi AI kuantitatif (DIPERBARUI)
         */
        async function handleAIEvaluation(department, mockKPIData) {
            console.log(`Getting AI eval for ${department}`);
            
            const button = document.getElementById('get-ai-eval');
            const spinner = document.getElementById('ai-loading-spinner');
            const buttonText = document.getElementById('ai-button-text');
            const resultContainer = document.getElementById('ai-result');

            if (!button || !spinner || !buttonText || !resultContainer) {
                console.error("Elemen UI AI tidak ditemukan.");
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang memproses data...</p>';

            let prompt = '';

            // Cek apakah ini departemen dengan form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                const formData = getFormData(department);
                prompt = createEvaluationPrompt(formData);
            } else {
                // Ini adalah departemen generik (fallback, saat ini tidak ada)
                const dataString = JSON.stringify(mockKPIData);
                prompt = `
                    Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ).
                    Tugas Anda adalah mengevaluasi data kinerja departemen "${department}".
                    
                    Data Kinerja (JSON):
                    ${dataString}

                    Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                    1.  **Ringkasan Kinerja:** Satu paragraf singkat (2-3 kalimat) yang merangkum kinerja departemen ini.
                    2.  **Saran Perbaikan (3 Poin):** Tiga poin saran yang spesifik, dapat ditindaklanjuti, dan relevan dengan data untuk meningkatkan kinerja.
                    3.  **Prediksi Tren:** Satu kalimat prediksi tren berdasarkan data yang ada jika tidak ada perubahan.
                    
                    Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                `;
            }

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Dapatkan Evaluasi AI';
        }

        /**
         * Membuat prompt AI untuk Rencana Aksi Minggu Depan
         * @param {string} department
         * @param {object} formData
         * @param {string} targetDepan
         * @returns {string} Prompt untuk AI
         */
        function createActionPlanPrompt(department, formData, targetDepan) {
            let prompt = `
                Anda adalah seorang konsultan strategi marketing filantropi (fundraising) kelas dunia. Anda memiliki pemahaman mendalam tentang lanskap filantropi digital di Indonesia dan juga memahami persona dakwah Buya Yahya dan lembaga LAZ Albahjah.

                Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "${department}" guna mencapai target minggu depan.

                Data Kontekstual Minggu Ini:
                ${JSON.stringify(formData)}
                
                Target Minggu Depan: ${targetDepan}

                Instruksi Wajib (gunakan Bahasa Indonesia):
                1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                2.  **Marketing Filantropi Terkini:** Gabungkan teknik marketing filantropi digital terkini (personalisasi, social proof, story-telling, 'urgency' etis).
                3.  **Kekuatan Albahjah & Buya Yahya:** Ini SANGAT PENTING. Kaitkan strategi ini dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, tausiyah relevan, transparansi).
            `;

            // Tambahan prompt spesifik
            switch(department) {
                case 'crm':
                    prompt += "\n4.  **Spesifik CRM:** Fokus pada segmentasi database donatur (loyal, 'tidur') dan A/B testing narasi personal.\n";
                    break;
                case 'iklan':
                    prompt += "\n4.  **Spesifik Iklan:** Fokus pada rekomendasi audiens (LAL, Custom) dan angle 'creative' (visual/headline) baru yang mengaitkan Buya Yahya.\n";
                    break;
                case 'echannel':
                    prompt += "\n4.  **Spesifik E-channel:** Fokus pada 1-2 program promosi baru bersama mitra perbankan (misal: BSI, Muamalat) atau optimalisasi *placement* donasi di dalam aplikasi mereka.\n";
                    break;
                case 'kemitraan':
                    prompt += "\n4.  **Spesifik Kemitraan:** Fokus pada 2-3 sektor industri baru yang potensial (misal: Halal Tech, Travel) dan cara 'pitching' yang unik.\n";
                    break;
                case 'platform':
                    prompt += "\n4.  **Spesifik Platform Eksternal:** Fokus pada 1-2 ide *campaign* baru atau optimalisasi narasi/visual yang cocok untuk audiens spesifik di platform eksternal (spt. Kitabisa, Amalsholeh).\n";
                    break;
                case 'emoney':
                    prompt += "\n4.  **Spesifik E-money:** Fokus pada 1-2 program promosi bersama mitra e-wallet (cashback, poin) untuk event tertentu (misal: Jumat Berkah).\n";
                    break;
                case 'ecommerce':
                case 'abstore':
                    prompt += "\n4.  **Spesifik E-commerce:** Fokus pada strategi 'bundling' produk atau 'up-selling' produk terlaris.\n";
                    break;
                case 'offline':
                    // Prompt Rencana Aksi disesuaikan untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "Offline Fundrising" guna mencapai target minggu depan.

                        Data Kontekstual Minggu Ini:
                        ${JSON.stringify(formData)}
                        
                        Target Minggu Depan: ${targetDepan}

                        Instruksi Wajib (gunakan Bahasa Indonesia):
                        1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                        2.  **Kekuatan Albahjah & Buya Yahya:** Kaitkan strategi dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, materi tausiyah untuk 'pitching').
                        3.  **Spesifik Offline:** Fokus pada 2-3 strategi baru untuk 'scaling up' (memperbanyak) tebar kencleng/event, dan strategi 'door-to-door' atau 'pitching' yang efektif untuk lokasi yang dipilih. Berikan contoh skrip 'pitching' singkat.
                        
                        Format output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }

            prompt += "\nFormat output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.";
            return prompt;
        }

        /**
         * Menangani klik tombol rencana aksi AI (DIPERBARUI)
         */
        async function handleAIActionPlan(department) {
            console.log(`Getting AI Action Plan for ${department}`);
            
            const button = document.getElementById('get-ai-plan');
            const spinner = document.getElementById('ai-plan-loading');
            const buttonText = document.getElementById('ai-plan-button-text');
            const resultContainer = document.getElementById('ai-plan-result');
            // Mengambil target-depan berdasarkan ID unik departemen
            const targetDepanEl = document.getElementById(`${department}-target-depan`);

            if (!button || !spinner || !buttonText || !resultContainer || !targetDepanEl) {
                console.error("Elemen UI AI Plan tidak ditemukan.");
                return;
            }

            const targetDepan = targetDepanEl.value;
            if (!targetDepan || targetDepan === '0') {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan Target Minggu Depan terlebih dahulu.</p>';
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menyusun rencana aksi...</p>';

            const formData = getFormData(department);
            const prompt = createActionPlanPrompt(department, formData, targetDepan);

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Buatkan Rencana Aksi AI';
        }

        /**
         * Menangani klik tombol analisis sentimen AI.
         */
        async function handleAISentiment() {
            console.log('Getting AI sentiment analysis...');
            
            const button = document.getElementById('get-ai-sentiment');
            const spinner = document.getElementById('ai-sentiment-loading');
            const buttonText = document.getElementById('ai-sentiment-button-text');
            const resultContainer = document.getElementById('ai-sentiment-result');

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menganalisis umpan balik...</p>';

            const feedbackList = await fetchQualitativeFeedback();
            const dataString = JSON.stringify(feedbackList);

            const prompt = `
                Anda adalah seorang analis sentimen ahli.
                Berikut adalah daftar umpan balik (review) kualitatif untuk desain media dan grafis:
                ${dataString}

                Tugas Anda (gunakan Bahasa Indonesia):
                1.  **Analisis Sentimen:** Berikan ringkasan sentimen keseluruhan (Positif, Negatif, atau Campuran).
                2.  **Tema Utama yang Diidentifikasi:** Identifikasi 3 tema atau topik utama yang paling sering muncul dari umpan balik tersebut (misal: 'Kualitas Audio', 'Desain Visual', 'Kejelasan Font').
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Jalankan Analisis Sentimen';
        }
        
        /**
         * (FUNGSI BARU)
         * Menangani klik tombol evaluasi Desain/Video oleh AI Expert
         */
        async function handleAIDesignEvaluation() {
            console.log('Getting AI Design evaluation...');
            
            const button = document.getElementById('get-ai-design-eval');
            const spinner = document.getElementById('ai-design-loading');
            const buttonText = document.getElementById('ai-design-button-text');
            const resultContainer = document.getElementById('ai-design-result');

            // Ambil Data Input
            const deskripsi = document.getElementById('design-desc').value;
            const views = document.getElementById('design-views').value || '0';
            const engagement = document.getElementById('design-engagement').value || '0';
            const donasi = document.getElementById('design-donations').value || '0';

            if (!deskripsi && !uploadedImageBase64) {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan deskripsi atau upload gambar terlebih dahulu.</p>';
                return;
            }

            // Set Loading
            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis Desain...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI Expert sedang menganalisis konten Anda...</p>';

            // Buat Prompt Khusus
            let textPrompt = `
                Anda adalah seorang Direktur Kreatif dan Desainer Visual ternama dengan pengalaman lebih dari 10 tahun, spesialisasi Anda adalah "crowdfunding" dan "fundraising filantropi" dengan predikat sangat memuaskan. Anda sangat ahli menangani konten untuk WhatsApp (WA) dan media sosial.

                Tugas Anda adalah memberikan evaluasi mendalam atas desain/video berikut, yang digunakan untuk penggalangan dana.

                Data Konten:
                - Deskripsi Teks: ${deskripsi || '(Tidak ada deskripsi, fokus pada gambar terlampir)'}
                - Performa (data aktual):
                    - Views/Jangkauan: ${views}
                    - Engagement (Klik/Balasan): ${engagement}
                    - Hasil Donasi: Rp ${donasi}

                Instruksi (Wajib Gunakan Bahasa Indonesia):
                Berikan evaluasi Anda sebagai seorang ahli.
                1.  **Evaluasi Visual/Narasi (Berdasarkan Teks/Gambar):** Analisis kekuatan dan kelemahan dari konten. Apa yang berhasil? Apa yang kurang dari kacamata desainer crowdfunding?
                2.  **Koneksi ke Performa:** Hubungkan evaluasi Anda dengan data performa. Mengapa views/engagement/donasi bisa seperti itu? Apakah desainnya sudah optimal untuk konversi donasi?
                3.  **Rekomendasi Aksi (Poin Paling Penting):** Berikan 3-5 poin rekomendasi yang sangat spesifik dan profesional (untuk WA atau Medsos) untuk meningkatkan konversi donasi pada desain/video ini di masa depan.
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;
            
            // Bangun payload dengan atau tanpa gambar
            const parts = [{ text: textPrompt }];
            
            if (uploadedImageBase64) {
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg", // Asumsi jpeg, bisa juga dideteksi dari file input
                        data: uploadedImageBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
            };
            
            // Panggil AI
            try {
                const aiResponse = await callGeminiPayload(payload);
                resultContainer.innerHTML = aiResponse;
            } catch (error) {
                console.error('Error in AI Design Eval:', error);
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Gagal mendapatkan evaluasi AI.</p>';
            } finally {
                // Reset button
                button.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = 'Dapatkan Evaluasi Desain Ahli';
            }
        }
        
        // --- LOGIKA EKSPOR PDF ---
        
        // Fungsi dibuat generik untuk menerima konteks (crm, platform, offline)
        async function handleExportPDF(context = 'crm') {
            console.log(`Exporting PDF for ${context}...`);
            
            // Logika diperbarui untuk menangani 'crm', 'platform', 'offline'
            let buttonId;
            if (context === 'crm') {
                buttonId = 'export-pdf-button';
            } else {
                buttonId = `export-pdf-button-${context}`; // 'export-pdf-button-platform', 'export-pdf-button-offline'
            }
            
            const button = document.getElementById(buttonId);
            
            // Periksa apakah elemen tombol ditemukan
            if (!button) {
                console.error(`Tombol ekspor '${buttonId}' tidak ditemukan!`);
                showToast('Tombol ekspor tidak ditemukan.', true);
                return;
            }

            const spinner = button.querySelector('svg:first-child'); // Asumsi spinner adalah svg pertama
            const icon = button.querySelector('svg:nth-child(2)'); // Asumsi icon adalah svg kedua
            const buttonText = button.querySelector('span');
            
            const exportArea = document.getElementById(`${context}-export-area`);
            
            // Dapatkan nama (CS atau Platform atau Aktivitas)
            // Logika pengambilan nama diperbarui
            let name = `${context}_Report`; // Default
            if (context === 'crm') {
                const nameEl = document.getElementById('crm-cs-name');
                if (nameEl) name = nameEl.value;
            } else if (context === 'platform') {
                const nameEl = document.getElementById('platform-cs-name'); // ID-nya masih -cs-name
                if (nameEl) name = nameEl.value;
            } else if (context === 'offline') {
                const nameEl = document.getElementById('offline-aktivitas'); // Kita gunakan nama aktivitas
                if (nameEl) name = nameEl.value;
            }
            
            // Dapatkan tanggal hari ini format YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const filename = `Evaluasi_${context.toUpperCase()}_${name}_${today}.pdf`;

            if (!exportArea) {
                console.error(`Area ekspor '${context}-export-area' tidak ditemukan!`);
                showToast('Gagal mengekspor: Area tidak ditemukan.', true);
                return;
            }
            
            // Tampilkan loading
            if (button) button.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (icon) icon.classList.add('hidden');
            if (buttonText) buttonText.textContent = 'Mengekspor PDF...';
            
            try {
                const opt = {
                    margin:       [0.5, 0.5, 0.5, 0.5], // dalam inci
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                // Panggil html2pdf
                await html2pdf().from(exportArea).set(opt).save();
                
                showToast('PDF berhasil diekspor!');

            } catch (e) {
                console.error('Gagal mengekspor PDF:', e);
                showToast('Gagal mengekspor PDF.', true);
            } finally {
                 // Reset tombol
                if (button) button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (icon) icon.classList.remove('hidden');
                if (buttonText) buttonText.textContent = 'Ekspor Laporan ke PDF';
            }
        }
        
        // --- Utility ---
        function showToast(message, isError = false) {
            // (Fitur toast sederhana bisa ditambahkan di sini)
            // console.log(`TOAST: ${message}`);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-gray-800'} transition-all duration-300 ease-out z-50`;
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
            document.body.appendChild(toast);
            
            // Animasikan
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateY(20px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // --- EVENT LISTENERS GLOBAL ---
        
        /**
         * Listener utama untuk menangani semua klik navigasi.
         */
        document.addEventListener('click', (e) => {
            const topNavLink = e.target.closest('.top-nav-link');
            const sidebarLink = e.target.closest('.sidebar-link');

            if (topNavLink) {
                e.preventDefault();
                navigateTo(topNavLink.dataset.page);
            } else if (sidebarLink) {
                e.preventDefault();
                navigateTo(sidebarLink.dataset.page, sidebarLink.dataset.subpage);
            }
        });
        
        // --- INISIALISASI APLIKASI ---
        document.addEventListener('DOMContentLoaded', () => {
            // Muat halaman awal berdasarkan hash URL, atau default ke beranda
            const hash = window.location.hash.substring(1);
            let page = 'beranda';
            let subpage = null;
            
            if (hash.startsWith('kuantitatif')) {
                page = 'kuantitatif';
                // Cek subpage, misal: #kuantitatif-crm
                const parts = hash.split('-');
                if (parts.length > 1) {
                    subpage = parts[1];
                } else {
                    subpage = 'crm'; // Default jika hanya #kuantitatif
                }
            } else if (hash) {
                page = hash;
            }
            
            navigateTo(page, subpage);
        });

    </script>
    
    <!-- CSS untuk Navigasi dan Animasi -->
    <style>
        .top-nav-link {
            @apply px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-all;
        }
        .top-nav-link.active-nav {
            @apply font-semibold text-blue-600 bg-blue-50;
        }
        .sidebar-link {
            @apply flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 group-hover:text-gray-900 transition-all;
        }
        .sidebar-link.active-sidebar {
            @apply bg-blue-600 text-white font-medium shadow-md;
        }
        .sidebar-link.active-sidebar svg {
            @apply text-white;
        }
        .sidebar-link svg {
             @apply text-gray-500 group-hover:text-gray-800 transition-all;
        }

        /* Animasi Fade-in Sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>

</body>
</html><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Evaluasi Kinerja - LAZ Albahjah Peduli</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Font Roboto (sesuai permintaan) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Memuat Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Memuat Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat html2pdf.js untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Menggunakan font Roboto sebagai default */
        body {
            font-family: 'Roboto', sans-serif;
        }
        /* Custom scrollbar (opsional) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Utama Aplikasi -->
    <div class="flex h-screen bg-gray-100">

        <!-- Sidebar (Navigasi Departemen) -->
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col fixed h-full z-10">
            <h1 class="text-2xl font-bold text-blue-700 mb-8">
                LAZ Albahjah Peduli
            </h1>
            
            <nav class="flex flex-col space-y-2">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Kuantitatif</span>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="crm" class="sidebar-link group">
                    <!-- Icon SVG Sederhana -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>CRM</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="iklan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.144-6.126A1.76 1.76 0 015.56 12.021l6.126-2.144a1.76 1.76 0 01.592-3.417z"></path></svg>
                    <span>Iklan</span>
                </a>
                 <a href="#kuantitatif" data-page="kuantitatif" data-subpage="echannel" class="sidebar-link group">
                    <!-- Ikon 'cash' -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-channel</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="kemitraan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>Kemitraan</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="platform" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Platform</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="emoney" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    <span>E-money</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="ecommerce" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-commerce</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="abstore" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    <span>AB Store</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="offline" class="sidebar-link group">
                    <!-- Icon untuk Offline Fundrising (briefcase) -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Offline Fundrising</span>
                </a>
                
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-2">Kualitatif</span>
                <a href="#kualitatif" data-page="kualitatif" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1m6 0l-1 1m-6-5l-1-1M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Media & Grafis</span>
                </a>
            </nav>

        </aside>

        <!-- Area Konten Utama -->
        <main class="flex-1 flex flex-col ml-64">
            
            <!-- Navigasi Atas -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <nav class="flex items-center space-x-4">
                    <a href="#beranda" data-page="beranda" class="top-nav-link active-nav">Beranda</a>
                    <a href="#kuantitatif" data-page="kuantitatif" class="top-nav-link">Evaluasi Kuantitatif</a>
                    <a href="#kualitatif" data-page="kualitatif" class="top-nav-link">Evaluasi Kualitatif</a>
                    <a href="#laporan" data-page="laporan" class="top-nav-link">Laporan & Analitik</a>
                    <a href="#pengaturan" data-page="pengaturan" class="top-nav-link">Pengaturan</a>
                </nav>
                <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium">
                    Keluar
                </button>
            </header>

            <!-- Konten Halaman Dinamis -->
            <div id="page-content" class="p-6 lg:p-8 flex-1 overflow-y-auto">
                <!-- Konten akan dimuat oleh JavaScript -->
            </div>

        </main>
    </div>

    <!-- Template Halaman (disembunyikan, digunakan oleh JS) -->
    <template id="template-beranda">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Beranda Dashboard</h2>
            <p class="text-gray-600 mb-8">Selamat datang. Berikut adalah ringkasan kinerja terbaru Anda.</p>

            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Ringkasan Kinerja</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Kartu Ringkasan 1 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kuantitatif (Total)</h4>
                    <p class="text-4xl font-bold text-blue-600 mb-4">85<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 2 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kualitatif (Media)</h4>
                    <p class="text-4xl font-bold text-green-600 mb-4">92<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 92%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 3 di Beranda - Diperbarui untuk Platform -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Platform Eksternal (SOG)</h4>
                    <p class="text-4xl font-bold text-yellow-500 mb-4">Rp 150.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 75%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Target: Rp 200.000</p>
                </div>

                <!-- Kartu Ringkasan 4 di Beranda - Diperbarui untuk Offline -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Offline (Rata-rata/Event)</h4>
                    <p class="text-4xl font-bold text-purple-600 mb-4">Rp 12.500.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-purple-600 h-2.5 rounded-full" style="width: 78%"></div>
                    </div>
                     <p class="text-sm text-gray-500 mt-2">Target: Rp 15.000.000</p>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kuantitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6" id="kuantitatif-title">Evaluasi Kuantitatif: CRM</h2>
            
            <!-- Memberi ID pada grid dan kolom -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="kuantitatif-grid">
                <!-- Kolom Kiri: KPI & Grafik -->
                <div class="lg:col-span-2 space-y-6" id="kuantitatif-main-col">
                    <!-- Kartu KPI -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Key Performance Indicators (KPI)</h4>
                        <div id="kpi-content" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- KPI data dimuat oleh JS -->
                        </div>
                    </div>
                    
                    <!-- Kartu Grafik Tren -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h4 class="text-xl font-semibold text-gray-700 mb-4">Grafik Tren (30 Hari Terakhir)</h4>
                         <div class="h-80">
                            <canvas id="trenChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Kolom Kanan: Rekomendasi AI -->
                <!-- Memberi ID pada kolom sidebar -->
                <div class="lg:col-span-1" id="kuantitatif-sidebar-col">
                    <div class="bg-white p-6 rounded-lg shadow-md sticky top-24">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Rekomendasi AI</h4>
                        <p class="text-gray-600 text-sm mb-4">
                            Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja terbaru.
                        </p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <!-- SVG Loading Spinner (disembunyikan) -->
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                            <!-- Hasil AI dimuat di sini -->
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kualitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Evaluasi Kualitatif: Media & Grafis</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Penilaian -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Metrik Evaluasi (Penilaian Tim)</h4>
                    <p class="text-gray-600 text-sm mb-6">Berikan penilaian Anda untuk konten visual terbaru.</p>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Desain Poster Donasi</label>
                        <!-- Sistem Bintang -->
                        <div class="flex items-center space-x-1 text-gray-400">
                            <svg data-rating="1" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="2" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="3" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="4" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="5" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Video Testimoni</label>
                        <!-- Sistem Jempol -->
                        <div class="flex items-center space-x-4">
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-green-100 text-gray-600 hover:text-green-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 19v-5a2 2 0 012-2h2V6a2 2 0 012-2c.621 0 1.17.253 1.564.672l2.066 2.066A2 2 0 0114 8v2z"></path></svg>
                            </button>
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-red-100 text-gray-600 hover:text-red-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.017c.163 0 .326.02.485.06L17 5v5a2 2 0 01-2 2h-2v6a2 2 0 01-2 2c-.621 0-1.17-.253-1.564-.672l-2.066-2.066A2 2 0 0110 16v-2z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4 mt-6">
                        <label for="qual-comment" class="block text-gray-700 font-medium">Komentar & Umpan Balik</label>
                        <textarea id="qual-comment" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Tuliskan umpan balik kualitatif Anda di sini..."></textarea>
                        <button id="submit-qual-feedback" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium">
                            Kirim Umpan Balik
                        </button>
                    </div>
                </div>

                <!-- Kartu Analisis AI -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Analisis Sentimen AI</h4>
                    <p class="text-gray-600 text-sm mb-4">
                        AI menganalisis semua umpan balik kualitatif untuk mengidentifikasi sentimen dan tema utama.
                    </p>
                    <div class="h-64 mb-6">
                        <canvas id="sentimenChart"></canvas>
                    </div>
                    <button id="get-ai-sentiment" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                        <svg id="ai-sentiment-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="ai-sentiment-button-text">Jalankan Analisis Sentimen</span>
                    </button>
                    <div id="ai-sentiment-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                        <p class="text-gray-500 text-center">Hasil analisis AI akan muncul di sini.</p>
                    </div>
                </div>
            </div>

            <!-- Bagian Evaluasi Desain Ahli -->
            <div id="template-evaluasi-desain" class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Evaluasi Desain Ahli (AI)</h3>
                <p class="text-gray-600 text-sm mb-6">
                    Dapatkan evaluasi mendalam dari AI yang berperan sebagai Direktur Kreatif ahli crowdfunding.
                    Masukkan deskripsi konten (atau link) dan metrik kinerjanya.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Input -->
                    <div class="space-y-4">
                        <div>
                            <label for="design-desc" class="block text-sm font-medium text-gray-700">Deskripsi Desain / Video / Link</label>
                            <textarea id="design-desc" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'Video testimoni penerima manfaat, fokus pada close-up emosional, backsound sedih, CTA di akhir oleh Buya Yahya...' atau Link ke Konten"></textarea>
                        </div>
                        
                        <!-- Fitur Upload Gambar -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Upload Gambar (Opsional)</label>
                            <input id="image-upload-input" type="file" accept="image/png, image/jpeg, image/webp" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                            "/>
                            <div id="image-preview-container" class="mt-2 hidden">
                                <span class="block text-sm font-medium text-gray-700 mb-1">Pratinjau:</span>
                                <img id="image-preview" src="" alt="Pratinjau Gambar" class="max-h-40 rounded-lg border shadow-sm"/>
                                <button id="remove-image-btn" class="mt-1 text-sm text-red-600 hover:underline">Hapus Gambar</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="design-views" class="block text-sm font-medium text-gray-700">Views / Jangkauan</label>
                                <input type="number" id="design-views" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000">
                            </div>
                            <div>
                                <label for="design-engagement" class="block text-sm font-medium text-gray-700">Engagement (Klik/Balas)</label>
                                <input type="number" id="design-engagement" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                            </div>
                            <div>
                                <label for="design-donations" class="block text-sm font-medium text-gray-700">Hasil Donasi (Rp)</label>
                                <input type="number" id="design-donations" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                            </div>
                        </div>
                         <button id="get-ai-design-eval" class="w-full bg-purple-600 text-white px-5 py-3 rounded-lg hover:bg-purple-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-design-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-design-button-text">Dapatkan Evaluasi Desain Ahli</span>
                        </button>
                    </div>
                    
                    <!-- Kolom Hasil -->
                    <div class="border-t md:border-t-0 md:border-l pl-0 md:pl-6 pt-6 md:pt-0">
                         <h4 class="text-lg font-semibold text-gray-700 mb-2">Hasil Evaluasi Ahli</h4>
                        <div id="ai-design-result" class="text-gray-700 space-y-3 text-sm min-h-[150px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI expert akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </template>
    
    <template id="template-laporan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Laporan & Analitik</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Perbandingan Kinerja -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Alat Perbandingan Kinerja</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 1</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 2</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Periode</option>
                            <option>30 Hari Terakhir</option>
                            <option>Kuartal Ini</option>
                            <option>Tahun Ini</option>
                        </select>
                    </div>
                    <button class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium">
                        Bandingkan
                    </button>
                    <!-- Area Grafik Perbandingan -->
                    <div class="mt-6 h-64 bg-gray-50 flex items-center justify-center rounded-lg">
                        <p class="text-gray-500">Grafik perbandingan akan muncul di sini</p>
                    </div>
                </div>
                
                <!-- Kartu Unduh Laporan -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Laporan yang Dapat Diunduh</h4>
                    <p class="text-gray-600 text-sm mb-6">Hasilkan laporan ringkasan untuk semua evaluasi.</p>
                    <div class="flex space-x-4">
                        <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh PDF
                        </button>
                        <button class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-pengaturan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan</h2>
            <!-- Konten diisi dengan form API Key -->
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Pengaturan API Gemini</h4>
                <p class="text-gray-600 mb-4 text-sm">
                    Masukkan Kunci API Gemini (AI Studio) Anda untuk mengaktifkan semua fitur evaluasi AI.
                    Kunci Anda disimpan dengan aman di penyimpanan lokal browser Anda (`localStorage`) dan tidak dikirim ke server lain.
                </p>
                
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Masukkan API Key Anda (dimulai dengan AIzaSy...)">
                </div>
                
                <div class="flex items-center space-x-4 mt-4">
                    <button id="save-api-key" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow font-medium">
                        Simpan Kunci
                    </button>
                    <button id="delete-api-key" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition-all font-medium">
                        Hapus Kunci
                    </button>
                    <span id="api-key-status" class="text-sm font-medium text-red-500">Kunci API Belum Diatur.</span>
                </div>
            </div>
        </div>
    </template>


    <script type="module">
        // --- KONFIGURASI APLIKASI ---
        const SUPABASE_URL = 'https://xoootcpffgaimzrcwenr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvb290Y3BmZmdhaW16cmN3ZW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Njk5MDUsImV4cCI6MjA3ODE0NTkwNX0.Vk2vz7sACTWAMizzvByEYIifCNqd8305wGTAA0AvPkY';
        
        // --- INISIALISASI SUPABASE ---
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized.');
            } else {
                console.error('Supabase client library not loaded.');
            }
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        // --- STATE APLIKASI ---
        let currentPage = 'beranda';
        let currentSubPage = 'crm';
        let trenChartInstance = null;
        let sentimenChartInstance = null;
        let uploadedImageBase64 = null; // Untuk menyimpan data gambar

        // --- ELEMEN DOM ---
        const pageContent = document.getElementById('page-content');
        const topNavLinks = document.querySelectorAll('.top-nav-link');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');

        // --- DATA MOCK (CONTOH) ---
        // Ganti ini dengan panggilan fetchSupabaseData()
        const mockData = {
            crm: {
                title: "CRM",
                kpis: [
                    { label: "Permintaan Baru", value: "152" },
                    { label: "Waktu Respons Rata-rata", value: "2.1 jam" },
                    { label: "Tingkat Penyelesaian", value: "89%" },
                    { label: "Kepuasan Pelanggan", value: "4.5/5" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [120, 135, 110, 152]
                }
            },
            iklan: {
                title: "Iklan",
                kpis: [
                    { label: "Tayangan", value: "1,200,000" },
                    { label: "CTR (Click-Through Rate)", value: "5.2%" },
                    { label: "CPA (Cost Per Acquisition)", value: "Rp 15.000" },
                    { label: "ROAS (Return on Ad Spend)", value: "3.5x" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [4.1, 4.8, 5.0, 5.2]
                }
            },
            echannel: {
                title: "E-channel (Perbankan)",
                kpis: [
                    { label: "Volume Donasi", value: "Rp 180.000.000" },
                    { label: "Jumlah Transaksi", value: "1.200" },
                    { label: "Rata-rata Donasi", value: "Rp 150.000" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [35, 45, 40, 60] // Juta Rp
                }
            },
            // Tambahkan departemen lain di sini (kemitraan, platform, dll.)
            kemitraan: { 
                title: "Kemitraan", 
                kpis: [
                    { label: "Proposal Masuk", value: "40" },
                    { label: "Deal Tercapai", value: "10" },
                    { label: "Nilai Kemitraan", value: "Rp 300Jt" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [5, 8, 12, 10] } 
            },
            platform: { 
                title: "Platform (Eksternal)", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 150Jt" },
                    { label: "Jumlah Donatur", value: "1000" },
                    { label: "SOG", value: "Rp 150.000" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [120, 135, 110, 150] } // Juta Rp
            },
            emoney: { 
                title: "E-money", 
                kpis: [
                    { label: "Volume Transaksi", value: "Rp 500Jt" },
                    { label: "Jumlah Transaksi", value: "5.000" },
                    { label: "Biaya (MDR)", value: "0.7%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [100, 120, 150, 130] } // Juta Rp
            },
            ecommerce: { 
                title: "E-commerce", 
                kpis: [
                    { label: "Penjualan", value: "Rp 80Jt" },
                    { label: "Jumlah Order", value: "800" },
                    { label: "Profit Margin", value: "15%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [15, 20, 25, 20] } // Juta Rp
            },
            abstore: { 
                title: "AB Store", 
                kpis: [
                    { label: "Penjualan Total", value: "Rp 120Jt" },
                    { label: "Produk Terlaris", value: "Madu" },
                    { label: "Stok Opname", value: "98% Akurat" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [25, 30, 35, 30] } // Juta Rp
            },
            offline: { 
                title: "Offline Fundrising", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 250Jt" },
                    { label: "Jumlah Mitra/Event", value: "20" },
                    { label: "Rata-rata Per Mitra", value: "Rp 12.5Jt" },
                ], 
                chart: { 
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], 
                    data: [50, 75, 60, 65] // (dalam jutaan Rp)
                } 
            },
        };
        
        const mockFeedback = [
            "Desain posternya sangat menyentuh dan jelas!",
            "Videonya bagus, tapi audionya sedikit pecah di awal.",
            "Saya suka palet warnanya, sangat menenangkan.",
            "Font di infografis terlalu kecil, sulit dibaca di HP.",
            "Luar biasa, sangat profesional!"
        ];

        // --- LOGIKA DATABASE (SUPABASE) ---
        
        /**
         * Mengambil data kuantitatif dari Supabase.
         * (Saat ini menggunakan mock data, hapus komentar untuk data live)
         * @param {string} department - Nama tabel/departemen
         */
        async function fetchQuantitativeData(department) {
            console.log(`Fetching data for: ${department}`);
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockData[department] || { title: department, kpis: [], chart: { labels: [], data: [] } };
            }
            
            // Mengembalikan mock data untuk demo
            return new Promise(resolve => 
                setTimeout(() => resolve(mockData[department]), 500)
            );
        }

        /**
         * Mengambil umpan balik kualitatif dari Supabase.
         */
        async function fetchQualitativeFeedback() {
            console.log('Fetching qualitative feedback...');
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockFeedback;
            }
            
            return new Promise(resolve =>
                setTimeout(() => resolve(mockFeedback), 500)
            );
        }
        
        /**
         * Menyimpan umpan balik kualitatif ke Supabase
         */
         async function submitQualitativeFeedback(comment, rating, type) {
            if (!supabase) {
                // Ganti alert dengan UI yang lebih baik
                showToast('Mode Demo: Umpan balik Anda telah dicatat di konsol.');
                console.warn('Supabase not active. Data not saved.', { comment, rating, type });
                return;
            }
            
            console.log('Submitting feedback:', { comment, rating, type });
            
            // ... (Kode Supabase insert)
            // const { data, error } = await supabase
            //   .from('evaluasi_kualitatif_media')
            //   .insert([
            //     { nama_konten: 'Poster A', komentar: comment, rating_bintang: rating, user_id: 'user-123' }
            //   ]);
            // if (error) console.error('Error submitting feedback:', error);
            // else showToast('Umpan balik berhasil dikirim!');
         }

        // --- FUNGSI KALKULASI BARU ---

        /**
         * Menghitung SOG (Spend of Giving)
         */
        function calculateSOG() {
            const perolehan = parseFloat(document.getElementById('crm-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('crm-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('crm-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung ROAS (Return on Ad Spend)
         */
        function calculateROAS() {
            const perolehan = parseFloat(document.getElementById('iklan-perolehan')?.value) || 0;
            const biaya = parseFloat(document.getElementById('iklan-biaya')?.value) || 0;
            const roasResultEl = document.getElementById('iklan-roas-result');
            
            if (roasResultEl) {
                if (biaya > 0) {
                    const roas = perolehan / biaya;
                    roasResultEl.textContent = `${roas.toFixed(2)}x`;
                } else {
                    roasResultEl.textContent = '0.00x';
                }
            }
        }

        /**
         * Menghitung Rata-rata Donasi (E-channel)
         */
        function calculateAvgDonation() {
            const volume = parseFloat(document.getElementById('echannel-volume')?.value) || 0;
            const transaksi = parseFloat(document.getElementById('echannel-transaksi')?.value) || 0;
            const resultEl = document.getElementById('echannel-avg-result');
            
            if (resultEl) {
                if (transaksi > 0) {
                    const rate = volume / transaksi;
                    resultEl.textContent = `Rp ${rate.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung SOG (Spend of Giving) untuk Platform Eksternal
         */
        function calculateSOG_Platform() {
            const perolehan = parseFloat(document.getElementById('platform-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('platform-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('platform-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Rata-rata Per Mitra (Offline Fundrising)
         */
        function calculateAvgPerMitra_Offline() {
            const perolehan = parseFloat(document.getElementById('offline-perolehan')?.value) || 0;
            const mitra = parseFloat(document.getElementById('offline-donatur')?.value) || 0;
            const resultEl = document.getElementById('offline-avg-result');
            
            if (resultEl) {
                if (mitra > 0) {
                    const avg = perolehan / mitra;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Closing Rate (Kemitraan)
         */
        function calculateClosingRate() {
            const deal = parseFloat(document.getElementById('kemitraan-deal')?.value) || 0;
            const proposal = parseFloat(document.getElementById('kemitraan-proposal')?.value) || 0;
            const resultEl = document.getElementById('kemitraan-rate-result');
            
            if (resultEl) {
                if (proposal > 0) {
                    const rate = (deal / proposal) * 100;
                    resultEl.textContent = `${rate.toFixed(2)}%`;
                } else {
                    resultEl.textContent = '0.00%';
                }
            }
        }

        /**
         * Menghitung Rata-rata Transaksi (E-money)
         */
        function calculateAvgTransaction() {
            const volume = parseFloat(document.getElementById('emoney-volume')?.value) || 0;
            const jumlah = parseFloat(document.getElementById('emoney-jumlah')?.value) || 0;
            const resultEl = document.getElementById('emoney-avg-result');
            
            if (resultEl) {
                if (jumlah > 0) {
                    const avg = volume / jumlah;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung Profit (E-commerce / AB Store)
         */
        function calculateProfit(prefix) { // prefix = 'ecommerce' or 'abstore'
            const penjualan = parseFloat(document.getElementById(`${prefix}-penjualan`)?.value) || 0;
            const biaya = parseFloat(document.getElementById(`${prefix}-biaya`)?.value) || 0;
            const resultEl = document.getElementById(`${prefix}-profit-result`);
            
            if (resultEl) {
                const profit = penjualan - biaya;
                resultEl.textContent = `Rp ${profit.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            }
        }

        // --- FUNGSI API KEY ---

        /**
         * Menyimpan API Key ke localStorage
         */
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key && key.length > 10) { // Validasi sederhana
                localStorage.setItem('geminiApiKey', key);
                document.getElementById('api-key-status').textContent = 'Kunci API Tersimpan!';
                document.getElementById('api-key-status').className = 'text-sm font-medium text-green-600';
                document.getElementById('api-key-input').value = ''; // Kosongkan demi keamanan
                showToast('Kunci API berhasil disimpan.');
            } else {
                showToast('Kunci API sepertinya tidak valid.', true);
            }
        }

        /**
         * Menghapus API Key dari localStorage
         */
        function deleteApiKey() {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('api-key-status').textContent = 'Kunci API Dihapus.';
            document.getElementById('api-key-status').className = 'text-sm font-medium text-red-600';
            document.getElementById('api-key-input').value = '';
            showToast('Kunci API telah dihapus.');
        }

        /**
         * Memuat status API Key saat halaman Pengaturan dibuka
         */
        function loadApiKeyStatus() {
            const key = localStorage.getItem('geminiApiKey');
            const statusEl = document.getElementById('api-key-status');
            if (key) {
                statusEl.textContent = 'Kunci API Tersimpan.';
                statusEl.className = 'text-sm font-medium text-green-600';
            } else {
                statusEl.textContent = 'Kunci API Belum Diatur.';
                statusEl.className = 'text-sm font-medium text-red-600';
            }
        }

        // --- (BARU) LOGIKA API WILAYAH INDONESIA ---
        const API_WILAYAH_BASE_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api';

        /**
         * (BARU) Fungsi helper untuk mengisi dropdown dari API
         */
        function populateDropdown(selectEl, data, defaultOptionText) {
            // Gunakan 'name' (dari emsifa API) atau 'nama' (fallback)
            const nameKey = (data.length > 0 && data[0].name) ? 'name' : 'nama';
            
            selectEl.innerHTML = `<option value="">${defaultOptionText}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[nameKey];
                selectEl.appendChild(option);
            });
            selectEl.disabled = false;
        }

        /**
         * (BARU) Memuat Provinsi
         */
        async function loadProvinsi() {
            const el = document.getElementById('offline-provinsi');
            if (!el) return;
            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/provinces.json`);
                if (!response.ok) throw new Error('Network response was not ok');
                const provinces = await response.json();
                populateDropdown(el, provinces, 'Pilih Provinsi');
            } catch (e) {
                console.error("Gagal memuat provinsi:", e);
                el.innerHTML = '<option value="">Gagal Memuat Provinsi</option>';
            }
        }

        /**
         * (BARU) Memuat Kabupaten
         */
        async function loadKabupaten(provinceId) {
            const el = document.getElementById('offline-kabupaten');
            const elKec = document.getElementById('offline-kecamatan');
            if (!el || !elKec) return;
            
            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;
            elKec.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
            elKec.disabled = true;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/regencies/${provinceId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const regencies = await response.json();
                populateDropdown(el, regencies, 'Pilih Kabupaten / Kota');
            } catch (e) {
                console.error("Gagal memuat kabupaten:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kabupaten</option>';
            }
        }

        /**
         * (BARU) Memuat Kecamatan
         */
        async function loadKecamatan(regencyId) {
            const el = document.getElementById('offline-kecamatan');
            if (!el) return;

            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/districts/${regencyId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const districts = await response.json();
                populateDropdown(el, districts, 'Pilih Kecamatan');
            } catch (e) {
                console.error("Gagal memuat kecamatan:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kecamatan</option>';
            }
        }


        // --- LOGIKA NAVIGASI ---
        
        /**
         * Navigasi ke halaman yang dipilih.
         * @param {string} page - Nama halaman (beranda, kuantitatif, dll.)
         * @param {string} [subpage] - Sub-halaman (crm, iklan, dll.)
         */
        async function navigateTo(page, subpage = null) {
            currentPage = page;
            if (subpage) {
                currentSubPage = subpage;
            }

            console.log(`Navigating to: ${page} ${subpage ? `(${subpage})` : ''}`);

            // Hapus template sebelumnya
            pageContent.innerHTML = '';
            
            // Hapus instance chart sebelumnya
            if (trenChartInstance) trenChartInstance.destroy();
            if (sentimenChartInstance) sentimenChartInstance.destroy();
            
            // Reset state upload gambar
            uploadedImageBase64 = null;

            // Memuat template
            let templateId = `template-${page}`;
            let template = document.getElementById(templateId);
            
            if (template) {
                pageContent.appendChild(template.content.cloneNode(true));
            } else {
                pageContent.innerHTML = `<h2 class="text-2xl">Halaman tidak ditemukan: ${page}</h2>`;
                return;
            }

            // Logika spesifik per halaman
            switch (page) {
                case 'beranda':
                    // (Tidak ada data-fetching khusus di beranda demo ini)
                    break;
                case 'kuantitatif':
                    await loadQuantitativePage(currentSubPage);
                    break;
                case 'kualitatif':
                    loadQualitativePage();
                    break;
                case 'laporan':
                    // (Logika untuk laporan)
                    break;
                case 'pengaturan':
                    // Logika untuk halaman pengaturan
                    loadApiKeyStatus(); // Muat status saat halaman dibuka
                    // Tambahkan listener ke tombol
                    document.getElementById('save-api-key').addEventListener('click', saveApiKey);
                    document.getElementById('delete-api-key').addEventListener('click', deleteApiKey);
                    break;
            }

            updateActiveNav();
        }

        /**
         * Memuat konten untuk halaman kuantitatif.
         * @param {string} department
         */
        async function loadQuantitativePage(department) {
            const data = await fetchQuantitativeData(department);
            
            document.getElementById('kuantitatif-title').textContent = `Evaluasi Kuantitatif: ${data.title}`;
            
            const kpiContainer = document.getElementById('kpi-content');
            const grid = document.getElementById('kuantitatif-grid');
            const mainCol = document.getElementById('kuantitatif-main-col');
            const sidebarCol = document.getElementById('kuantitatif-sidebar-col');
            
            kpiContainer.innerHTML = ''; // Selalu bersihkan
            
            // --- INTI LOGIKA ---
            // Sembunyikan sidebar kanan & lebarkan kolom utama untuk SEMUA form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                if(sidebarCol) sidebarCol.classList.add('hidden');
                if(mainCol) {
                    mainCol.classList.remove('lg:col-span-2');
                    mainCol.classList.add('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-1 gap-4'; // Layout form
            } else {
                // Kembalikan jika ada yg lain
                if(sidebarCol) sidebarCol.classList.remove('hidden');
                if(mainCol) {
                    mainCol.classList.add('lg:col-span-2');
                    mainCol.classList.remove('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-2 md:grid-cols-3 gap-4'; // Layout grid
            }


            // --- SWITCH UNTUK MEMUAT FORM YANG TEPAT ---
            
            let formHTML = ''; // Variabel untuk menyimpan HTML form
            
            switch(department) {
                case 'crm':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus CRM -->
                        <div id="crm-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-cs-name" class="block text-sm font-medium text-gray-700">Nama CS CRM</label>
                                            <select id="crm-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih CS</option>
                                                <option>Regina</option><option>Siti Qomariah</option><option>Lita</option><option>Neng Nurjamil</option><option>Hilma</option><option>Rika</option><option>Ami</option><option>Silvi</option><option>Dela</option><option>Siti</option><option>Nurya</option><option>Neng Salsa</option><option>Halimah</option><option>Rani</option><option>Reza</option><option>Nandi</option><option>Salsabila</option><option>Rini</option><option>Ita Rohaeti</option><option>Ita Purnamasari</option><option>Anisa</option><option>Naya</option><option>Asti</option><option>Eni</option><option>Ardian</option><option>Tio</option><option>naufal</option><option>rama</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="crm-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="crm-perolehan" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5000000">
                                        </div>
                                        <div>
                                            <label for="crm-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="crm-donatur" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="crm-blast" class="block text-sm font-medium text-gray-700">Jumlah Database di-Blast</label>
                                            <input type="number" id="crm-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                        </div>
                                        <div>
                                            <label for="crm-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="crm-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 7000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="crm-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Follow up donatur lama, blast WA ke database baru..."></textarea>
                                        </div>
                                        <div>
                                            <label for="crm-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi yang Digunakan</label>
                                            <textarea id="crm-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'URGENT: Bantu Mereka Sekarang...'"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="crm-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="crm-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="crm-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #crm-export-area -->

                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya CRM) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'iklan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (IKLAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Kolom 1: Input Data -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-perolehan" class="block text-sm font-medium text-gray-700">Perolehan Iklan (Rp)</label>
                                    <input type="number" id="iklan-perolehan" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                                </div>
                                <div>
                                    <label for="iklan-biaya" class="block text-sm font-medium text-gray-700">Biaya Iklan (Rp)</label>
                                    <input type="number" id="iklan-biaya" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000000">
                                </div>
                                <div>
                                    <label for="iklan-target" class="block text-sm font-medium text-gray-700">Target ROAS (x)</label>
                                    <input type="number" id="iklan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 4">
                                </div>
                            </div>
                            <!-- Kolom 2: Input Kualitatif -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-strategi" class="block text-sm font-medium text-gray-700">Platform & Strategi Targeting</label>
                                    <textarea id="iklan-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Facebook Ads, Lookalike Audience Donatur 30 hari, Interest Zakat..."></textarea>
                                </div>
                                <div>
                                    <label for="iklan-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi Iklan (Terbaik)</label>
                                    <textarea id="iklan-narasi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Headline/Narasi dengan performa tertinggi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL ROAS -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi ROAS (Return on Ad Spend)</span>
                            <p id="iklan-roas-result" class="text-3xl font-bold text-blue-600">0.00x</p>
                        </div>
                    `;
                    break;
                
                case 'echannel':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-CHANNEL) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-volume" class="block text-sm font-medium text-gray-700">Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-volume" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                                <div>
                                    <label for="echannel-transaksi" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="echannel-transaksi" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                </div>
                                <div>
                                    <label for="echannel-target" class="block text-sm font-medium text-gray-700">Target Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 200000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-strategi" class="block text-sm font-medium text-gray-700">Mitra Perbankan & Strategi Promosi</label>
                                    <textarea id="echannel-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Fokus promosi di BSI Mobile, M-Syariah Muamalat. Memperpanjang banner promosi di halaman Donasi BSI..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA DONASI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Donasi per Transaksi</span>
                            <p id="echannel-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'kemitraan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (KEMITRAAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-proposal" class="block text-sm font-medium text-gray-700">Proposal Masuk/Dibuat</label>
                                    <input type="number" id="kemitraan-proposal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 20">
                                </div>
                                <div>
                                    <label for="kemitraan-deal" class="block text-sm font-medium text-gray-700">Deal Tercapai (Disetujui)</label>
                                    <input type="number" id="kemitraan-deal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5">
                                </div>
                                <div>
                                    <label for="kemitraan-nilai" class="block text-sm font-medium text-gray-700">Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-nilai" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 100000000">
                                </div>
                                <div>
                                    <label for="kemitraan-target" class="block text-sm font-medium text-gray-700">Target Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-strategi" class="block text-sm font-medium text-gray-700">Sektor & Strategi Pendekatan</label>
                                    <textarea id="kemitraan-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Sektor yang ditarget (Korporat, Komunitas, Pemerintah), program yang ditawarkan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL CLOSING RATE -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Closing Rate</span>
                            <p id="kemitraan-rate-result" class="text-3xl font-bold text-blue-600">0.00%</p>
                        </div>
                    `;
                    break;

                case 'platform':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Platform -->
                        <div id="platform-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-cs-name" class="block text-sm font-medium text-gray-700">Nama Platform</label>
                                            <select id="platform-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Platform</option>
                                                <option>kitabisa.com</option>
                                                <option>Amalsholeh.com</option>
                                                <option>Sharing Hapiness</option>
                                                <option>Bantu Bersama</option>
                                                <option>Sedekahonline</option>
                                                <option>Sumbangan.com (Malaysia)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="platform-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="platform-perolehan" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="platform-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="platform-donatur" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                                        </div>
                                        <div>
                                            <label for="platform-blast" class="block text-sm font-medium text-gray-700">Jumlah 'Shake' / Up Kategori</label>
                                            <input type="number" id="platform-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 10">
                                        </div>
                                        <div>
                                            <label for="platform-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="platform-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="platform-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Update campaign, blast ke donatur internal, 'shake' campaign..."></textarea>
                                        </div>
                                        <div>
                                            <label for="platform-narasi" class="block text-sm font-medium text-gray-700">Judul & Narasi Campaign</label>
                                            <textarea id="platform-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Judul campaign dan ringkasan narasi yang digunakan di platform..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="platform-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="platform-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="platform-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #platform-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Platform) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-platform" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'emoney':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-MONEY) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-volume" class="block text-sm font-medium text-gray-700">Volume Transaksi (Rp)</label>
                                    <input type="number" id="emoney-volume" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 300000000">
                                </div>
                                <div>
                                    <label for="emoney-jumlah" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="emoney-jumlah" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000">
                                </div>
                                <div>
                                    <label for="emoney-target" class="block text-sm font-medium text-gray-700">Target Volume (Rp)</label>
                                    <input type="number" id="emoney-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 350000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-strategi" class="block text-sm font-medium text-gray-700">Platform & Promosi</label>
                                    <textarea id="emoney-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Platform (QRIS, VA, OVO, dll) yang dominan, program promosi yang dijalankan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA TRANSAKSI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Transaksi</span>
                            <p id="emoney-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;

                case 'ecommerce':
                case 'abstore':
                    const title = department === 'ecommerce' ? 'E-Commerce' : 'AB Store';
                    const prefix = department; // 'ecommerce' or 'abstore'
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (${title}) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-penjualan" class="block text-sm font-medium text-gray-700">Total Penjualan (Rp)</label>
                                    <input type="number" id="${prefix}-penjualan" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                </div>
                                <div>
                                    <label for="${prefix}-biaya" class="block text-sm font-medium text-gray-700">Biaya Operasional/HPP (Rp)</label>
                                    <input type="number" id="${prefix}-biaya" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 30000000">
                                </div>
                                <div>
                                    <label for="${prefix}-target" class="block text-sm font-medium text-gray-700">Target Profit (Rp)</label>
                                    <input type="number" id="${prefix}-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 25000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-strategi" class="block text-sm font-medium text-gray-700">Produk Terlaris & Strategi Promosi</label>
                                    <textarea id="${prefix}-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Produk yang paling laku, strategi promosi (diskon, bundling, free ongkir)..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL PROFIT -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Profit</span>
                            <p id="${prefix}-profit-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'offline':
                    // Formulir Kustom untuk Offline Fundrising
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Offline -->
                        <div id="offline-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Pilihan -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-aktivitas" class="block text-sm font-medium text-gray-700">Jenis Aktivitas</label>
                                            <select id="offline-aktivitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Aktivitas</option>
                                                <option>Event</option>
                                                <option>Tebar Kencleng</option>
                                                <option>Training Volunteer</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-fundriser" class="block text-sm font-medium text-gray-700">Nama Fundriser</label>
                                            <select id="offline-fundriser" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Semua</option>
                                                <option>Reza</option>
                                                <option>Nandi</option>
                                                <option>Ardian</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-lokasi" class="block text-sm font-medium text-gray-700">Pilihan Lokasi</label>
                                            <select id="offline-lokasi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Lokasi</option>
                                                <option>Gerai Retail Besar</option>
                                                <option>Warung/Toko</option>
                                                <option>Perkantoran Modern</option>
                                                <option>Kampus</option>
                                                <option>Sekolah</option>
                                                <option>Masjid/Majelis</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Area Dropdown Lokasi Dinamis -->
                                        <div class="col-span-1 md:col-span-2 mt-4 pt-4 border-t border-gray-200">
                                            <label class="block text-sm font-medium text-gray-700">Area Spesifik (Membutuhkan Internet)</label>
                                            <p class="text-xs text-gray-500 mb-3">Pilih area untuk mendapatkan rekomendasi AI yang lebih spesifik.</p>
                                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                <div>
                                                    <select id="offline-provinsi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                        <option value="">Memuat Provinsi...</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kabupaten" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Provinsi Dahulu</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kecamatan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Kabupaten Dahulu</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kinerja -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="offline-perolehan" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="offline-donatur" class="block text-sm font-medium text-gray-700">Jumlah Donatur/Toko/Mitra</label>
                                            <input type="number" id="offline-donatur" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="offline-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="offline-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                        <div>
                                            <label for="offline-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="offline-strategi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Pitching ke HRD Perusahaan A, kerjasama BEM Kampus B, titip kencleng di 50 warung..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL RATA-RATA -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Rata-rata Per Mitra/Donatur</h5>
                                <p id="offline-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dari Pakar Strategi Offline Fundraising berdasarkan data yang Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI Pakar</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="offline-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="offline-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #offline-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Offline) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-offline" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;

                default:
                    // --- Logika untuk Departemen Lain (YANG BELUM DIKUSTOM) ---
                    // (Saat ini tidak ada, tapi ini sebagai fallback)
                    if (data.kpis.length > 0) {
                        data.kpis.forEach(kpi => {
                            kpiContainer.innerHTML += `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <span class="text-sm text-gray-500">${kpi.label}</span>
                                    <p class="text-2xl font-bold text-gray-800">${kpi.value}</p>
                                </div>
                            `;
                        });
                    } else {
                        kpiContainer.innerHTML = '<p class="text-gray-500 col-span-full">Data KPI tidak tersedia.</p>';
                    }
                    
                    // Tambahkan listener untuk tombol AI (di sidebar)
                    const aiButton = document.getElementById('get-ai-eval');
                    if (aiButton) {
                        const newAiButton = aiButton.cloneNode(true); // Cara mudah hapus listener
                        aiButton.parentNode.replaceChild(newAiButton, aiButton);
                        newAiButton.addEventListener('click', () => handleAIEvaluation(department, data));
                    }
                    break;
            }
            
            // --- Sisipkan Form HTML (jika ada) ---
            // Pengecekan 'crm', 'platform' dan 'offline' dikecualikan dari sisipan form generik
            if (formHTML && !['crm', 'platform', 'offline'].includes(department)) {
                // Ini adalah 'iklan', 'echannel', 'kemitraan', 'emoney', 'ecommerce', 'abstore'
                kpiContainer.innerHTML = `
                    <!-- BAGIAN 1 & 2: INPUT DAN KALKULASI -->
                    <div class="p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1 & 2: Kinerja Minggu Ini & Kalkulasi</h5>
                        ${formHTML}
                    </div>
                    
                    <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                    <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                        <p class="text-gray-600 text-sm mb-4">Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                    
                    <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                    <div class="mt-8 pt-6 border-t border-green-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                        <div>
                            <label for="${department}-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp atau Angka KPI)</label>
                            <input type="number" id="${department}-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                        </div>
                        <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                        </button>
                        <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                        </div>
                    </div>
                `;
            } else if (formHTML) {
                // Ini adalah 'crm' atau 'platform' atau 'offline'
                kpiContainer.innerHTML = formHTML;
            }
                
            // --- Tambahkan Event Listener (AI) ---
            const aiEvalBtn = document.getElementById('get-ai-eval');
            if (aiEvalBtn) aiEvalBtn.addEventListener('click', () => handleAIEvaluation(department, data));
            
            const aiPlanBtn = document.getElementById('get-ai-plan');
            if (aiPlanBtn) aiPlanBtn.addEventListener('click', () => handleAIActionPlan(department));
            
            // --- Tambahkan Event Listener (Kalkulasi & PDF) ---
            switch(department) {
                case 'crm':
                    document.querySelectorAll('.crm-calc-input').forEach(input => input.addEventListener('input', calculateSOG));
                    document.getElementById('export-pdf-button').addEventListener('click', () => handleExportPDF('crm'));
                    break;
                case 'iklan':
                    document.querySelectorAll('.iklan-calc-input').forEach(input => input.addEventListener('input', calculateROAS));
                    break;
                case 'echannel':
                    document.querySelectorAll('.echannel-calc-input').forEach(input => input.addEventListener('input', calculateAvgDonation));
                    break;
                case 'kemitraan':
                    document.querySelectorAll('.kemitraan-calc-input').forEach(input => input.addEventListener('input', calculateClosingRate));
                    break;
                case 'platform':
                    document.querySelectorAll('.platform-calc-input').forEach(input => input.addEventListener('input', calculateSOG_Platform));
                    document.getElementById('export-pdf-button-platform').addEventListener('click', () => handleExportPDF('platform'));
                    break;
                case 'emoney':
                    document.querySelectorAll('.emoney-calc-input').forEach(input => input.addEventListener('input', calculateAvgTransaction));
                    break;
                case 'ecommerce':
                    document.querySelectorAll('.ecommerce-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('ecommerce')));
                    break;
                case 'abstore':
                    document.querySelectorAll('.abstore-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('abstore')));
                    break;
                case 'offline':
                    // Listener untuk form offline baru
                    document.querySelectorAll('.offline-calc-input').forEach(input => input.addEventListener('input', calculateAvgPerMitra_Offline));
                    document.getElementById('export-pdf-button-offline').addEventListener('click', () => handleExportPDF('offline'));

                    // Inisialisasi dan event listener untuk dropdown wilayah
                    loadProvinsi(); // Panggil saat form dimuat
                    
                    document.getElementById('offline-provinsi').addEventListener('change', (e) => {
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        
                        if (e.target.value) {
                            loadKabupaten(e.target.value);
                        } else {
                            // Reset
                            if (kabEl) {
                                kabEl.innerHTML = '<option value="">Pilih Provinsi Dahulu</option>';
                                kabEl.disabled = true;
                            }
                            if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    document.getElementById('offline-kabupaten').addEventListener('change', (e) => {
                         const kecEl = document.getElementById('offline-kecamatan');
                        if (e.target.value) {
                            loadKecamatan(e.target.value);
                        } else {
                            // Reset
                             if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    break;
            }


            // Render Grafik (Selalu ada di luar switch)
            try {
                const ctx = document.getElementById('trenChart')?.getContext('2d');
                if (ctx) {
                    trenChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.chart.labels,
                            datasets: [{
                                label: `Tren ${data.title}`,
                                data: data.chart.data,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        }
                    });
                }
            } catch(e) {
                console.error("Failed to create chart:", e.message);
            }
        }
        
        // Fungsi untuk menangani upload gambar
        function setupImageUploadListeners() {
            const input = document.getElementById('image-upload-input');
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const removeBtn = document.getElementById('remove-image-btn');

            if (!input || !previewContainer || !preview || !removeBtn) return;

            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit
                        showToast('Ukuran file terlalu besar. Maksimal 2MB.', true);
                        input.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Simpan data base64 (tanpa prefix)
                        uploadedImageBase64 = e.target.result.split(',')[1];
                        
                        // Tampilkan preview
                        preview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeBtn.addEventListener('click', () => {
                input.value = ''; // Hapus file dari input
                preview.src = '';
                previewContainer.classList.add('hidden');
                uploadedImageBase64 = null; // Hapus data
            });
        }

        /**
         * Memuat konten untuk halaman kualitatif.
         */
        function loadQualitativePage() {
            // Render Grafik Sentimen
            try {
                const ctx = document.getElementById('sentimenChart').getContext('2d');
                sentimenChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Positif', 'Negatif', 'Netral'],
                        datasets: [{
                            label: 'Sentimen Umpan Balik',
                            data: [70, 10, 20], // Data mock
                            backgroundColor: [
                                'rgb(34, 197, 94)',
                                'rgb(239, 68, 68)',
                                'rgb(209, 213, 219)'
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });
            } catch(e) {
                console.error("Failed to create sentiment chart:", e.message);
            }
            
            // Event listener untuk bintang
            document.querySelectorAll('.star-rating').forEach(star => {
                star.addEventListener('click', (e) => {
                    const rating = e.currentTarget.dataset.rating;
                    const stars = e.currentTarget.parentElement.querySelectorAll('.star-rating');
                    stars.forEach(s => {
                        if(s.dataset.rating <= rating) {
                            s.classList.add('text-yellow-400');
                            s.classList.remove('text-gray-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-400');
                        }
                    });
                    console.log(`Rating diberikan: ${rating}`);
                });
            });
            
            // Event listener tombol jempol
             document.querySelectorAll('.thumb-rating').forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    // Logika untuk highlight jempol
                    e.currentTarget.classList.toggle('bg-blue-200');
                });
            });

            // Event listener tombol kirim
            document.getElementById('submit-qual-feedback').addEventListener('click', () => {
                const comment = document.getElementById('qual-comment').value;
                // Logika untuk mengambil rating (bintang/jempol)
                const rating = 5; // Placeholder
                submitQualitativeFeedback(comment, rating, 'comment');
                document.getElementById('qual-comment').value = '';
            });
            
            // Event listener tombol AI Sentimen
            document.getElementById('get-ai-sentiment').addEventListener('click', handleAISentiment);

            // Event listener untuk Tombol Evaluasi Desain AI
            const designEvalButton = document.getElementById('get-ai-design-eval');
            if (designEvalButton) {
                designEvalButton.addEventListener('click', handleAIDesignEvaluation);
            }
            
            // Event listener untuk upload gambar
            setupImageUploadListeners();
        }

        /**
         * Memperbarui status aktif pada link navigasi.
         */
        function updateActiveNav() {
            // Navigasi Atas
            topNavLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active-nav', 'font-bold', 'text-blue-600');
                } else {
                    link.classList.remove('active-nav', 'font-bold', 'text-blue-600');
                }
            });

            // Sidebar
            sidebarLinks.forEach(link => {
                const isPageMatch = link.dataset.page === currentPage;
                const isSubPageMatch = link.dataset.subpage === currentSubPage;

                if (isPageMatch && (link.dataset.subpage ? isSubPageMatch : true)) {
                    link.classList.add('active-sidebar', 'bg-blue-600', 'text-white');
                } else {
                    link.classList.remove('active-sidebar', 'bg-blue-600', 'text-white');
                }
            });
        }
        
        // --- LOGIKA EVALUASI AI (GEMINI) ---
        
        /**
         * Fungsi wrapper untuk menangani retry dengan exponential backoff.
         */
        async function exponentialBackoff(fetchCall, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetchCall();
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429) { // Too Many Requests
                        console.warn(`Retry ${i+1}/${maxRetries} after ${delay}ms`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        console.error(`Fetch error: ${response.status}`, await response.json());
                        return null; // Gagal
                    }
                } catch (error) {
                    console.error('Fetch exception:', error);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            console.error('Max retries reached. AI call failed.');
            return null;
        }

        /**
         * Memanggil Gemini API dengan payload kustom (bisa text+gambar).
         * @param {object} payload
         */
        async function callGeminiPayload(payload) {
            // Kunci API diambil dari localStorage
            const userApiKey = localStorage.getItem('geminiApiKey');

            if (!userApiKey) { // Cek apakah kunci ada
                console.error("GEMINI_API_KEY is not set in localStorage.");
                showToast("Kunci API Gemini belum diatur. Silakan ke menu Pengaturan.", true);
                return "Gagal: Kunci API Gemini belum diatur di menu Pengaturan.";
            }
            
            // URL API dibuat secara dinamis dengan kunci
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

            const result = await exponentialBackoff(() => 
                fetch(GEMINI_API_URL, { // Menggunakan URL dinamis
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
            );

            if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error('Invalid AI response structure:', result);
                return "Gagal mendapatkan respons dari AI. Coba lagi nanti.";
            }
        }
        
        /**
         * Memanggil Gemini API hanya dengan text prompt.
         * @param {string} prompt
         */
        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            return callGeminiPayload(payload); // Menggunakan handler payload
        }

        /**
         * Mengambil data formulir dari departemen yang aktif
         * @param {string} department
         * @returns {object} Objek berisi data formulir
         */
        function getFormData(department) {
            const data = { department: department };
            try {
                switch(department) {
                    case 'crm':
                        data.csName = document.getElementById('crm-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('crm-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('crm-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('crm-donatur')?.value || '0';
                        data.sog = document.getElementById('crm-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('crm-blast')?.value || '0';
                        data.strategi = document.getElementById('crm-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('crm-narasi')?.value || 'N/A';
                        break;
                    case 'iklan':
                        data.perolehan = `Rp ${parseFloat(document.getElementById('iklan-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById('iklan-biaya')?.value || '0').toLocaleString('id-ID')}`;
                        data.roas = document.getElementById('iklan-roas-result')?.textContent || '0.00x';
                        data.targetROAS = document.getElementById('iklan-target')?.value || 'N/A';
                        data.strategi = document.getElementById('iklan-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('iklan-narasi')?.value || 'N/A';
                        break;
                    case 'echannel':
                        data.volume = `Rp ${parseFloat(document.getElementById('echannel-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.transaksi = document.getElementById('echannel-transaksi')?.value || '0';
                        data.avgDonasi = document.getElementById('echannel-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('echannel-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('echannel-strategi')?.value || 'N/A';
                        break;
                    case 'kemitraan':
                        data.proposalMasuk = document.getElementById('kemitraan-proposal')?.value || '0';
                        data.deal = document.getElementById('kemitraan-deal')?.value || '0';
                        data.closingRate = document.getElementById('kemitraan-rate-result')?.textContent || '0.00%';
                        data.nilai = `Rp ${parseFloat(document.getElementById('kemitraan-nilai')?.value || '0').toLocaleString('id-ID')}`;
                        data.targetNilai = `Rp ${parseFloat(document.getElementById('kemitraan-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('kemitraan-strategi')?.value || 'N/A';
                        break;
                    case 'platform':
                        data.platformName = document.getElementById('platform-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('platform-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('platform-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('platform-donatur')?.value || '0';
                        data.sog = document.getElementById('platform-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('platform-blast')?.value || 'N/A';
                        data.strategi = document.getElementById('platform-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('platform-narasi')?.value || 'N/A';
                        break;
                    case 'emoney':
                        data.volume = `Rp ${parseFloat(document.getElementById('emoney-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahTransaksi = document.getElementById('emoney-jumlah')?.value || '0';
                        data.avgTransaksi = document.getElementById('emoney-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('emoney-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('emoney-strategi')?.value || 'N/A';
                        break;
                    case 'ecommerce':
                    case 'abstore':
                        const prefix = department;
                        data.penjualan = `Rp ${parseFloat(document.getElementById(`${prefix}-penjualan`)?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById(`${prefix}-biaya`)?.value || '0').toLocaleString('id-ID')}`;
                        data.profit = document.getElementById(`${prefix}-profit-result`)?.textContent || 'Rp 0';
                        data.targetProfit = `Rp ${parseFloat(document.getElementById(`${prefix}-target`)?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById(`${prefix}-strategi`)?.value || 'N/A';
                        break;
                    case 'offline':
                        // Get data dari form offline baru
                        data.aktivitas = document.getElementById('offline-aktivitas')?.value || 'N/A';
                        data.fundriser = document.getElementById('offline-fundriser')?.value || 'N/A';
                        data.lokasi = document.getElementById('offline-lokasi')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('offline-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('offline-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahMitra = document.getElementById('offline-donatur')?.value || '0';
                        data.rataRata = document.getElementById('offline-avg-result')?.textContent || 'Rp 0';
                        data.strategi = document.getElementById('offline-strategi')?.value || 'N/A';
                        
                        // Tambahan data lokasi
                        const provEl = document.getElementById('offline-provinsi');
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        data.provinsi = provEl?.value ? provEl.options[provEl.selectedIndex].text : 'N/A';
                        data.kabupaten = kabEl?.value ? kabEl.options[kabEl.selectedIndex].text : 'N/A';
                        data.kecamatan = kecEl?.value ? kecEl.options[kecEl.selectedIndex].text : 'N/A';
                        break;
                }
            } catch (e) {
                console.error("Gagal mengambil data form:", e);
            }
            return data;
        }

        /**
         * Membuat prompt AI untuk Evaluasi Minggu Ini
         * @param {object} formData
         * @returns {string} Prompt untuk AI
         */
        function createEvaluationPrompt(formData) {
            let prompt = `Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ). Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "${formData.department}".\n\nData Kinerja Mingguan (JSON):\n${JSON.stringify(formData)}\n\n`;
            prompt += "Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):\n";
            prompt += "1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data yang ada (perolehan vs target, KPI utama, dan rasio kalkulasi).\n";
            prompt += "2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan dapat ditindaklanjuti untuk membantu meningkatkan kinerja. Fokus pada strategi, narasi, dan data.\n";
            
            // Tambahan prompt spesifik
            switch(formData.department) {
                case 'crm':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan CS.\n";
                    break;
                case 'iklan':
                    prompt += "3.  **Evaluasi ROAS & Narasi:** Analisis apakah ROAS sudah baik dan beri masukan tentang narasi/strategi targeting.\n";
                    break;
                case 'echannel':
                    prompt += "3.  **Evaluasi Mitra Bank:** Beri masukan tentang performa di mitra perbankan (BSI, Muamalat, dll) dan efektivitas promosi/visibilitas di channel tersebut.\n";
                    break;
                case 'platform':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan di platform eksternal.\n";
                    break;
                case 'offline':
                    // Prompt evaluasi untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "Offline Fundrising".

                        Data Kinerja Mingguan (JSON):
                        ${JSON.stringify(formData)}

                        Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                        1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data (Perolehan vs Target, Rata-rata per Mitra/Toko, efektivitas Aktivitas & Lokasi).
                        2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan profesional untuk meningkatkan kinerja offline (cara pitching, pemilihan lokasi, manajemen volunteer/kencleng).
                        3.  **Rekomendasi Prospek (Poin Wajib):** Berdasarkan 'Jenis Aktivitas' (${formData.aktivitas}), 'Pilihan Lokasi' (${formData.lokasi}), dan Area Spesifik (${formData.kecamatan}, ${formData.kabupaten}), berikan 3-5 contoh NAMA SPESIFIK (nama toko, nama perusahaan, nama kampus, atau area majelis) di wilayah **Kecamatan ${formData.kecamatan}** yang harus diprospek. **Gunakan data publik atau Google Maps untuk menemukan nama-nama ini.**
                        
                        Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }
            
            prompt += "\nFormat output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).";
            return prompt;
        }

        /**
         * Menangani klik tombol evaluasi AI kuantitatif (DIPERBARUI)
         */
        async function handleAIEvaluation(department, mockKPIData) {
            console.log(`Getting AI eval for ${department}`);
            
            const button = document.getElementById('get-ai-eval');
            const spinner = document.getElementById('ai-loading-spinner');
            const buttonText = document.getElementById('ai-button-text');
            const resultContainer = document.getElementById('ai-result');

            if (!button || !spinner || !buttonText || !resultContainer) {
                console.error("Elemen UI AI tidak ditemukan.");
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang memproses data...</p>';

            let prompt = '';

            // Cek apakah ini departemen dengan form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                const formData = getFormData(department);
                prompt = createEvaluationPrompt(formData);
            } else {
                // Ini adalah departemen generik (fallback, saat ini tidak ada)
                const dataString = JSON.stringify(mockKPIData);
                prompt = `
                    Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ).
                    Tugas Anda adalah mengevaluasi data kinerja departemen "${department}".
                    
                    Data Kinerja (JSON):
                    ${dataString}

                    Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                    1.  **Ringkasan Kinerja:** Satu paragraf singkat (2-3 kalimat) yang merangkum kinerja departemen ini.
                    2.  **Saran Perbaikan (3 Poin):** Tiga poin saran yang spesifik, dapat ditindaklanjuti, dan relevan dengan data untuk meningkatkan kinerja.
                    3.  **Prediksi Tren:** Satu kalimat prediksi tren berdasarkan data yang ada jika tidak ada perubahan.
                    
                    Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                `;
            }

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Dapatkan Evaluasi AI';
        }

        /**
         * Membuat prompt AI untuk Rencana Aksi Minggu Depan
         * @param {string} department
         * @param {object} formData
         * @param {string} targetDepan
         * @returns {string} Prompt untuk AI
         */
        function createActionPlanPrompt(department, formData, targetDepan) {
            let prompt = `
                Anda adalah seorang konsultan strategi marketing filantropi (fundraising) kelas dunia. Anda memiliki pemahaman mendalam tentang lanskap filantropi digital di Indonesia dan juga memahami persona dakwah Buya Yahya dan lembaga LAZ Albahjah.

                Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "${department}" guna mencapai target minggu depan.

                Data Kontekstual Minggu Ini:
                ${JSON.stringify(formData)}
                
                Target Minggu Depan: ${targetDepan}

                Instruksi Wajib (gunakan Bahasa Indonesia):
                1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                2.  **Marketing Filantropi Terkini:** Gabungkan teknik marketing filantropi digital terkini (personalisasi, social proof, story-telling, 'urgency' etis).
                3.  **Kekuatan Albahjah & Buya Yahya:** Ini SANGAT PENTING. Kaitkan strategi ini dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, tausiyah relevan, transparansi).
            `;

            // Tambahan prompt spesifik
            switch(department) {
                case 'crm':
                    prompt += "\n4.  **Spesifik CRM:** Fokus pada segmentasi database donatur (loyal, 'tidur') dan A/B testing narasi personal.\n";
                    break;
                case 'iklan':
                    prompt += "\n4.  **Spesifik Iklan:** Fokus pada rekomendasi audiens (LAL, Custom) dan angle 'creative' (visual/headline) baru yang mengaitkan Buya Yahya.\n";
                    break;
                case 'echannel':
                    prompt += "\n4.  **Spesifik E-channel:** Fokus pada 1-2 program promosi baru bersama mitra perbankan (misal: BSI, Muamalat) atau optimalisasi *placement* donasi di dalam aplikasi mereka.\n";
                    break;
                case 'kemitraan':
                    prompt += "\n4.  **Spesifik Kemitraan:** Fokus pada 2-3 sektor industri baru yang potensial (misal: Halal Tech, Travel) dan cara 'pitching' yang unik.\n";
                    break;
                case 'platform':
                    prompt += "\n4.  **Spesifik Platform Eksternal:** Fokus pada 1-2 ide *campaign* baru atau optimalisasi narasi/visual yang cocok untuk audiens spesifik di platform eksternal (spt. Kitabisa, Amalsholeh).\n";
                    break;
                case 'emoney':
                    prompt += "\n4.  **Spesifik E-money:** Fokus pada 1-2 program promosi bersama mitra e-wallet (cashback, poin) untuk event tertentu (misal: Jumat Berkah).\n";
                    break;
                case 'ecommerce':
                case 'abstore':
                    prompt += "\n4.  **Spesifik E-commerce:** Fokus pada strategi 'bundling' produk atau 'up-selling' produk terlaris.\n";
                    break;
                case 'offline':
                    // Prompt Rencana Aksi disesuaikan untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "Offline Fundrising" guna mencapai target minggu depan.

                        Data Kontekstual Minggu Ini:
                        ${JSON.stringify(formData)}
                        
                        Target Minggu Depan: ${targetDepan}

                        Instruksi Wajib (gunakan Bahasa Indonesia):
                        1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                        2.  **Kekuatan Albahjah & Buya Yahya:** Kaitkan strategi dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, materi tausiyah untuk 'pitching').
                        3.  **Spesifik Offline:** Fokus pada 2-3 strategi baru untuk 'scaling up' (memperbanyak) tebar kencleng/event, dan strategi 'door-to-door' atau 'pitching' yang efektif untuk lokasi yang dipilih. Berikan contoh skrip 'pitching' singkat.
                        
                        Format output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }

            prompt += "\nFormat output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.";
            return prompt;
        }

        /**
         * Menangani klik tombol rencana aksi AI (DIPERBARUI)
         */
        async function handleAIActionPlan(department) {
            console.log(`Getting AI Action Plan for ${department}`);
            
            const button = document.getElementById('get-ai-plan');
            const spinner = document.getElementById('ai-plan-loading');
            const buttonText = document.getElementById('ai-plan-button-text');
            const resultContainer = document.getElementById('ai-plan-result');
            // Mengambil target-depan berdasarkan ID unik departemen
            const targetDepanEl = document.getElementById(`${department}-target-depan`);

            if (!button || !spinner || !buttonText || !resultContainer || !targetDepanEl) {
                console.error("Elemen UI AI Plan tidak ditemukan.");
                return;
            }

            const targetDepan = targetDepanEl.value;
            if (!targetDepan || targetDepan === '0') {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan Target Minggu Depan terlebih dahulu.</p>';
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menyusun rencana aksi...</p>';

            const formData = getFormData(department);
            const prompt = createActionPlanPrompt(department, formData, targetDepan);

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Buatkan Rencana Aksi AI';
        }

        /**
         * Menangani klik tombol analisis sentimen AI.
         */
        async function handleAISentiment() {
            console.log('Getting AI sentiment analysis...');
            
            const button = document.getElementById('get-ai-sentiment');
            const spinner = document.getElementById('ai-sentiment-loading');
            const buttonText = document.getElementById('ai-sentiment-button-text');
            const resultContainer = document.getElementById('ai-sentiment-result');

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menganalisis umpan balik...</p>';

            const feedbackList = await fetchQualitativeFeedback();
            const dataString = JSON.stringify(feedbackList);

            const prompt = `
                Anda adalah seorang analis sentimen ahli.
                Berikut adalah daftar umpan balik (review) kualitatif untuk desain media dan grafis:
                ${dataString}

                Tugas Anda (gunakan Bahasa Indonesia):
                1.  **Analisis Sentimen:** Berikan ringkasan sentimen keseluruhan (Positif, Negatif, atau Campuran).
                2.  **Tema Utama yang Diidentifikasi:** Identifikasi 3 tema atau topik utama yang paling sering muncul dari umpan balik tersebut (misal: 'Kualitas Audio', 'Desain Visual', 'Kejelasan Font').
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Jalankan Analisis Sentimen';
        }
        
        /**
         * (FUNGSI BARU)
         * Menangani klik tombol evaluasi Desain/Video oleh AI Expert
         */
        async function handleAIDesignEvaluation() {
            console.log('Getting AI Design evaluation...');
            
            const button = document.getElementById('get-ai-design-eval');
            const spinner = document.getElementById('ai-design-loading');
            const buttonText = document.getElementById('ai-design-button-text');
            const resultContainer = document.getElementById('ai-design-result');

            // Ambil Data Input
            const deskripsi = document.getElementById('design-desc').value;
            const views = document.getElementById('design-views').value || '0';
            const engagement = document.getElementById('design-engagement').value || '0';
            const donasi = document.getElementById('design-donations').value || '0';

            if (!deskripsi && !uploadedImageBase64) {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan deskripsi atau upload gambar terlebih dahulu.</p>';
                return;
            }

            // Set Loading
            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis Desain...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI Expert sedang menganalisis konten Anda...</p>';

            // Buat Prompt Khusus
            let textPrompt = `
                Anda adalah seorang Direktur Kreatif dan Desainer Visual ternama dengan pengalaman lebih dari 10 tahun, spesialisasi Anda adalah "crowdfunding" dan "fundraising filantropi" dengan predikat sangat memuaskan. Anda sangat ahli menangani konten untuk WhatsApp (WA) dan media sosial.

                Tugas Anda adalah memberikan evaluasi mendalam atas desain/video berikut, yang digunakan untuk penggalangan dana.

                Data Konten:
                - Deskripsi Teks: ${deskripsi || '(Tidak ada deskripsi, fokus pada gambar terlampir)'}
                - Performa (data aktual):
                    - Views/Jangkauan: ${views}
                    - Engagement (Klik/Balasan): ${engagement}
                    - Hasil Donasi: Rp ${donasi}

                Instruksi (Wajib Gunakan Bahasa Indonesia):
                Berikan evaluasi Anda sebagai seorang ahli.
                1.  **Evaluasi Visual/Narasi (Berdasarkan Teks/Gambar):** Analisis kekuatan dan kelemahan dari konten. Apa yang berhasil? Apa yang kurang dari kacamata desainer crowdfunding?
                2.  **Koneksi ke Performa:** Hubungkan evaluasi Anda dengan data performa. Mengapa views/engagement/donasi bisa seperti itu? Apakah desainnya sudah optimal untuk konversi donasi?
                3.  **Rekomendasi Aksi (Poin Paling Penting):** Berikan 3-5 poin rekomendasi yang sangat spesifik dan profesional (untuk WA atau Medsos) untuk meningkatkan konversi donasi pada desain/video ini di masa depan.
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;
            
            // Bangun payload dengan atau tanpa gambar
            const parts = [{ text: textPrompt }];
            
            if (uploadedImageBase64) {
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg", // Asumsi jpeg, bisa juga dideteksi dari file input
                        data: uploadedImageBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
            };
            
            // Panggil AI
            try {
                const aiResponse = await callGeminiPayload(payload);
                resultContainer.innerHTML = aiResponse;
            } catch (error) {
                console.error('Error in AI Design Eval:', error);
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Gagal mendapatkan evaluasi AI.</p>';
            } finally {
                // Reset button
                button.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = 'Dapatkan Evaluasi Desain Ahli';
            }
        }
        
        // --- LOGIKA EKSPOR PDF ---
        
        // Fungsi dibuat generik untuk menerima konteks (crm, platform, offline)
        async function handleExportPDF(context = 'crm') {
            console.log(`Exporting PDF for ${context}...`);
            
            // Logika diperbarui untuk menangani 'crm', 'platform', 'offline'
            let buttonId;
            if (context === 'crm') {
                buttonId = 'export-pdf-button';
            } else {
                buttonId = `export-pdf-button-${context}`; // 'export-pdf-button-platform', 'export-pdf-button-offline'
            }
            
            const button = document.getElementById(buttonId);
            
            // Periksa apakah elemen tombol ditemukan
            if (!button) {
                console.error(`Tombol ekspor '${buttonId}' tidak ditemukan!`);
                showToast('Tombol ekspor tidak ditemukan.', true);
                return;
            }

            const spinner = button.querySelector('svg:first-child'); // Asumsi spinner adalah svg pertama
            const icon = button.querySelector('svg:nth-child(2)'); // Asumsi icon adalah svg kedua
            const buttonText = button.querySelector('span');
            
            const exportArea = document.getElementById(`${context}-export-area`);
            
            // Dapatkan nama (CS atau Platform atau Aktivitas)
            // Logika pengambilan nama diperbarui
            let name = `${context}_Report`; // Default
            if (context === 'crm') {
                const nameEl = document.getElementById('crm-cs-name');
                if (nameEl) name = nameEl.value;
            } else if (context === 'platform') {
                const nameEl = document.getElementById('platform-cs-name'); // ID-nya masih -cs-name
                if (nameEl) name = nameEl.value;
            } else if (context === 'offline') {
                const nameEl = document.getElementById('offline-aktivitas'); // Kita gunakan nama aktivitas
                if (nameEl) name = nameEl.value;
            }
            
            // Dapatkan tanggal hari ini format YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const filename = `Evaluasi_${context.toUpperCase()}_${name}_${today}.pdf`;

            if (!exportArea) {
                console.error(`Area ekspor '${context}-export-area' tidak ditemukan!`);
                showToast('Gagal mengekspor: Area tidak ditemukan.', true);
                return;
            }
            
            // Tampilkan loading
            if (button) button.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (icon) icon.classList.add('hidden');
            if (buttonText) buttonText.textContent = 'Mengekspor PDF...';
            
            try {
                const opt = {
                    margin:       [0.5, 0.5, 0.5, 0.5], // dalam inci
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                // Panggil html2pdf
                await html2pdf().from(exportArea).set(opt).save();
                
                showToast('PDF berhasil diekspor!');

            } catch (e) {
                console.error('Gagal mengekspor PDF:', e);
                showToast('Gagal mengekspor PDF.', true);
            } finally {
                 // Reset tombol
                if (button) button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (icon) icon.classList.remove('hidden');
                if (buttonText) buttonText.textContent = 'Ekspor Laporan ke PDF';
            }
        }
        
        // --- Utility ---
        function showToast(message, isError = false) {
            // (Fitur toast sederhana bisa ditambahkan di sini)
            // console.log(`TOAST: ${message}`);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-gray-800'} transition-all duration-300 ease-out z-50`;
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
            document.body.appendChild(toast);
            
            // Animasikan
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateY(20px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // --- EVENT LISTENERS GLOBAL ---
        
        /**
         * Listener utama untuk menangani semua klik navigasi.
         */
        document.addEventListener('click', (e) => {
            const topNavLink = e.target.closest('.top-nav-link');
            const sidebarLink = e.target.closest('.sidebar-link');

            if (topNavLink) {
                e.preventDefault();
                navigateTo(topNavLink.dataset.page);
            } else if (sidebarLink) {
                e.preventDefault();
                navigateTo(sidebarLink.dataset.page, sidebarLink.dataset.subpage);
            }
        });
        
        // --- INISIALISASI APLIKASI ---
        document.addEventListener('DOMContentLoaded', () => {
            // Muat halaman awal berdasarkan hash URL, atau default ke beranda
            const hash = window.location.hash.substring(1);
            let page = 'beranda';
            let subpage = null;
            
            if (hash.startsWith('kuantitatif')) {
                page = 'kuantitatif';
                // Cek subpage, misal: #kuantitatif-crm
                const parts = hash.split('-');
                if (parts.length > 1) {
                    subpage = parts[1];
                } else {
                    subpage = 'crm'; // Default jika hanya #kuantitatif
                }
            } else if (hash) {
                page = hash;
            }
            
            navigateTo(page, subpage);
        });

    </script>
    
    <!-- CSS untuk Navigasi dan Animasi -->
    <style>
        .top-nav-link {
            @apply px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-all;
        }
        .top-nav-link.active-nav {
            @apply font-semibold text-blue-600 bg-blue-50;
        }
        .sidebar-link {
            @apply flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 group-hover:text-gray-900 transition-all;
        }
        .sidebar-link.active-sidebar {
            @apply bg-blue-600 text-white font-medium shadow-md;
        }
        .sidebar-link.active-sidebar svg {
            @apply text-white;
        }
        .sidebar-link svg {
             @apply text-gray-500 group-hover:text-gray-800 transition-all;
        }

        /* Animasi Fade-in Sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>

</body>
</html><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Evaluasi Kinerja - LAZ Albahjah Peduli</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Font Roboto (sesuai permintaan) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Memuat Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Memuat Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Memuat html2pdf.js untuk Ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Menggunakan font Roboto sebagai default */
        body {
            font-family: 'Roboto', sans-serif;
        }
        /* Custom scrollbar (opsional) */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontainer Utama Aplikasi -->
    <div class="flex h-screen bg-gray-100">

        <!-- Sidebar (Navigasi Departemen) -->
        <aside class="w-64 bg-white shadow-lg p-6 flex flex-col fixed h-full z-10">
            <h1 class="text-2xl font-bold text-blue-700 mb-8">
                LAZ Albahjah Peduli
            </h1>
            
            <nav class="flex flex-col space-y-2">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Kuantitatif</span>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="crm" class="sidebar-link group">
                    <!-- Icon SVG Sederhana -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>CRM</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="iklan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.144-6.126A1.76 1.76 0 015.56 12.021l6.126-2.144a1.76 1.76 0 01.592-3.417z"></path></svg>
                    <span>Iklan</span>
                </a>
                 <a href="#kuantitatif" data-page="kuantitatif" data-subpage="echannel" class="sidebar-link group">
                    <!-- Ikon 'cash' -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-channel</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="kemitraan" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-2.144M9 13h0M15 13h0M12 13h0M12 13h0M9 13c0-2.21 2.24-4 5-4h1V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2h4v-1a4 4 0 014-4z"></path></svg>
                    <span>Kemitraan</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="platform" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Platform</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="emoney" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    <span>E-money</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="ecommerce" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>E-commerce</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="abstore" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                    <span>AB Store</span>
                </a>
                <a href="#kuantitatif" data-page="kuantitatif" data-subpage="offline" class="sidebar-link group">
                    <!-- Icon untuk Offline Fundrising (briefcase) -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span>Offline Fundrising</span>
                </a>
                
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mt-6 mb-2">Kualitatif</span>
                <a href="#kualitatif" data-page="kualitatif" class="sidebar-link group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1m6 0l-1 1m-6-5l-1-1M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span>Media & Grafis</span>
                </a>
            </nav>

        </aside>

        <!-- Area Konten Utama -->
        <main class="flex-1 flex flex-col ml-64">
            
            <!-- Navigasi Atas -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <nav class="flex items-center space-x-4">
                    <a href="#beranda" data-page="beranda" class="top-nav-link active-nav">Beranda</a>
                    <a href="#kuantitatif" data-page="kuantitatif" class="top-nav-link">Evaluasi Kuantitatif</a>
                    <a href="#kualitatif" data-page="kualitatif" class="top-nav-link">Evaluasi Kualitatif</a>
                    <a href="#laporan" data-page="laporan" class="top-nav-link">Laporan & Analitik</a>
                    <a href="#pengaturan" data-page="pengaturan" class="top-nav-link">Pengaturan</a>
                </nav>
                <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium">
                    Keluar
                </button>
            </header>

            <!-- Konten Halaman Dinamis -->
            <div id="page-content" class="p-6 lg:p-8 flex-1 overflow-y-auto">
                <!-- Konten akan dimuat oleh JavaScript -->
            </div>

        </main>
    </div>

    <!-- Template Halaman (disembunyikan, digunakan oleh JS) -->
    <template id="template-beranda">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Beranda Dashboard</h2>
            <p class="text-gray-600 mb-8">Selamat datang. Berikut adalah ringkasan kinerja terbaru Anda.</p>

            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Ringkasan Kinerja</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- Kartu Ringkasan 1 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kuantitatif (Total)</h4>
                    <p class="text-4xl font-bold text-blue-600 mb-4">85<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 85%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 2 -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Skor Kualitatif (Media)</h4>
                    <p class="text-4xl font-bold text-green-600 mb-4">92<span class="text-lg text-gray-500">/100</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-600 h-2.5 rounded-full" style="width: 92%"></div>
                    </div>
                </div>

                <!-- Kartu Ringkasan 3 di Beranda - Diperbarui untuk Platform -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Platform Eksternal (SOG)</h4>
                    <p class="text-4xl font-bold text-yellow-500 mb-4">Rp 150.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 75%"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Target: Rp 200.000</p>
                </div>

                <!-- Kartu Ringkasan 4 di Beranda - Diperbarui untuk Offline -->
                <div class="bg-white p-6 rounded-lg shadow-md transition-all hover:shadow-lg">
                    <h4 class="text-lg font-semibold text-gray-600 mb-3">Offline (Rata-rata/Event)</h4>
                    <p class="text-4xl font-bold text-purple-600 mb-4">Rp 12.500.000</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-purple-600 h-2.5 rounded-full" style="width: 78%"></div>
                    </div>
                     <p class="text-sm text-gray-500 mt-2">Target: Rp 15.000.000</p>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kuantitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6" id="kuantitatif-title">Evaluasi Kuantitatif: CRM</h2>
            
            <!-- Memberi ID pada grid dan kolom -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="kuantitatif-grid">
                <!-- Kolom Kiri: KPI & Grafik -->
                <div class="lg:col-span-2 space-y-6" id="kuantitatif-main-col">
                    <!-- Kartu KPI -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Key Performance Indicators (KPI)</h4>
                        <div id="kpi-content" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- KPI data dimuat oleh JS -->
                        </div>
                    </div>
                    
                    <!-- Kartu Grafik Tren -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <h4 class="text-xl font-semibold text-gray-700 mb-4">Grafik Tren (30 Hari Terakhir)</h4>
                         <div class="h-80">
                            <canvas id="trenChart"></canvas>
                         </div>
                    </div>
                </div>

                <!-- Kolom Kanan: Rekomendasi AI -->
                <!-- Memberi ID pada kolom sidebar -->
                <div class="lg:col-span-1" id="kuantitatif-sidebar-col">
                    <div class="bg-white p-6 rounded-lg shadow-md sticky top-24">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Rekomendasi AI</h4>
                        <p class="text-gray-600 text-sm mb-4">
                            Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja terbaru.
                        </p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <!-- SVG Loading Spinner (disembunyikan) -->
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                            <!-- Hasil AI dimuat di sini -->
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-kualitatif">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Evaluasi Kualitatif: Media & Grafis</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Penilaian -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Metrik Evaluasi (Penilaian Tim)</h4>
                    <p class="text-gray-600 text-sm mb-6">Berikan penilaian Anda untuk konten visual terbaru.</p>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Desain Poster Donasi</label>
                        <!-- Sistem Bintang -->
                        <div class="flex items-center space-x-1 text-gray-400">
                            <svg data-rating="1" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="2" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="3" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="4" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <svg data-rating="5" class="star-rating w-8 h-8 cursor-pointer hover:text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="block text-gray-700 font-medium">Video Testimoni</label>
                        <!-- Sistem Jempol -->
                        <div class="flex items-center space-x-4">
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-green-100 text-gray-600 hover:text-green-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 19v-5a2 2 0 012-2h2V6a2 2 0 012-2c.621 0 1.17.253 1.564.672l2.066 2.066A2 2 0 0114 8v2z"></path></svg>
                            </button>
                            <button class="thumb-rating p-3 rounded-lg bg-gray-100 hover:bg-red-100 text-gray-600 hover:text-red-600 transition-all">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.017c.163 0 .326.02.485.06L17 5v5a2 2 0 01-2 2h-2v6a2 2 0 01-2 2c-.621 0-1.17-.253-1.564-.672l-2.066-2.066A2 2 0 0110 16v-2z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4 mt-6">
                        <label for="qual-comment" class="block text-gray-700 font-medium">Komentar & Umpan Balik</label>
                        <textarea id="qual-comment" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Tuliskan umpan balik kualitatif Anda di sini..."></textarea>
                        <button id="submit-qual-feedback" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium">
                            Kirim Umpan Balik
                        </button>
                    </div>
                </div>

                <!-- Kartu Analisis AI -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Analisis Sentimen AI</h4>
                    <p class="text-gray-600 text-sm mb-4">
                        AI menganalisis semua umpan balik kualitatif untuk mengidentifikasi sentimen dan tema utama.
                    </p>
                    <div class="h-64 mb-6">
                        <canvas id="sentimenChart"></canvas>
                    </div>
                    <button id="get-ai-sentiment" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                        <svg id="ai-sentiment-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="ai-sentiment-button-text">Jalankan Analisis Sentimen</span>
                    </button>
                    <div id="ai-sentiment-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4">
                        <p class="text-gray-500 text-center">Hasil analisis AI akan muncul di sini.</p>
                    </div>
                </div>
            </div>

            <!-- Bagian Evaluasi Desain Ahli -->
            <div id="template-evaluasi-desain" class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">Evaluasi Desain Ahli (AI)</h3>
                <p class="text-gray-600 text-sm mb-6">
                    Dapatkan evaluasi mendalam dari AI yang berperan sebagai Direktur Kreatif ahli crowdfunding.
                    Masukkan deskripsi konten (atau link) dan metrik kinerjanya.
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Input -->
                    <div class="space-y-4">
                        <div>
                            <label for="design-desc" class="block text-sm font-medium text-gray-700">Deskripsi Desain / Video / Link</label>
                            <textarea id="design-desc" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'Video testimoni penerima manfaat, fokus pada close-up emosional, backsound sedih, CTA di akhir oleh Buya Yahya...' atau Link ke Konten"></textarea>
                        </div>
                        
                        <!-- Fitur Upload Gambar -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Upload Gambar (Opsional)</label>
                            <input id="image-upload-input" type="file" accept="image/png, image/jpeg, image/webp" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100
                            "/>
                            <div id="image-preview-container" class="mt-2 hidden">
                                <span class="block text-sm font-medium text-gray-700 mb-1">Pratinjau:</span>
                                <img id="image-preview" src="" alt="Pratinjau Gambar" class="max-h-40 rounded-lg border shadow-sm"/>
                                <button id="remove-image-btn" class="mt-1 text-sm text-red-600 hover:underline">Hapus Gambar</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="design-views" class="block text-sm font-medium text-gray-700">Views / Jangkauan</label>
                                <input type="number" id="design-views" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000">
                            </div>
                            <div>
                                <label for="design-engagement" class="block text-sm font-medium text-gray-700">Engagement (Klik/Balas)</label>
                                <input type="number" id="design-engagement" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                            </div>
                            <div>
                                <label for="design-donations" class="block text-sm font-medium text-gray-700">Hasil Donasi (Rp)</label>
                                <input type="number" id="design-donations" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                            </div>
                        </div>
                         <button id="get-ai-design-eval" class="w-full bg-purple-600 text-white px-5 py-3 rounded-lg hover:bg-purple-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-design-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-design-button-text">Dapatkan Evaluasi Desain Ahli</span>
                        </button>
                    </div>
                    
                    <!-- Kolom Hasil -->
                    <div class="border-t md:border-t-0 md:border-l pl-0 md:pl-6 pt-6 md:pt-0">
                         <h4 class="text-lg font-semibold text-gray-700 mb-2">Hasil Evaluasi Ahli</h4>
                        <div id="ai-design-result" class="text-gray-700 space-y-3 text-sm min-h-[150px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI expert akan muncul di sini.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </template>
    
    <template id="template-laporan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Laporan & Analitik</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Kartu Perbandingan Kinerja -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Alat Perbandingan Kinerja</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 1</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Departemen 2</option>
                            <option>CRM</option>
                            <option>Iklan</option>
                            <option>E-channel</option>
                        </select>
                        <select class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>Pilih Periode</option>
                            <option>30 Hari Terakhir</option>
                            <option>Kuartal Ini</option>
                            <option>Tahun Ini</option>
                        </select>
                    </div>
                    <button class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium">
                        Bandingkan
                    </button>
                    <!-- Area Grafik Perbandingan -->
                    <div class="mt-6 h-64 bg-gray-50 flex items-center justify-center rounded-lg">
                        <p class="text-gray-500">Grafik perbandingan akan muncul di sini</p>
                    </div>
                </div>
                
                <!-- Kartu Unduh Laporan -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Laporan yang Dapat Diunduh</h4>
                    <p class="text-gray-600 text-sm mb-6">Hasilkan laporan ringkasan untuk semua evaluasi.</p>
                    <div class="flex space-x-4">
                        <button class="bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh PDF
                        </button>
                        <button class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Unduh Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-pengaturan">
        <div class="animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Pengaturan</h2>
            <!-- Konten diisi dengan form API Key -->
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl">
                <h4 class="text-xl font-semibold text-gray-700 mb-4">Pengaturan API Gemini</h4>
                <p class="text-gray-600 mb-4 text-sm">
                    Masukkan Kunci API Gemini (AI Studio) Anda untuk mengaktifkan semua fitur evaluasi AI.
                    Kunci Anda disimpan dengan aman di penyimpanan lokal browser Anda (`localStorage`) dan tidak dikirim ke server lain.
                </p>
                
                <div>
                    <label for="api-key-input" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Masukkan API Key Anda (dimulai dengan AIzaSy...)">
                </div>
                
                <div class="flex items-center space-x-4 mt-4">
                    <button id="save-api-key" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-all shadow font-medium">
                        Simpan Kunci
                    </button>
                    <button id="delete-api-key" class="bg-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-300 transition-all font-medium">
                        Hapus Kunci
                    </button>
                    <span id="api-key-status" class="text-sm font-medium text-red-500">Kunci API Belum Diatur.</span>
                </div>
            </div>
        </div>
    </template>


    <script type="module">
        // --- KONFIGURASI APLIKASI ---
        const SUPABASE_URL = 'https://xoootcpffgaimzrcwenr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhvb290Y3BmZmdhaW16cmN3ZW5yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1Njk5MDUsImV4cCI6MjA3ODE0NTkwNX0.Vk2vz7sACTWAMizzvByEYIifCNqd8305wGTAA0AvPkY';
        
        // --- INISIALISASI SUPABASE ---
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized.');
            } else {
                console.error('Supabase client library not loaded.');
            }
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        // --- STATE APLIKASI ---
        let currentPage = 'beranda';
        let currentSubPage = 'crm';
        let trenChartInstance = null;
        let sentimenChartInstance = null;
        let uploadedImageBase64 = null; // Untuk menyimpan data gambar

        // --- ELEMEN DOM ---
        const pageContent = document.getElementById('page-content');
        const topNavLinks = document.querySelectorAll('.top-nav-link');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');

        // --- DATA MOCK (CONTOH) ---
        // Ganti ini dengan panggilan fetchSupabaseData()
        const mockData = {
            crm: {
                title: "CRM",
                kpis: [
                    { label: "Permintaan Baru", value: "152" },
                    { label: "Waktu Respons Rata-rata", value: "2.1 jam" },
                    { label: "Tingkat Penyelesaian", value: "89%" },
                    { label: "Kepuasan Pelanggan", value: "4.5/5" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [120, 135, 110, 152]
                }
            },
            iklan: {
                title: "Iklan",
                kpis: [
                    { label: "Tayangan", value: "1,200,000" },
                    { label: "CTR (Click-Through Rate)", value: "5.2%" },
                    { label: "CPA (Cost Per Acquisition)", value: "Rp 15.000" },
                    { label: "ROAS (Return on Ad Spend)", value: "3.5x" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [4.1, 4.8, 5.0, 5.2]
                }
            },
            echannel: {
                title: "E-channel (Perbankan)",
                kpis: [
                    { label: "Volume Donasi", value: "Rp 180.000.000" },
                    { label: "Jumlah Transaksi", value: "1.200" },
                    { label: "Rata-rata Donasi", value: "Rp 150.000" },
                ],
                chart: {
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                    data: [35, 45, 40, 60] // Juta Rp
                }
            },
            // Tambahkan departemen lain di sini (kemitraan, platform, dll.)
            kemitraan: { 
                title: "Kemitraan", 
                kpis: [
                    { label: "Proposal Masuk", value: "40" },
                    { label: "Deal Tercapai", value: "10" },
                    { label: "Nilai Kemitraan", value: "Rp 300Jt" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [5, 8, 12, 10] } 
            },
            platform: { 
                title: "Platform (Eksternal)", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 150Jt" },
                    { label: "Jumlah Donatur", value: "1000" },
                    { label: "SOG", value: "Rp 150.000" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [120, 135, 110, 150] } // Juta Rp
            },
            emoney: { 
                title: "E-money", 
                kpis: [
                    { label: "Volume Transaksi", value: "Rp 500Jt" },
                    { label: "Jumlah Transaksi", value: "5.000" },
                    { label: "Biaya (MDR)", value: "0.7%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [100, 120, 150, 130] } // Juta Rp
            },
            ecommerce: { 
                title: "E-commerce", 
                kpis: [
                    { label: "Penjualan", value: "Rp 80Jt" },
                    { label: "Jumlah Order", value: "800" },
                    { label: "Profit Margin", value: "15%" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [15, 20, 25, 20] } // Juta Rp
            },
            abstore: { 
                title: "AB Store", 
                kpis: [
                    { label: "Penjualan Total", value: "Rp 120Jt" },
                    { label: "Produk Terlaris", value: "Madu" },
                    { label: "Stok Opname", value: "98% Akurat" },
                ], 
                chart: { labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], data: [25, 30, 35, 30] } // Juta Rp
            },
            offline: { 
                title: "Offline Fundrising", 
                kpis: [
                    { label: "Perolehan Total", value: "Rp 250Jt" },
                    { label: "Jumlah Mitra/Event", value: "20" },
                    { label: "Rata-rata Per Mitra", value: "Rp 12.5Jt" },
                ], 
                chart: { 
                    labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'], 
                    data: [50, 75, 60, 65] // (dalam jutaan Rp)
                } 
            },
        };
        
        const mockFeedback = [
            "Desain posternya sangat menyentuh dan jelas!",
            "Videonya bagus, tapi audionya sedikit pecah di awal.",
            "Saya suka palet warnanya, sangat menenangkan.",
            "Font di infografis terlalu kecil, sulit dibaca di HP.",
            "Luar biasa, sangat profesional!"
        ];

        // --- LOGIKA DATABASE (SUPABASE) ---
        
        /**
         * Mengambil data kuantitatif dari Supabase.
         * (Saat ini menggunakan mock data, hapus komentar untuk data live)
         * @param {string} department - Nama tabel/departemen
         */
        async function fetchQuantitativeData(department) {
            console.log(`Fetching data for: ${department}`);
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockData[department] || { title: department, kpis: [], chart: { labels: [], data: [] } };
            }
            
            // Mengembalikan mock data untuk demo
            return new Promise(resolve => 
                setTimeout(() => resolve(mockData[department]), 500)
            );
        }

        /**
         * Mengambil umpan balik kualitatif dari Supabase.
         */
        async function fetchQualitativeFeedback() {
            console.log('Fetching qualitative feedback...');
            if (!supabase) {
                console.warn('Supabase not active. Using mock data.');
                return mockFeedback;
            }
            
            return new Promise(resolve =>
                setTimeout(() => resolve(mockFeedback), 500)
            );
        }
        
        /**
         * Menyimpan umpan balik kualitatif ke Supabase
         */
         async function submitQualitativeFeedback(comment, rating, type) {
            if (!supabase) {
                // Ganti alert dengan UI yang lebih baik
                showToast('Mode Demo: Umpan balik Anda telah dicatat di konsol.');
                console.warn('Supabase not active. Data not saved.', { comment, rating, type });
                return;
            }
            
            console.log('Submitting feedback:', { comment, rating, type });
            
            // ... (Kode Supabase insert)
            // const { data, error } = await supabase
            //   .from('evaluasi_kualitatif_media')
            //   .insert([
            //     { nama_konten: 'Poster A', komentar: comment, rating_bintang: rating, user_id: 'user-123' }
            //   ]);
            // if (error) console.error('Error submitting feedback:', error);
            // else showToast('Umpan balik berhasil dikirim!');
         }

        // --- FUNGSI KALKULASI BARU ---

        /**
         * Menghitung SOG (Spend of Giving)
         */
        function calculateSOG() {
            const perolehan = parseFloat(document.getElementById('crm-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('crm-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('crm-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung ROAS (Return on Ad Spend)
         */
        function calculateROAS() {
            const perolehan = parseFloat(document.getElementById('iklan-perolehan')?.value) || 0;
            const biaya = parseFloat(document.getElementById('iklan-biaya')?.value) || 0;
            const roasResultEl = document.getElementById('iklan-roas-result');
            
            if (roasResultEl) {
                if (biaya > 0) {
                    const roas = perolehan / biaya;
                    roasResultEl.textContent = `${roas.toFixed(2)}x`;
                } else {
                    roasResultEl.textContent = '0.00x';
                }
            }
        }

        /**
         * Menghitung Rata-rata Donasi (E-channel)
         */
        function calculateAvgDonation() {
            const volume = parseFloat(document.getElementById('echannel-volume')?.value) || 0;
            const transaksi = parseFloat(document.getElementById('echannel-transaksi')?.value) || 0;
            const resultEl = document.getElementById('echannel-avg-result');
            
            if (resultEl) {
                if (transaksi > 0) {
                    const rate = volume / transaksi;
                    resultEl.textContent = `Rp ${rate.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung SOG (Spend of Giving) untuk Platform Eksternal
         */
        function calculateSOG_Platform() {
            const perolehan = parseFloat(document.getElementById('platform-perolehan')?.value) || 0;
            const donatur = parseFloat(document.getElementById('platform-donatur')?.value) || 0;
            const sogResultEl = document.getElementById('platform-sog-result');
            
            if (sogResultEl) {
                if (donatur > 0) {
                    const sog = perolehan / donatur;
                    sogResultEl.textContent = `Rp ${sog.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    sogResultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Rata-rata Per Mitra (Offline Fundrising)
         */
        function calculateAvgPerMitra_Offline() {
            const perolehan = parseFloat(document.getElementById('offline-perolehan')?.value) || 0;
            const mitra = parseFloat(document.getElementById('offline-donatur')?.value) || 0;
            const resultEl = document.getElementById('offline-avg-result');
            
            if (resultEl) {
                if (mitra > 0) {
                    const avg = perolehan / mitra;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }

        /**
         * Menghitung Closing Rate (Kemitraan)
         */
        function calculateClosingRate() {
            const deal = parseFloat(document.getElementById('kemitraan-deal')?.value) || 0;
            const proposal = parseFloat(document.getElementById('kemitraan-proposal')?.value) || 0;
            const resultEl = document.getElementById('kemitraan-rate-result');
            
            if (resultEl) {
                if (proposal > 0) {
                    const rate = (deal / proposal) * 100;
                    resultEl.textContent = `${rate.toFixed(2)}%`;
                } else {
                    resultEl.textContent = '0.00%';
                }
            }
        }

        /**
         * Menghitung Rata-rata Transaksi (E-money)
         */
        function calculateAvgTransaction() {
            const volume = parseFloat(document.getElementById('emoney-volume')?.value) || 0;
            const jumlah = parseFloat(document.getElementById('emoney-jumlah')?.value) || 0;
            const resultEl = document.getElementById('emoney-avg-result');
            
            if (resultEl) {
                if (jumlah > 0) {
                    const avg = volume / jumlah;
                    resultEl.textContent = `Rp ${avg.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
                } else {
                    resultEl.textContent = 'Rp 0';
                }
            }
        }
        
        /**
         * Menghitung Profit (E-commerce / AB Store)
         */
        function calculateProfit(prefix) { // prefix = 'ecommerce' or 'abstore'
            const penjualan = parseFloat(document.getElementById(`${prefix}-penjualan`)?.value) || 0;
            const biaya = parseFloat(document.getElementById(`${prefix}-biaya`)?.value) || 0;
            const resultEl = document.getElementById(`${prefix}-profit-result`);
            
            if (resultEl) {
                const profit = penjualan - biaya;
                resultEl.textContent = `Rp ${profit.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            }
        }

        // --- FUNGSI API KEY ---

        /**
         * Menyimpan API Key ke localStorage
         */
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key && key.length > 10) { // Validasi sederhana
                localStorage.setItem('geminiApiKey', key);
                document.getElementById('api-key-status').textContent = 'Kunci API Tersimpan!';
                document.getElementById('api-key-status').className = 'text-sm font-medium text-green-600';
                document.getElementById('api-key-input').value = ''; // Kosongkan demi keamanan
                showToast('Kunci API berhasil disimpan.');
            } else {
                showToast('Kunci API sepertinya tidak valid.', true);
            }
        }

        /**
         * Menghapus API Key dari localStorage
         */
        function deleteApiKey() {
            localStorage.removeItem('geminiApiKey');
            document.getElementById('api-key-status').textContent = 'Kunci API Dihapus.';
            document.getElementById('api-key-status').className = 'text-sm font-medium text-red-600';
            document.getElementById('api-key-input').value = '';
            showToast('Kunci API telah dihapus.');
        }

        /**
         * Memuat status API Key saat halaman Pengaturan dibuka
         */
        function loadApiKeyStatus() {
            const key = localStorage.getItem('geminiApiKey');
            const statusEl = document.getElementById('api-key-status');
            if (key) {
                statusEl.textContent = 'Kunci API Tersimpan.';
                statusEl.className = 'text-sm font-medium text-green-600';
            } else {
                statusEl.textContent = 'Kunci API Belum Diatur.';
                statusEl.className = 'text-sm font-medium text-red-600';
            }
        }

        // --- (BARU) LOGIKA API WILAYAH INDONESIA ---
        const API_WILAYAH_BASE_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api';

        /**
         * (BARU) Fungsi helper untuk mengisi dropdown dari API
         */
        function populateDropdown(selectEl, data, defaultOptionText) {
            // Gunakan 'name' (dari emsifa API) atau 'nama' (fallback)
            const nameKey = (data.length > 0 && data[0].name) ? 'name' : 'nama';
            
            selectEl.innerHTML = `<option value="">${defaultOptionText}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[nameKey];
                selectEl.appendChild(option);
            });
            selectEl.disabled = false;
        }

        /**
         * (BARU) Memuat Provinsi
         */
        async function loadProvinsi() {
            const el = document.getElementById('offline-provinsi');
            if (!el) return;
            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/provinces.json`);
                if (!response.ok) throw new Error('Network response was not ok');
                const provinces = await response.json();
                populateDropdown(el, provinces, 'Pilih Provinsi');
            } catch (e) {
                console.error("Gagal memuat provinsi:", e);
                el.innerHTML = '<option value="">Gagal Memuat Provinsi</option>';
            }
        }

        /**
         * (BARU) Memuat Kabupaten
         */
        async function loadKabupaten(provinceId) {
            const el = document.getElementById('offline-kabupaten');
            const elKec = document.getElementById('offline-kecamatan');
            if (!el || !elKec) return;
            
            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;
            elKec.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
            elKec.disabled = true;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/regencies/${provinceId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const regencies = await response.json();
                populateDropdown(el, regencies, 'Pilih Kabupaten / Kota');
            } catch (e) {
                console.error("Gagal memuat kabupaten:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kabupaten</option>';
            }
        }

        /**
         * (BARU) Memuat Kecamatan
         */
        async function loadKecamatan(regencyId) {
            const el = document.getElementById('offline-kecamatan');
            if (!el) return;

            el.innerHTML = '<option value="">Memuat...</option>';
            el.disabled = false;

            try {
                const response = await fetch(`${API_WILAYAH_BASE_URL}/districts/${regencyId}.json`);
                 if (!response.ok) throw new Error('Network response was not ok');
                const districts = await response.json();
                populateDropdown(el, districts, 'Pilih Kecamatan');
            } catch (e) {
                console.error("Gagal memuat kecamatan:", e);
                el.innerHTML = '<option value="">Gagal Memuat Kecamatan</option>';
            }
        }


        // --- LOGIKA NAVIGASI ---
        
        /**
         * Navigasi ke halaman yang dipilih.
         * @param {string} page - Nama halaman (beranda, kuantitatif, dll.)
         * @param {string} [subpage] - Sub-halaman (crm, iklan, dll.)
         */
        async function navigateTo(page, subpage = null) {
            currentPage = page;
            if (subpage) {
                currentSubPage = subpage;
            }

            console.log(`Navigating to: ${page} ${subpage ? `(${subpage})` : ''}`);

            // Hapus template sebelumnya
            pageContent.innerHTML = '';
            
            // Hapus instance chart sebelumnya
            if (trenChartInstance) trenChartInstance.destroy();
            if (sentimenChartInstance) sentimenChartInstance.destroy();
            
            // Reset state upload gambar
            uploadedImageBase64 = null;

            // Memuat template
            let templateId = `template-${page}`;
            let template = document.getElementById(templateId);
            
            if (template) {
                pageContent.appendChild(template.content.cloneNode(true));
            } else {
                pageContent.innerHTML = `<h2 class="text-2xl">Halaman tidak ditemukan: ${page}</h2>`;
                return;
            }

            // Logika spesifik per halaman
            switch (page) {
                case 'beranda':
                    // (Tidak ada data-fetching khusus di beranda demo ini)
                    break;
                case 'kuantitatif':
                    await loadQuantitativePage(currentSubPage);
                    break;
                case 'kualitatif':
                    loadQualitativePage();
                    break;
                case 'laporan':
                    // (Logika untuk laporan)
                    break;
                case 'pengaturan':
                    // Logika untuk halaman pengaturan
                    loadApiKeyStatus(); // Muat status saat halaman dibuka
                    // Tambahkan listener ke tombol
                    document.getElementById('save-api-key').addEventListener('click', saveApiKey);
                    document.getElementById('delete-api-key').addEventListener('click', deleteApiKey);
                    break;
            }

            updateActiveNav();
        }

        /**
         * Memuat konten untuk halaman kuantitatif.
         * @param {string} department
         */
        async function loadQuantitativePage(department) {
            const data = await fetchQuantitativeData(department);
            
            document.getElementById('kuantitatif-title').textContent = `Evaluasi Kuantitatif: ${data.title}`;
            
            const kpiContainer = document.getElementById('kpi-content');
            const grid = document.getElementById('kuantitatif-grid');
            const mainCol = document.getElementById('kuantitatif-main-col');
            const sidebarCol = document.getElementById('kuantitatif-sidebar-col');
            
            kpiContainer.innerHTML = ''; // Selalu bersihkan
            
            // --- INTI LOGIKA ---
            // Sembunyikan sidebar kanan & lebarkan kolom utama untuk SEMUA form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                if(sidebarCol) sidebarCol.classList.add('hidden');
                if(mainCol) {
                    mainCol.classList.remove('lg:col-span-2');
                    mainCol.classList.add('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-1 gap-4'; // Layout form
            } else {
                // Kembalikan jika ada yg lain
                if(sidebarCol) sidebarCol.classList.remove('hidden');
                if(mainCol) {
                    mainCol.classList.add('lg:col-span-2');
                    mainCol.classList.remove('lg:col-span-3');
                }
                kpiContainer.className = 'grid grid-cols-2 md:grid-cols-3 gap-4'; // Layout grid
            }


            // --- SWITCH UNTUK MEMUAT FORM YANG TEPAT ---
            
            let formHTML = ''; // Variabel untuk menyimpan HTML form
            
            switch(department) {
                case 'crm':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus CRM -->
                        <div id="crm-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-cs-name" class="block text-sm font-medium text-gray-700">Nama CS CRM</label>
                                            <select id="crm-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih CS</option>
                                                <option>Regina</option><option>Siti Qomariah</option><option>Lita</option><option>Neng Nurjamil</option><option>Hilma</option><option>Rika</option><option>Ami</option><option>Silvi</option><option>Dela</option><option>Siti</option><option>Nurya</option><option>Neng Salsa</option><option>Halimah</option><option>Rani</option><option>Reza</option><option>Nandi</option><option>Salsabila</option><option>Rini</option><option>Ita Rohaeti</option><option>Ita Purnamasari</option><option>Anisa</option><option>Naya</option><option>Asti</option><option>Eni</option><option>Ardian</option><option>Tio</option><option>naufal</option><option>rama</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="crm-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="crm-perolehan" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5000000">
                                        </div>
                                        <div>
                                            <label for="crm-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="crm-donatur" class="crm-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="crm-blast" class="block text-sm font-medium text-gray-700">Jumlah Database di-Blast</label>
                                            <input type="number" id="crm-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                        </div>
                                        <div>
                                            <label for="crm-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="crm-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 7000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="crm-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="crm-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Follow up donatur lama, blast WA ke database baru..."></textarea>
                                        </div>
                                        <div>
                                            <label for="crm-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi yang Digunakan</label>
                                            <textarea id="crm-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 'URGENT: Bantu Mereka Sekarang...'"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="crm-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="crm-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="crm-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #crm-export-area -->

                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya CRM) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'iklan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (IKLAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Kolom 1: Input Data -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-perolehan" class="block text-sm font-medium text-gray-700">Perolehan Iklan (Rp)</label>
                                    <input type="number" id="iklan-perolehan" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 15000000">
                                </div>
                                <div>
                                    <label for="iklan-biaya" class="block text-sm font-medium text-gray-700">Biaya Iklan (Rp)</label>
                                    <input type="number" id="iklan-biaya" class="iklan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000000">
                                </div>
                                <div>
                                    <label for="iklan-target" class="block text-sm font-medium text-gray-700">Target ROAS (x)</label>
                                    <input type="number" id="iklan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 4">
                                </div>
                            </div>
                            <!-- Kolom 2: Input Kualitatif -->
                            <div class="space-y-4">
                                <div>
                                    <label for="iklan-strategi" class="block text-sm font-medium text-gray-700">Platform & Strategi Targeting</label>
                                    <textarea id="iklan-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Facebook Ads, Lookalike Audience Donatur 30 hari, Interest Zakat..."></textarea>
                                </div>
                                <div>
                                    <label for="iklan-narasi" class="block text-sm font-medium text-gray-700">Headline & Narasi Iklan (Terbaik)</label>
                                    <textarea id="iklan-narasi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Headline/Narasi dengan performa tertinggi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL ROAS -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi ROAS (Return on Ad Spend)</span>
                            <p id="iklan-roas-result" class="text-3xl font-bold text-blue-600">0.00x</p>
                        </div>
                    `;
                    break;
                
                case 'echannel':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-CHANNEL) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-volume" class="block text-sm font-medium text-gray-700">Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-volume" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                                <div>
                                    <label for="echannel-transaksi" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="echannel-transaksi" class="echannel-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 1000">
                                </div>
                                <div>
                                    <label for="echannel-target" class="block text-sm font-medium text-gray-700">Target Volume Donasi (Rp)</label>
                                    <input type="number" id="echannel-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 200000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="echannel-strategi" class="block text-sm font-medium text-gray-700">Mitra Perbankan & Strategi Promosi</label>
                                    <textarea id="echannel-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Fokus promosi di BSI Mobile, M-Syariah Muamalat. Memperpanjang banner promosi di halaman Donasi BSI..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA DONASI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Donasi per Transaksi</span>
                            <p id="echannel-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'kemitraan':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (KEMITRAAN) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-proposal" class="block text-sm font-medium text-gray-700">Proposal Masuk/Dibuat</label>
                                    <input type="number" id="kemitraan-proposal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 20">
                                </div>
                                <div>
                                    <label for="kemitraan-deal" class="block text-sm font-medium text-gray-700">Deal Tercapai (Disetujui)</label>
                                    <input type="number" id="kemitraan-deal" class="kemitraan-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 5">
                                </div>
                                <div>
                                    <label for="kemitraan-nilai" class="block text-sm font-medium text-gray-700">Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-nilai" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 100000000">
                                </div>
                                <div>
                                    <label for="kemitraan-target" class="block text-sm font-medium text-gray-700">Target Nilai Kemitraan (Rp)</label>
                                    <input type="number" id="kemitraan-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 150000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="kemitraan-strategi" class="block text-sm font-medium text-gray-700">Sektor & Strategi Pendekatan</label>
                                    <textarea id="kemitraan-strategi" rows="7" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Sektor yang ditarget (Korporat, Komunitas, Pemerintah), program yang ditawarkan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL CLOSING RATE -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Closing Rate</span>
                            <p id="kemitraan-rate-result" class="text-3xl font-bold text-blue-600">0.00%</p>
                        </div>
                    `;
                    break;

                case 'platform':
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Platform -->
                        <div id="platform-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Data -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-cs-name" class="block text-sm font-medium text-gray-700">Nama Platform</label>
                                            <select id="platform-cs-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Platform</option>
                                                <option>kitabisa.com</option>
                                                <option>Amalsholeh.com</option>
                                                <option>Sharing Hapiness</option>
                                                <option>Bantu Bersama</option>
                                                <option>Sedekahonline</option>
                                                <option>Sumbangan.com (Malaysia)</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="platform-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="platform-perolehan" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="platform-donatur" class="block text-sm font-medium text-gray-700">Donatur yang Berdonasi</label>
                                            <input type="number" id="platform-donatur" class="platform-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 500">
                                        </div>
                                        <div>
                                            <label for="platform-blast" class="block text-sm font-medium text-gray-700">Jumlah 'Shake' / Up Kategori</label>
                                            <input type="number" id="platform-blast" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 10">
                                        </div>
                                        <div>
                                            <label for="platform-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="platform-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kualitatif -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="platform-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="platform-strategi" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Update campaign, blast ke donatur internal, 'shake' campaign..."></textarea>
                                        </div>
                                        <div>
                                            <label for="platform-narasi" class="block text-sm font-medium text-gray-700">Judul & Narasi Campaign</label>
                                            <textarea id="platform-narasi" rows="6" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Judul campaign dan ringkasan narasi yang digunakan di platform..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL SOG -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Spend of Giving (SOG)</h5>
                                <p id="platform-sog-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="platform-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="platform-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #platform-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Platform) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-platform" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;
                
                case 'emoney':
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (E-MONEY) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-volume" class="block text-sm font-medium text-gray-700">Volume Transaksi (Rp)</label>
                                    <input type="number" id="emoney-volume" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 300000000">
                                </div>
                                <div>
                                    <label for="emoney-jumlah" class="block text-sm font-medium text-gray-700">Jumlah Transaksi</label>
                                    <input type="number" id="emoney-jumlah" class="emoney-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 3000">
                                </div>
                                <div>
                                    <label for="emoney-target" class="block text-sm font-medium text-gray-700">Target Volume (Rp)</label>
                                    <input type="number" id="emoney-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 350000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="emoney-strategi" class="block text-sm font-medium text-gray-700">Platform & Promosi</label>
                                    <textarea id="emoney-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Platform (QRIS, VA, OVO, dll) yang dominan, program promosi yang dijalankan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL RATA-RATA TRANSAKSI -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Rata-rata Transaksi</span>
                            <p id="emoney-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;

                case 'ecommerce':
                case 'abstore':
                    const title = department === 'ecommerce' ? 'E-Commerce' : 'AB Store';
                    const prefix = department; // 'ecommerce' or 'abstore'
                    formHTML = `
                        <!-- BAGIAN 1: INPUT DATA MINGGU INI (${title}) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-penjualan" class="block text-sm font-medium text-gray-700">Total Penjualan (Rp)</label>
                                    <input type="number" id="${prefix}-penjualan" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                </div>
                                <div>
                                    <label for="${prefix}-biaya" class="block text-sm font-medium text-gray-700">Biaya Operasional/HPP (Rp)</label>
                                    <input type="number" id="${prefix}-biaya" class="${prefix}-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 30000000">
                                </div>
                                <div>
                                    <label for="${prefix}-target" class="block text-sm font-medium text-gray-700">Target Profit (Rp)</label>
                                    <input type="number" id="${prefix}-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 25000000">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="${prefix}-strategi" class="block text-sm font-medium text-gray-700">Produk Terlaris & Strategi Promosi</label>
                                    <textarea id="${prefix}-strategi" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Produk yang paling laku, strategi promosi (diskon, bundling, free ongkir)..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- BAGIAN 2: HASIL PROFIT -->
                        <div class="mt-6 pt-4 border-t">
                            <span class="text-sm text-gray-500">Kalkulasi Profit</span>
                            <p id="${prefix}-profit-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                    `;
                    break;
                
                case 'offline':
                    // Formulir Kustom untuk Offline Fundrising
                    formHTML = `
                        <!-- Area Ekspor PDF Khusus Offline -->
                        <div id="offline-export-area">
                            <!-- BAGIAN 1: INPUT DATA MINGGU INI -->
                            <div class="p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1: Kinerja Minggu Ini</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Kolom 1: Input Pilihan -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-aktivitas" class="block text-sm font-medium text-gray-700">Jenis Aktivitas</label>
                                            <select id="offline-aktivitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Aktivitas</option>
                                                <option>Event</option>
                                                <option>Tebar Kencleng</option>
                                                <option>Training Volunteer</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-fundriser" class="block text-sm font-medium text-gray-700">Nama Fundriser</label>
                                            <select id="offline-fundriser" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Semua</option>
                                                <option>Reza</option>
                                                <option>Nandi</option>
                                                <option>Ardian</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="offline-lokasi" class="block text-sm font-medium text-gray-700">Pilihan Lokasi</label>
                                            <select id="offline-lokasi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                <option>Pilih Lokasi</option>
                                                <option>Gerai Retail Besar</option>
                                                <option>Warung/Toko</option>
                                                <option>Perkantoran Modern</option>
                                                <option>Kampus</option>
                                                <option>Sekolah</option>
                                                <option>Masjid/Majelis</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Area Dropdown Lokasi Dinamis -->
                                        <div class="col-span-1 md:col-span-2 mt-4 pt-4 border-t border-gray-200">
                                            <label class="block text-sm font-medium text-gray-700">Area Spesifik (Membutuhkan Internet)</label>
                                            <p class="text-xs text-gray-500 mb-3">Pilih area untuk mendapatkan rekomendasi AI yang lebih spesifik.</p>
                                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                                <div>
                                                    <select id="offline-provinsi" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                                        <option value="">Memuat Provinsi...</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kabupaten" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Provinsi Dahulu</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <select id="offline-kecamatan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" disabled>
                                                        <option value="">Pilih Kabupaten Dahulu</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Kolom 2: Input Kinerja -->
                                    <div class="space-y-4">
                                        <div>
                                            <label for="offline-perolehan" class="block text-sm font-medium text-gray-700">Data Perolehan (Rp)</label>
                                            <input type="number" id="offline-perolehan" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50000000">
                                        </div>
                                        <div>
                                            <label for="offline-donatur" class="block text-sm font-medium text-gray-700">Jumlah Donatur/Toko/Mitra</label>
                                            <input type="number" id="offline-donatur" class="offline-calc-input mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 50">
                                        </div>
                                        <div>
                                            <label for="offline-target" class="block text-sm font-medium text-gray-700">Input Target Minggu Ini (Rp)</label>
                                            <input type="number" id="offline-target" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 70000000">
                                        </div>
                                        <div>
                                            <label for="offline-strategi" class="block text-sm font-medium text-gray-700">Strategi yang Dilakukan</label>
                                            <textarea id="offline-strategi" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: Pitching ke HRD Perusahaan A, kerjasama BEM Kampus B, titip kencleng di 50 warung..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BAGIAN 2: HASIL RATA-RATA -->
                            <div class="mt-6 pt-4 border-t p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-2">Bagian 2: Hasil Rata-rata Per Mitra/Donatur</h5>
                                <p id="offline-avg-result" class="text-3xl font-bold text-blue-600">Rp 0</p>
                            </div>
                            
                            <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                            <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                                <p class="text-gray-600 text-sm mb-4">Evaluasi dari Pakar Strategi Offline Fundraising berdasarkan data yang Anda input.</p>
                                <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-button-text">Dapatkan Evaluasi AI Pakar</span>
                                </button>
                                <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                                </div>
                            </div>
                            
                            <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                            <div class="mt-8 pt-6 border-t border-green-200 p-4">
                                <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                                <div>
                                    <label for="offline-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp)</label>
                                    <input type="number" id="offline-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 80000000">
                                </div>
                                <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                    <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                                </button>
                                <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                                    <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                                </div>
                            </div>
                        </div> <!-- Akhir dari #offline-export-area -->
                        
                        <!-- BAGIAN 5: EKSPOR LAPORAN (Hanya Offline) -->
                        <div class="mt-8 pt-6 border-t border-gray-300 p-4">
                            <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 5: Ekspor Laporan</h5>
                            <button id="export-pdf-button-offline" class="w-full bg-red-500 text-white px-5 py-3 rounded-lg hover:bg-red-600 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                                <svg id="pdf-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <svg class="w-5 h-5 mr-2" id="pdf-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span id="pdf-button-text">Ekspor Laporan ke PDF</span>
                            </button>
                        </div>
                    `;
                    break;

                default:
                    // --- Logika untuk Departemen Lain (YANG BELUM DIKUSTOM) ---
                    // (Saat ini tidak ada, tapi ini sebagai fallback)
                    if (data.kpis.length > 0) {
                        data.kpis.forEach(kpi => {
                            kpiContainer.innerHTML += `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <span class="text-sm text-gray-500">${kpi.label}</span>
                                    <p class="text-2xl font-bold text-gray-800">${kpi.value}</p>
                                </div>
                            `;
                        });
                    } else {
                        kpiContainer.innerHTML = '<p class="text-gray-500 col-span-full">Data KPI tidak tersedia.</p>';
                    }
                    
                    // Tambahkan listener untuk tombol AI (di sidebar)
                    const aiButton = document.getElementById('get-ai-eval');
                    if (aiButton) {
                        const newAiButton = aiButton.cloneNode(true); // Cara mudah hapus listener
                        aiButton.parentNode.replaceChild(newAiButton, aiButton);
                        newAiButton.addEventListener('click', () => handleAIEvaluation(department, data));
                    }
                    break;
            }
            
            // --- Sisipkan Form HTML (jika ada) ---
            // Pengecekan 'crm', 'platform' dan 'offline' dikecualikan dari sisipan form generik
            if (formHTML && !['crm', 'platform', 'offline'].includes(department)) {
                // Ini adalah 'iklan', 'echannel', 'kemitraan', 'emoney', 'ecommerce', 'abstore'
                kpiContainer.innerHTML = `
                    <!-- BAGIAN 1 & 2: INPUT DAN KALKULASI -->
                    <div class="p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 1 & 2: Kinerja Minggu Ini & Kalkulasi</h5>
                        ${formHTML}
                    </div>
                    
                    <!-- BAGIAN 3: EVALUASI AI (Minggu Ini) -->
                    <div class="mt-8 pt-6 border-t border-blue-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 3: Evaluasi AI (Minggu Ini)</h5>
                        <p class="text-gray-600 text-sm mb-4">Dapatkan evaluasi dan saran perbaikan otomatis berdasarkan data kinerja yang baru Anda input.</p>
                        <button id="get-ai-eval" class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="ai-button-text">Dapatkan Evaluasi AI</span>
                        </button>
                        <div id="ai-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Hasil evaluasi AI akan muncul di sini.</p>
                        </div>
                    </div>
                    
                    <!-- BAGIAN 4: PERENCANAAN TARGET MINGGU DEPAN -->
                    <div class="mt-8 pt-6 border-t border-green-200 p-4">
                        <h5 class="text-xl font-semibold text-gray-700 mb-4">Bagian 4: Perencanaan Target Minggu Depan</h5>
                        <div>
                            <label for="${department}-target-depan" class="block text-sm font-medium text-gray-700">Input Target Minggu Depan (Rp atau Angka KPI)</label>
                            <input type="number" id="${department}-target-depan" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="Contoh: 8000000">
                        </div>
                        <button id="get-ai-plan" class="mt-4 w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-all shadow hover:shadow-md font-medium flex items-center justify-center">
                            <svg id="ai-plan-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span id="ai-plan-button-text">Buatkan Rencana Aksi AI</span>
                        </button>
                        <div id="ai-plan-result" class="mt-6 text-gray-700 space-y-3 text-sm border-t pt-4 min-h-[50px]">
                            <p class="text-gray-500 text-center">Rencana aksi untuk target minggu depan akan muncul di sini.</p>
                        </div>
                    </div>
                `;
            } else if (formHTML) {
                // Ini adalah 'crm' atau 'platform' atau 'offline'
                kpiContainer.innerHTML = formHTML;
            }
                
            // --- Tambahkan Event Listener (AI) ---
            const aiEvalBtn = document.getElementById('get-ai-eval');
            if (aiEvalBtn) aiEvalBtn.addEventListener('click', () => handleAIEvaluation(department, data));
            
            const aiPlanBtn = document.getElementById('get-ai-plan');
            if (aiPlanBtn) aiPlanBtn.addEventListener('click', () => handleAIActionPlan(department));
            
            // --- Tambahkan Event Listener (Kalkulasi & PDF) ---
            switch(department) {
                case 'crm':
                    document.querySelectorAll('.crm-calc-input').forEach(input => input.addEventListener('input', calculateSOG));
                    document.getElementById('export-pdf-button').addEventListener('click', () => handleExportPDF('crm'));
                    break;
                case 'iklan':
                    document.querySelectorAll('.iklan-calc-input').forEach(input => input.addEventListener('input', calculateROAS));
                    break;
                case 'echannel':
                    document.querySelectorAll('.echannel-calc-input').forEach(input => input.addEventListener('input', calculateAvgDonation));
                    break;
                case 'kemitraan':
                    document.querySelectorAll('.kemitraan-calc-input').forEach(input => input.addEventListener('input', calculateClosingRate));
                    break;
                case 'platform':
                    document.querySelectorAll('.platform-calc-input').forEach(input => input.addEventListener('input', calculateSOG_Platform));
                    document.getElementById('export-pdf-button-platform').addEventListener('click', () => handleExportPDF('platform'));
                    break;
                case 'emoney':
                    document.querySelectorAll('.emoney-calc-input').forEach(input => input.addEventListener('input', calculateAvgTransaction));
                    break;
                case 'ecommerce':
                    document.querySelectorAll('.ecommerce-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('ecommerce')));
                    break;
                case 'abstore':
                    document.querySelectorAll('.abstore-calc-input').forEach(input => input.addEventListener('input', () => calculateProfit('abstore')));
                    break;
                case 'offline':
                    // Listener untuk form offline baru
                    document.querySelectorAll('.offline-calc-input').forEach(input => input.addEventListener('input', calculateAvgPerMitra_Offline));
                    document.getElementById('export-pdf-button-offline').addEventListener('click', () => handleExportPDF('offline'));

                    // Inisialisasi dan event listener untuk dropdown wilayah
                    loadProvinsi(); // Panggil saat form dimuat
                    
                    document.getElementById('offline-provinsi').addEventListener('change', (e) => {
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        
                        if (e.target.value) {
                            loadKabupaten(e.target.value);
                        } else {
                            // Reset
                            if (kabEl) {
                                kabEl.innerHTML = '<option value="">Pilih Provinsi Dahulu</option>';
                                kabEl.disabled = true;
                            }
                            if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    document.getElementById('offline-kabupaten').addEventListener('change', (e) => {
                         const kecEl = document.getElementById('offline-kecamatan');
                        if (e.target.value) {
                            loadKecamatan(e.target.value);
                        } else {
                            // Reset
                             if (kecEl) {
                                kecEl.innerHTML = '<option value="">Pilih Kabupaten Dahulu</option>';
                                kecEl.disabled = true;
                            }
                        }
                    });

                    break;
            }


            // Render Grafik (Selalu ada di luar switch)
            try {
                const ctx = document.getElementById('trenChart')?.getContext('2d');
                if (ctx) {
                    trenChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.chart.labels,
                            datasets: [{
                                label: `Tren ${data.title}`,
                                data: data.chart.data,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: true,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                        }
                    });
                }
            } catch(e) {
                console.error("Failed to create chart:", e.message);
            }
        }
        
        // Fungsi untuk menangani upload gambar
        function setupImageUploadListeners() {
            const input = document.getElementById('image-upload-input');
            const previewContainer = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            const removeBtn = document.getElementById('remove-image-btn');

            if (!input || !previewContainer || !preview || !removeBtn) return;

            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // 2MB limit
                        showToast('Ukuran file terlalu besar. Maksimal 2MB.', true);
                        input.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Simpan data base64 (tanpa prefix)
                        uploadedImageBase64 = e.target.result.split(',')[1];
                        
                        // Tampilkan preview
                        preview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeBtn.addEventListener('click', () => {
                input.value = ''; // Hapus file dari input
                preview.src = '';
                previewContainer.classList.add('hidden');
                uploadedImageBase64 = null; // Hapus data
            });
        }

        /**
         * Memuat konten untuk halaman kualitatif.
         */
        function loadQualitativePage() {
            // Render Grafik Sentimen
            try {
                const ctx = document.getElementById('sentimenChart').getContext('2d');
                sentimenChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Positif', 'Negatif', 'Netral'],
                        datasets: [{
                            label: 'Sentimen Umpan Balik',
                            data: [70, 10, 20], // Data mock
                            backgroundColor: [
                                'rgb(34, 197, 94)',
                                'rgb(239, 68, 68)',
                                'rgb(209, 213, 219)'
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    }
                });
            } catch(e) {
                console.error("Failed to create sentiment chart:", e.message);
            }
            
            // Event listener untuk bintang
            document.querySelectorAll('.star-rating').forEach(star => {
                star.addEventListener('click', (e) => {
                    const rating = e.currentTarget.dataset.rating;
                    const stars = e.currentTarget.parentElement.querySelectorAll('.star-rating');
                    stars.forEach(s => {
                        if(s.dataset.rating <= rating) {
                            s.classList.add('text-yellow-400');
                            s.classList.remove('text-gray-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-400');
                        }
                    });
                    console.log(`Rating diberikan: ${rating}`);
                });
            });
            
            // Event listener tombol jempol
             document.querySelectorAll('.thumb-rating').forEach(thumb => {
                thumb.addEventListener('click', (e) => {
                    // Logika untuk highlight jempol
                    e.currentTarget.classList.toggle('bg-blue-200');
                });
            });

            // Event listener tombol kirim
            document.getElementById('submit-qual-feedback').addEventListener('click', () => {
                const comment = document.getElementById('qual-comment').value;
                // Logika untuk mengambil rating (bintang/jempol)
                const rating = 5; // Placeholder
                submitQualitativeFeedback(comment, rating, 'comment');
                document.getElementById('qual-comment').value = '';
            });
            
            // Event listener tombol AI Sentimen
            document.getElementById('get-ai-sentiment').addEventListener('click', handleAISentiment);

            // Event listener untuk Tombol Evaluasi Desain AI
            const designEvalButton = document.getElementById('get-ai-design-eval');
            if (designEvalButton) {
                designEvalButton.addEventListener('click', handleAIDesignEvaluation);
            }
            
            // Event listener untuk upload gambar
            setupImageUploadListeners();
        }

        /**
         * Memperbarui status aktif pada link navigasi.
         */
        function updateActiveNav() {
            // Navigasi Atas
            topNavLinks.forEach(link => {
                if (link.dataset.page === currentPage) {
                    link.classList.add('active-nav', 'font-bold', 'text-blue-600');
                } else {
                    link.classList.remove('active-nav', 'font-bold', 'text-blue-600');
                }
            });

            // Sidebar
            sidebarLinks.forEach(link => {
                const isPageMatch = link.dataset.page === currentPage;
                const isSubPageMatch = link.dataset.subpage === currentSubPage;

                if (isPageMatch && (link.dataset.subpage ? isSubPageMatch : true)) {
                    link.classList.add('active-sidebar', 'bg-blue-600', 'text-white');
                } else {
                    link.classList.remove('active-sidebar', 'bg-blue-600', 'text-white');
                }
            });
        }
        
        // --- LOGIKA EVALUASI AI (GEMINI) ---
        
        /**
         * Fungsi wrapper untuk menangani retry dengan exponential backoff.
         */
        async function exponentialBackoff(fetchCall, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetchCall();
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429) { // Too Many Requests
                        console.warn(`Retry ${i+1}/${maxRetries} after ${delay}ms`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        console.error(`Fetch error: ${response.status}`, await response.json());
                        return null; // Gagal
                    }
                } catch (error) {
                    console.error('Fetch exception:', error);
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            console.error('Max retries reached. AI call failed.');
            return null;
        }

        /**
         * Memanggil Gemini API dengan payload kustom (bisa text+gambar).
         * @param {object} payload
         */
        async function callGeminiPayload(payload) {
            // Kunci API diambil dari localStorage
            const userApiKey = localStorage.getItem('geminiApiKey');

            if (!userApiKey) { // Cek apakah kunci ada
                console.error("GEMINI_API_KEY is not set in localStorage.");
                showToast("Kunci API Gemini belum diatur. Silakan ke menu Pengaturan.", true);
                return "Gagal: Kunci API Gemini belum diatur di menu Pengaturan.";
            }
            
            // URL API dibuat secara dinamis dengan kunci
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`;

            const result = await exponentialBackoff(() => 
                fetch(GEMINI_API_URL, { // Menggunakan URL dinamis
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
            );

            if (result && result.candidates && result.candidates[0].content.parts[0].text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error('Invalid AI response structure:', result);
                return "Gagal mendapatkan respons dari AI. Coba lagi nanti.";
            }
        }
        
        /**
         * Memanggil Gemini API hanya dengan text prompt.
         * @param {string} prompt
         */
        async function callGemini(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            return callGeminiPayload(payload); // Menggunakan handler payload
        }

        /**
         * Mengambil data formulir dari departemen yang aktif
         * @param {string} department
         * @returns {object} Objek berisi data formulir
         */
        function getFormData(department) {
            const data = { department: department };
            try {
                switch(department) {
                    case 'crm':
                        data.csName = document.getElementById('crm-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('crm-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('crm-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('crm-donatur')?.value || '0';
                        data.sog = document.getElementById('crm-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('crm-blast')?.value || '0';
                        data.strategi = document.getElementById('crm-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('crm-narasi')?.value || 'N/A';
                        break;
                    case 'iklan':
                        data.perolehan = `Rp ${parseFloat(document.getElementById('iklan-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById('iklan-biaya')?.value || '0').toLocaleString('id-ID')}`;
                        data.roas = document.getElementById('iklan-roas-result')?.textContent || '0.00x';
                        data.targetROAS = document.getElementById('iklan-target')?.value || 'N/A';
                        data.strategi = document.getElementById('iklan-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('iklan-narasi')?.value || 'N/A';
                        break;
                    case 'echannel':
                        data.volume = `Rp ${parseFloat(document.getElementById('echannel-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.transaksi = document.getElementById('echannel-transaksi')?.value || '0';
                        data.avgDonasi = document.getElementById('echannel-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('echannel-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('echannel-strategi')?.value || 'N/A';
                        break;
                    case 'kemitraan':
                        data.proposalMasuk = document.getElementById('kemitraan-proposal')?.value || '0';
                        data.deal = document.getElementById('kemitraan-deal')?.value || '0';
                        data.closingRate = document.getElementById('kemitraan-rate-result')?.textContent || '0.00%';
                        data.nilai = `Rp ${parseFloat(document.getElementById('kemitraan-nilai')?.value || '0').toLocaleString('id-ID')}`;
                        data.targetNilai = `Rp ${parseFloat(document.getElementById('kemitraan-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('kemitraan-strategi')?.value || 'N/A';
                        break;
                    case 'platform':
                        data.platformName = document.getElementById('platform-cs-name')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('platform-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('platform-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahDonatur = document.getElementById('platform-donatur')?.value || '0';
                        data.sog = document.getElementById('platform-sog-result')?.textContent || 'Rp 0';
                        data.jumlahBlast = document.getElementById('platform-blast')?.value || 'N/A';
                        data.strategi = document.getElementById('platform-strategi')?.value || 'N/A';
                        data.narasi = document.getElementById('platform-narasi')?.value || 'N/A';
                        break;
                    case 'emoney':
                        data.volume = `Rp ${parseFloat(document.getElementById('emoney-volume')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahTransaksi = document.getElementById('emoney-jumlah')?.value || '0';
                        data.avgTransaksi = document.getElementById('emoney-avg-result')?.textContent || 'Rp 0';
                        data.targetVolume = `Rp ${parseFloat(document.getElementById('emoney-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById('emoney-strategi')?.value || 'N/A';
                        break;
                    case 'ecommerce':
                    case 'abstore':
                        const prefix = department;
                        data.penjualan = `Rp ${parseFloat(document.getElementById(`${prefix}-penjualan`)?.value || '0').toLocaleString('id-ID')}`;
                        data.biaya = `Rp ${parseFloat(document.getElementById(`${prefix}-biaya`)?.value || '0').toLocaleString('id-ID')}`;
                        data.profit = document.getElementById(`${prefix}-profit-result`)?.textContent || 'Rp 0';
                        data.targetProfit = `Rp ${parseFloat(document.getElementById(`${prefix}-target`)?.value || '0').toLocaleString('id-ID')}`;
                        data.strategi = document.getElementById(`${prefix}-strategi`)?.value || 'N/A';
                        break;
                    case 'offline':
                        // Get data dari form offline baru
                        data.aktivitas = document.getElementById('offline-aktivitas')?.value || 'N/A';
                        data.fundriser = document.getElementById('offline-fundriser')?.value || 'N/A';
                        data.lokasi = document.getElementById('offline-lokasi')?.value || 'N/A';
                        data.perolehan = `Rp ${parseFloat(document.getElementById('offline-perolehan')?.value || '0').toLocaleString('id-ID')}`;
                        data.target = `Rp ${parseFloat(document.getElementById('offline-target')?.value || '0').toLocaleString('id-ID')}`;
                        data.jumlahMitra = document.getElementById('offline-donatur')?.value || '0';
                        data.rataRata = document.getElementById('offline-avg-result')?.textContent || 'Rp 0';
                        data.strategi = document.getElementById('offline-strategi')?.value || 'N/A';
                        
                        // Tambahan data lokasi
                        const provEl = document.getElementById('offline-provinsi');
                        const kabEl = document.getElementById('offline-kabupaten');
                        const kecEl = document.getElementById('offline-kecamatan');
                        data.provinsi = provEl?.value ? provEl.options[provEl.selectedIndex].text : 'N/A';
                        data.kabupaten = kabEl?.value ? kabEl.options[kabEl.selectedIndex].text : 'N/A';
                        data.kecamatan = kecEl?.value ? kecEl.options[kecEl.selectedIndex].text : 'N/A';
                        break;
                }
            } catch (e) {
                console.error("Gagal mengambil data form:", e);
            }
            return data;
        }

        /**
         * Membuat prompt AI untuk Evaluasi Minggu Ini
         * @param {object} formData
         * @returns {string} Prompt untuk AI
         */
        function createEvaluationPrompt(formData) {
            let prompt = `Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ). Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "${formData.department}".\n\nData Kinerja Mingguan (JSON):\n${JSON.stringify(formData)}\n\n`;
            prompt += "Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):\n";
            prompt += "1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data yang ada (perolehan vs target, KPI utama, dan rasio kalkulasi).\n";
            prompt += "2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan dapat ditindaklanjuti untuk membantu meningkatkan kinerja. Fokus pada strategi, narasi, dan data.\n";
            
            // Tambahan prompt spesifik
            switch(formData.department) {
                case 'crm':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan CS.\n";
                    break;
                case 'iklan':
                    prompt += "3.  **Evaluasi ROAS & Narasi:** Analisis apakah ROAS sudah baik dan beri masukan tentang narasi/strategi targeting.\n";
                    break;
                case 'echannel':
                    prompt += "3.  **Evaluasi Mitra Bank:** Beri masukan tentang performa di mitra perbankan (BSI, Muamalat, dll) dan efektivitas promosi/visibilitas di channel tersebut.\n";
                    break;
                case 'platform':
                    prompt += "3.  **Evaluasi Narasi/Strategi:** Berikan masukan singkat (1-2 kalimat) tentang potensi strategi/narasi yang digunakan di platform eksternal.\n";
                    break;
                case 'offline':
                    // Prompt evaluasi untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah mengevaluasi data kinerja mingguan untuk departemen "Offline Fundrising".

                        Data Kinerja Mingguan (JSON):
                        ${JSON.stringify(formData)}

                        Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                        1.  **Analisis Performa:** Evaluasi singkat performa berdasarkan data (Perolehan vs Target, Rata-rata per Mitra/Toko, efektivitas Aktivitas & Lokasi).
                        2.  **Rekomendasi Strategi (3 Poin):** Tiga poin saran yang spesifik dan profesional untuk meningkatkan kinerja offline (cara pitching, pemilihan lokasi, manajemen volunteer/kencleng).
                        3.  **Rekomendasi Prospek (Poin Wajib):** Berdasarkan 'Jenis Aktivitas' (${formData.aktivitas}), 'Pilihan Lokasi' (${formData.lokasi}), dan Area Spesifik (${formData.kecamatan}, ${formData.kabupaten}), berikan 3-5 contoh NAMA SPESIFIK (nama toko, nama perusahaan, nama kampus, atau area majelis) di wilayah **Kecamatan ${formData.kecamatan}** yang harus diprospek. **Gunakan data publik atau Google Maps untuk menemukan nama-nama ini.**
                        
                        Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }
            
            prompt += "\nFormat output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).";
            return prompt;
        }

        /**
         * Menangani klik tombol evaluasi AI kuantitatif (DIPERBARUI)
         */
        async function handleAIEvaluation(department, mockKPIData) {
            console.log(`Getting AI eval for ${department}`);
            
            const button = document.getElementById('get-ai-eval');
            const spinner = document.getElementById('ai-loading-spinner');
            const buttonText = document.getElementById('ai-button-text');
            const resultContainer = document.getElementById('ai-result');

            if (!button || !spinner || !buttonText || !resultContainer) {
                console.error("Elemen UI AI tidak ditemukan.");
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang memproses data...</p>';

            let prompt = '';

            // Cek apakah ini departemen dengan form kustom
            if (['crm', 'iklan', 'echannel', 'kemitraan', 'platform', 'emoney', 'ecommerce', 'abstore', 'offline'].includes(department)) {
                const formData = getFormData(department);
                prompt = createEvaluationPrompt(formData);
            } else {
                // Ini adalah departemen generik (fallback, saat ini tidak ada)
                const dataString = JSON.stringify(mockKPIData);
                prompt = `
                    Anda adalah seorang analis kinerja ahli untuk lembaga filantropi (LAZ).
                    Tugas Anda adalah mengevaluasi data kinerja departemen "${department}".
                    
                    Data Kinerja (JSON):
                    ${dataString}

                    Berikan evaluasi Anda dalam format berikut (gunakan Bahasa Indonesia):
                    1.  **Ringkasan Kinerja:** Satu paragraf singkat (2-3 kalimat) yang merangkum kinerja departemen ini.
                    2.  **Saran Perbaikan (3 Poin):** Tiga poin saran yang spesifik, dapat ditindaklanjuti, dan relevan dengan data untuk meningkatkan kinerja.
                    3.  **Prediksi Tren:** Satu kalimat prediksi tren berdasarkan data yang ada jika tidak ada perubahan.
                    
                    Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
                `;
            }

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Dapatkan Evaluasi AI';
        }

        /**
         * Membuat prompt AI untuk Rencana Aksi Minggu Depan
         * @param {string} department
         * @param {object} formData
         * @param {string} targetDepan
         * @returns {string} Prompt untuk AI
         */
        function createActionPlanPrompt(department, formData, targetDepan) {
            let prompt = `
                Anda adalah seorang konsultan strategi marketing filantropi (fundraising) kelas dunia. Anda memiliki pemahaman mendalam tentang lanskap filantropi digital di Indonesia dan juga memahami persona dakwah Buya Yahya dan lembaga LAZ Albahjah.

                Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "${department}" guna mencapai target minggu depan.

                Data Kontekstual Minggu Ini:
                ${JSON.stringify(formData)}
                
                Target Minggu Depan: ${targetDepan}

                Instruksi Wajib (gunakan Bahasa Indonesia):
                1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                2.  **Marketing Filantropi Terkini:** Gabungkan teknik marketing filantropi digital terkini (personalisasi, social proof, story-telling, 'urgency' etis).
                3.  **Kekuatan Albahjah & Buya Yahya:** Ini SANGAT PENTING. Kaitkan strategi ini dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, tausiyah relevan, transparansi).
            `;

            // Tambahan prompt spesifik
            switch(department) {
                case 'crm':
                    prompt += "\n4.  **Spesifik CRM:** Fokus pada segmentasi database donatur (loyal, 'tidur') dan A/B testing narasi personal.\n";
                    break;
                case 'iklan':
                    prompt += "\n4.  **Spesifik Iklan:** Fokus pada rekomendasi audiens (LAL, Custom) dan angle 'creative' (visual/headline) baru yang mengaitkan Buya Yahya.\n";
                    break;
                case 'echannel':
                    prompt += "\n4.  **Spesifik E-channel:** Fokus pada 1-2 program promosi baru bersama mitra perbankan (misal: BSI, Muamalat) atau optimalisasi *placement* donasi di dalam aplikasi mereka.\n";
                    break;
                case 'kemitraan':
                    prompt += "\n4.  **Spesifik Kemitraan:** Fokus pada 2-3 sektor industri baru yang potensial (misal: Halal Tech, Travel) dan cara 'pitching' yang unik.\n";
                    break;
                case 'platform':
                    prompt += "\n4.  **Spesifik Platform Eksternal:** Fokus pada 1-2 ide *campaign* baru atau optimalisasi narasi/visual yang cocok untuk audiens spesifik di platform eksternal (spt. Kitabisa, Amalsholeh).\n";
                    break;
                case 'emoney':
                    prompt += "\n4.  **Spesifik E-money:** Fokus pada 1-2 program promosi bersama mitra e-wallet (cashback, poin) untuk event tertentu (misal: Jumat Berkah).\n";
                    break;
                case 'ecommerce':
                case 'abstore':
                    prompt += "\n4.  **Spesifik E-commerce:** Fokus pada strategi 'bundling' produk atau 'up-selling' produk terlaris.\n";
                    break;
                case 'offline':
                    // Prompt Rencana Aksi disesuaikan untuk Offline
                    prompt = `
                        Anda adalah seorang pakar strategi offline fundraising profesional ternama dengan pengalaman lebih dari 10 tahun dan predikat sangat memuaskan.
                        Tugas Anda adalah membuatkan Rencana Aksi (Action Plan) yang konkret untuk departemen "Offline Fundrising" guna mencapai target minggu depan.

                        Data Kontekstual Minggu Ini:
                        ${JSON.stringify(formData)}
                        
                        Target Minggu Depan: ${targetDepan}

                        Instruksi Wajib (gunakan Bahasa Indonesia):
                        1.  **Fokus Target:** Rencana aksi harus fokus untuk mencapai "Target Minggu Depan".
                        2.  **Kekuatan Albahjah & Buya Yahya:** Kaitkan strategi dengan keunikan LAZ Albahjah dan figur Buya Yahya (kepercayaan jemaah, materi tausiyah untuk 'pitching').
                        3.  **Spesifik Offline:** Fokus pada 2-3 strategi baru untuk 'scaling up' (memperbanyak) tebar kencleng/event, dan strategi 'door-to-door' atau 'pitching' yang efektif untuk lokasi yang dipilih. Berikan contoh skrip 'pitching' singkat.
                        
                        Format output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.
                    `;
                    // Hentikan eksekusi di sini agar tidak tertimpa prompt default
                    return prompt;
            }

            prompt += "\nFormat output harus berupa HTML (gunakan <strong>, <ul>, <li>) dengan judul 'Rekomendasi Rencana Aksi'.";
            return prompt;
        }

        /**
         * Menangani klik tombol rencana aksi AI (DIPERBARUI)
         */
        async function handleAIActionPlan(department) {
            console.log(`Getting AI Action Plan for ${department}`);
            
            const button = document.getElementById('get-ai-plan');
            const spinner = document.getElementById('ai-plan-loading');
            const buttonText = document.getElementById('ai-plan-button-text');
            const resultContainer = document.getElementById('ai-plan-result');
            // Mengambil target-depan berdasarkan ID unik departemen
            const targetDepanEl = document.getElementById(`${department}-target-depan`);

            if (!button || !spinner || !buttonText || !resultContainer || !targetDepanEl) {
                console.error("Elemen UI AI Plan tidak ditemukan.");
                return;
            }

            const targetDepan = targetDepanEl.value;
            if (!targetDepan || targetDepan === '0') {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan Target Minggu Depan terlebih dahulu.</p>';
                return;
            }

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menyusun rencana aksi...</p>';

            const formData = getFormData(department);
            const prompt = createActionPlanPrompt(department, formData, targetDepan);

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Buatkan Rencana Aksi AI';
        }

        /**
         * Menangani klik tombol analisis sentimen AI.
         */
        async function handleAISentiment() {
            console.log('Getting AI sentiment analysis...');
            
            const button = document.getElementById('get-ai-sentiment');
            const spinner = document.getElementById('ai-sentiment-loading');
            const buttonText = document.getElementById('ai-sentiment-button-text');
            const resultContainer = document.getElementById('ai-sentiment-result');

            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI sedang menganalisis umpan balik...</p>';

            const feedbackList = await fetchQualitativeFeedback();
            const dataString = JSON.stringify(feedbackList);

            const prompt = `
                Anda adalah seorang analis sentimen ahli.
                Berikut adalah daftar umpan balik (review) kualitatif untuk desain media dan grafis:
                ${dataString}

                Tugas Anda (gunakan Bahasa Indonesia):
                1.  **Analisis Sentimen:** Berikan ringkasan sentimen keseluruhan (Positif, Negatif, atau Campuran).
                2.  **Tema Utama yang Diidentifikasi:** Identifikasi 3 tema atau topik utama yang paling sering muncul dari umpan balik tersebut (misal: 'Kualitas Audio', 'Desain Visual', 'Kejelasan Font').
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;

            const aiResponse = await callGemini(prompt);

            resultContainer.innerHTML = aiResponse;
            button.disabled = false;
            spinner.classList.add('hidden');
            buttonText.textContent = 'Jalankan Analisis Sentimen';
        }
        
        /**
         * (FUNGSI BARU)
         * Menangani klik tombol evaluasi Desain/Video oleh AI Expert
         */
        async function handleAIDesignEvaluation() {
            console.log('Getting AI Design evaluation...');
            
            const button = document.getElementById('get-ai-design-eval');
            const spinner = document.getElementById('ai-design-loading');
            const buttonText = document.getElementById('ai-design-button-text');
            const resultContainer = document.getElementById('ai-design-result');

            // Ambil Data Input
            const deskripsi = document.getElementById('design-desc').value;
            const views = document.getElementById('design-views').value || '0';
            const engagement = document.getElementById('design-engagement').value || '0';
            const donasi = document.getElementById('design-donations').value || '0';

            if (!deskripsi && !uploadedImageBase64) {
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Harap masukkan deskripsi atau upload gambar terlebih dahulu.</p>';
                return;
            }

            // Set Loading
            button.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Menganalisis Desain...';
            resultContainer.innerHTML = '<p class="text-gray-500 text-center">AI Expert sedang menganalisis konten Anda...</p>';

            // Buat Prompt Khusus
            let textPrompt = `
                Anda adalah seorang Direktur Kreatif dan Desainer Visual ternama dengan pengalaman lebih dari 10 tahun, spesialisasi Anda adalah "crowdfunding" dan "fundraising filantropi" dengan predikat sangat memuaskan. Anda sangat ahli menangani konten untuk WhatsApp (WA) dan media sosial.

                Tugas Anda adalah memberikan evaluasi mendalam atas desain/video berikut, yang digunakan untuk penggalangan dana.

                Data Konten:
                - Deskripsi Teks: ${deskripsi || '(Tidak ada deskripsi, fokus pada gambar terlampir)'}
                - Performa (data aktual):
                    - Views/Jangkauan: ${views}
                    - Engagement (Klik/Balasan): ${engagement}
                    - Hasil Donasi: Rp ${donasi}

                Instruksi (Wajib Gunakan Bahasa Indonesia):
                Berikan evaluasi Anda sebagai seorang ahli.
                1.  **Evaluasi Visual/Narasi (Berdasarkan Teks/Gambar):** Analisis kekuatan dan kelemahan dari konten. Apa yang berhasil? Apa yang kurang dari kacamata desainer crowdfunding?
                2.  **Koneksi ke Performa:** Hubungkan evaluasi Anda dengan data performa. Mengapa views/engagement/donasi bisa seperti itu? Apakah desainnya sudah optimal untuk konversi donasi?
                3.  **Rekomendasi Aksi (Poin Paling Penting):** Berikan 3-5 poin rekomendasi yang sangat spesifik dan profesional (untuk WA atau Medsos) untuk meningkatkan konversi donasi pada desain/video ini di masa depan.
                
                Format output harus berupa HTML sederhana (gunakan <strong>, <ul>, <li>).
            `;
            
            // Bangun payload dengan atau tanpa gambar
            const parts = [{ text: textPrompt }];
            
            if (uploadedImageBase64) {
                parts.push({
                    inlineData: {
                        mimeType: "image/jpeg", // Asumsi jpeg, bisa juga dideteksi dari file input
                        data: uploadedImageBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
            };
            
            // Panggil AI
            try {
                const aiResponse = await callGeminiPayload(payload);
                resultContainer.innerHTML = aiResponse;
            } catch (error) {
                console.error('Error in AI Design Eval:', error);
                resultContainer.innerHTML = '<p class="text-red-500 text-center">Gagal mendapatkan evaluasi AI.</p>';
            } finally {
                // Reset button
                button.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = 'Dapatkan Evaluasi Desain Ahli';
            }
        }
        
        // --- LOGIKA EKSPOR PDF ---
        
        // Fungsi dibuat generik untuk menerima konteks (crm, platform, offline)
        async function handleExportPDF(context = 'crm') {
            console.log(`Exporting PDF for ${context}...`);
            
            // Logika diperbarui untuk menangani 'crm', 'platform', 'offline'
            let buttonId;
            if (context === 'crm') {
                buttonId = 'export-pdf-button';
            } else {
                buttonId = `export-pdf-button-${context}`; // 'export-pdf-button-platform', 'export-pdf-button-offline'
            }
            
            const button = document.getElementById(buttonId);
            
            // Periksa apakah elemen tombol ditemukan
            if (!button) {
                console.error(`Tombol ekspor '${buttonId}' tidak ditemukan!`);
                showToast('Tombol ekspor tidak ditemukan.', true);
                return;
            }

            const spinner = button.querySelector('svg:first-child'); // Asumsi spinner adalah svg pertama
            const icon = button.querySelector('svg:nth-child(2)'); // Asumsi icon adalah svg kedua
            const buttonText = button.querySelector('span');
            
            const exportArea = document.getElementById(`${context}-export-area`);
            
            // Dapatkan nama (CS atau Platform atau Aktivitas)
            // Logika pengambilan nama diperbarui
            let name = `${context}_Report`; // Default
            if (context === 'crm') {
                const nameEl = document.getElementById('crm-cs-name');
                if (nameEl) name = nameEl.value;
            } else if (context === 'platform') {
                const nameEl = document.getElementById('platform-cs-name'); // ID-nya masih -cs-name
                if (nameEl) name = nameEl.value;
            } else if (context === 'offline') {
                const nameEl = document.getElementById('offline-aktivitas'); // Kita gunakan nama aktivitas
                if (nameEl) name = nameEl.value;
            }
            
            // Dapatkan tanggal hari ini format YYYY-MM-DD
            const today = new Date().toISOString().split('T')[0];
            const filename = `Evaluasi_${context.toUpperCase()}_${name}_${today}.pdf`;

            if (!exportArea) {
                console.error(`Area ekspor '${context}-export-area' tidak ditemukan!`);
                showToast('Gagal mengekspor: Area tidak ditemukan.', true);
                return;
            }
            
            // Tampilkan loading
            if (button) button.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (icon) icon.classList.add('hidden');
            if (buttonText) buttonText.textContent = 'Mengekspor PDF...';
            
            try {
                const opt = {
                    margin:       [0.5, 0.5, 0.5, 0.5], // dalam inci
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                // Panggil html2pdf
                await html2pdf().from(exportArea).set(opt).save();
                
                showToast('PDF berhasil diekspor!');

            } catch (e) {
                console.error('Gagal mengekspor PDF:', e);
                showToast('Gagal mengekspor PDF.', true);
            } finally {
                 // Reset tombol
                if (button) button.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (icon) icon.classList.remove('hidden');
                if (buttonText) buttonText.textContent = 'Ekspor Laporan ke PDF';
            }
        }
        
        // --- Utility ---
        function showToast(message, isError = false) {
            // (Fitur toast sederhana bisa ditambahkan di sini)
            // console.log(`TOAST: ${message}`);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-gray-800'} transition-all duration-300 ease-out z-50`;
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
            document.body.appendChild(toast);
            
            // Animasikan
            setTimeout(() => {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateY(20px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // --- EVENT LISTENERS GLOBAL ---
        
        /**
         * Listener utama untuk menangani semua klik navigasi.
         */
        document.addEventListener('click', (e) => {
            const topNavLink = e.target.closest('.top-nav-link');
            const sidebarLink = e.target.closest('.sidebar-link');

            if (topNavLink) {
                e.preventDefault();
                navigateTo(topNavLink.dataset.page);
            } else if (sidebarLink) {
                e.preventDefault();
                navigateTo(sidebarLink.dataset.page, sidebarLink.dataset.subpage);
            }
        });
        
        // --- INISIALISASI APLIKASI ---
        document.addEventListener('DOMContentLoaded', () => {
            // Muat halaman awal berdasarkan hash URL, atau default ke beranda
            const hash = window.location.hash.substring(1);
            let page = 'beranda';
            let subpage = null;
            
            if (hash.startsWith('kuantitatif')) {
                page = 'kuantitatif';
                // Cek subpage, misal: #kuantitatif-crm
                const parts = hash.split('-');
                if (parts.length > 1) {
                    subpage = parts[1];
                } else {
                    subpage = 'crm'; // Default jika hanya #kuantitatif
                }
            } else if (hash) {
                page = hash;
            }
            
            navigateTo(page, subpage);
        });

    </script>
    
    <!-- CSS untuk Navigasi dan Animasi -->
    <style>
        .top-nav-link {
            @apply px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-all;
        }
        .top-nav-link.active-nav {
            @apply font-semibold text-blue-600 bg-blue-50;
        }
        .sidebar-link {
            @apply flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 group-hover:text-gray-900 transition-all;
        }
        .sidebar-link.active-sidebar {
            @apply bg-blue-600 text-white font-medium shadow-md;
        }
        .sidebar-link.active-sidebar svg {
            @apply text-white;
        }
        .sidebar-link svg {
             @apply text-gray-500 group-hover:text-gray-800 transition-all;
        }

        /* Animasi Fade-in Sederhana */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>

</body>
</html>
